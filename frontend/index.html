<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroTouch Mail AI System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Unlayer Email Editor -->
    <script src="https://editor.unlayer.com/embed.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        /* Dark mode transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Quill Editor Dark Mode Styles */
        .dark .ql-toolbar {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
        }
        .dark .ql-toolbar .ql-stroke {
            stroke: #e5e7eb !important;
        }
        .dark .ql-toolbar .ql-fill {
            fill: #e5e7eb !important;
        }
        .dark .ql-toolbar .ql-picker-label {
            color: #e5e7eb !important;
        }
        .dark .ql-toolbar button:hover,
        .dark .ql-toolbar button:focus,
        .dark .ql-toolbar button.ql-active {
            background-color: #4b5563 !important;
        }
        .dark .ql-toolbar .ql-picker-options {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
        }
        .dark .ql-toolbar .ql-picker-item {
            color: #e5e7eb !important;
        }
        .dark .ql-toolbar .ql-picker-item:hover {
            background-color: #4b5563 !important;
        }
        .dark .ql-container {
            background-color: #1f2937 !important;
            border-color: #4b5563 !important;
        }
        .dark .ql-editor {
            color: #f3f4f6 !important;
        }
        .dark .ql-editor.ql-blank::before {
            color: #9ca3af !important;
        }
        .dark .ql-editor ::selection {
            background-color: #3b82f6 !important;
            color: #ffffff !important;
        }
        .dark .ql-editor h1,
        .dark .ql-editor h2,
        .dark .ql-editor h3 {
            color: #f3f4f6 !important;
        }
        .dark .ql-editor a {
            color: #60a5fa !important;
        }
        .dark .ql-snow .ql-tooltip {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #f3f4f6 !important;
        }
        .dark .ql-snow .ql-tooltip input[type=text] {
            background-color: #1f2937 !important;
            border-color: #4b5563 !important;
            color: #f3f4f6 !important;
        }
        /* Email content preview dark mode - override any inline black text */
        .dark .email-content-preview,
        .dark .email-content-preview p,
        .dark .email-content-preview span,
        .dark .email-content-preview div,
        .dark .email-content-preview li,
        .dark .email-content-preview td,
        .dark .email-content-preview th,
        .dark .email-content-preview strong,
        .dark .email-content-preview em,
        .dark .email-content-preview b,
        .dark .email-content-preview i {
            color: #f3f4f6 !important;
        }
        .dark .email-content-preview a {
            color: #60a5fa !important;
        }
        .dark .email-content-preview h1,
        .dark .email-content-preview h2,
        .dark .email-content-preview h3,
        .dark .email-content-preview h4 {
            color: #ffffff !important;
        }

        /* Line clamp utility for notification text */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Toast notification animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        @keyframes shrink {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-shrink {
            animation: shrink 6s linear forwards;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-black">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration with fallback to demo mode
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
          ? 'http://localhost:3000'
          : 'https://ai-lead-recovery.onrender.com';
        const DEMO_MODE_KEY = 'demo_mode_enabled';

        // Parse "YYYY-MM-DD" + "HH:MM" as LOCAL device time.
        // new Date('YYYY-MM-DDTHH:MM') is ambiguous across browsers (some treat as UTC).
        // new Date(year, month-1, day, hour, minute) is ALWAYS local ‚Äî safe for any timezone.
        const parseLocalDateTime = (date, time) => {
            const [yr, mo, dy] = date.split('-').map(Number);
            const [hr, mn] = (time || '0:00').split(':').map(Number);
            return new Date(yr, mo - 1, dy, hr, mn, 0);
        };

        // Demo data for offline mode
        const DEMO_DATA = {
            user: { id: 1, email: 'demo@example.com', company_name: 'Demo Company' },
            token: 'demo-token-12345',
            leads: [
                { id: 1, first_name: 'John', last_name: 'Doe', email: 'john@example.com', company: 'Acme Inc', status: 'new', ai_intent: null },
                { id: 2, first_name: 'Jane', last_name: 'Smith', email: 'jane@example.com', company: 'Tech Corp', status: 'replied', ai_intent: 'INTERESTED' },
                { id: 3, first_name: 'Bob', last_name: 'Wilson', email: 'bob@example.com', company: 'StartUp LLC', status: 'active', ai_intent: 'NOT_NOW' }
            ],
            sequences: [
                { id: 1, name: 'Standard Follow-Up', description: 'Basic 7-day sequence', is_active: true },
                { id: 2, name: 'Cold Outreach', description: 'Initial contact sequence', is_active: false }
            ],
            analytics: {
                overview: {
                    total_leads: 45,
                    reply_rate: 23,
                    recovered_this_month: 8,
                    active_sequences: 3
                },
                hot_leads: [
                    { id: 2, first_name: 'Jane', last_name: 'Smith', company: 'Tech Corp' }
                ],
                funnel: {
                    new: 12,
                    active: 18,
                    replied: 10,
                    interested: 5,
                    dead: 0
                },
                intent_distribution: {
                    INTERESTED: 5, NOT_NOW: 8, OBJECTION: 3, GHOSTING: 12, DEAD: 2
                },
                mode_comparison: {
                    manual: { sent: 35, leads_contacted: 20, replies: 8, reply_rate: 40, interested: 3, conversion_rate: 15 },
                    ai: { sent: 120, leads_contacted: 25, replies: 7, reply_rate: 28, interested: 5, conversion_rate: 20 }
                },
                sequences: [
                    { step: 1, name: 'Initial Email', sent: 1000, opens: 450, clicks: 80, replies: 25 },
                    { step: 2, name: 'Follow-up 1', sent: 975, opens: 390, clicks: 65, replies: 35 },
                    { step: 3, name: 'Follow-up 2', sent: 940, opens: 330, clicks: 50, replies: 28 },
                    { step: 4, name: 'Final Touch', sent: 912, opens: 274, clicks: 35, replies: 22 }
                ],
                reply_rate_trend: [
                    { day: 'Mon', rate: 18 }, { day: 'Tue', rate: 22 }, { day: 'Wed', rate: 25 },
                    { day: 'Thu', rate: 23 }, { day: 'Fri', rate: 28 }, { day: 'Sat', rate: 20 }, { day: 'Sun', rate: 23 }
                ]
            }
        };

        // ‚îÄ‚îÄ‚îÄ Billing View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function BillingView({ token, isDemoMode, darkMode, billingStatus, onRefresh }) {
            const [loading, setLoading] = useState(false);
            const [portalLoading, setPortalLoading] = useState(false);
            const [msg, setMsg] = useState('');

            // Stripe Price IDs from your .env
            const PRICES = {
                starter_monthly: 'price_1T3BbDB6QdpZs0Sxl3vLnM3h',
                growth_monthly: 'price_1T3Bd0B6QdpZs0SxkdV7cMpU',
                starter_annual: 'price_1T3BcTB6QdpZs0SxSJqYvPdq',
                growth_annual: 'price_1T3BdPB6QdpZs0SxbwGwp8dg'
            };

            // Handle Stripe redirect ‚Äî verify session to update plan in DB
            React.useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const sessionId = params.get('session_id');

                if (params.get('success') === 'true' && sessionId) {
                    sessionStorage.setItem('stripe_session_id', sessionId);
                    window.history.replaceState({}, '', '/billing');
                }
                if (params.get('canceled') === 'true') {
                    setMsg('Checkout was canceled. No charge was made.');
                    window.history.replaceState({}, '', '/billing');
                }

                const pendingSession = sessionStorage.getItem('stripe_session_id');
                if (pendingSession && token) {
                    sessionStorage.removeItem('stripe_session_id');
                    fetch(`${API_URL}/api/billing/verify-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ session_id: pendingSession })
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            setMsg('üéâ Payment successful! Your plan is now active.');
                            onRefresh && onRefresh();
                        } else {
                            setMsg('Payment received but plan update failed: ' + (data.detail || data.error));
                        }
                    })
                    .catch(() => setMsg('Payment received! Refresh the page to see your updated plan.'));
                }
            }, [token]);

            const checkout = async (priceKey) => {
                if (isDemoMode) { setMsg('Billing is disabled in demo mode.'); return; }
                setLoading(true); setMsg('');
                try {
                    const res = await fetch(`${API_URL}/api/billing/create-checkout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ price_id: priceKey })
                    });
                    const data = await res.json();
                    if (data.url) {
                        window.location.href = data.url;
                    } else if (data.error === 'stripe_not_configured') {
                        setMsg('‚öôÔ∏è Stripe not set up yet ‚Äî add your STRIPE_SECRET_KEY to backend/.env (see setup steps below).');
                    } else if (data.error === 'price_not_configured') {
                        setMsg('‚öôÔ∏è Stripe Price IDs not set up yet ‚Äî create products in Stripe Dashboard and paste the price IDs into backend/.env (see setup steps below).');
                    } else {
                        setMsg('Stripe error: ' + (data.detail || data.message || data.error || 'Unknown error'));
                    }
                } catch(e) { setMsg('Network error. Please try again.'); }
                finally { setLoading(false); }
            };

            const openPortal = async () => {
                setPortalLoading(true); setMsg('');
                try {
                    const res = await fetch(`${API_URL}/api/billing/portal`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    if (data.url) { window.location.href = data.url; }
                    else { setMsg(data.error || 'Failed to open billing portal.'); }
                } catch(e) { setMsg('Network error. Please try again.'); }
                finally { setPortalLoading(false); }
            };

            const daysLeft = billingStatus?.trial_ends_at
                ? Math.max(0, Math.ceil((new Date(billingStatus.trial_ends_at) - new Date()) / (1000*60*60*24)))
                : null;

            const isActive = billingStatus?.plan_status === 'active';
            const isTrialing = billingStatus?.plan_status === 'trialing';
            const isExpired = billingStatus?.plan_status === 'expired' || billingStatus?.plan_status === 'past_due';

            const card = `rounded-2xl border p-6 flex flex-col ${darkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'} shadow-sm`;
            const highlight = `rounded-2xl border-2 p-6 flex flex-col ${darkMode ? 'bg-blue-950 border-blue-500' : 'bg-blue-50 border-blue-500'} shadow-md`;

            return (
                <div className={`max-w-4xl mx-auto ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    <h2 className="text-3xl font-bold mb-2">Billing & Plans</h2>
                    <p className={`mb-6 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Manage your subscription, upgrade, or cancel anytime.
                    </p>

                    {/* Current status bar */}
                    {billingStatus && (
                        <div className={`rounded-xl p-4 mb-8 flex flex-wrap items-center justify-between gap-3 ${
                            isActive ? (darkMode ? 'bg-green-900/40 border border-green-700' : 'bg-green-50 border border-green-200') :
                            isTrialing ? (darkMode ? 'bg-yellow-900/40 border border-yellow-700' : 'bg-yellow-50 border border-yellow-200') :
                            (darkMode ? 'bg-red-900/40 border border-red-700' : 'bg-red-50 border border-red-200')
                        }`}>
                            <div>
                                <div className="font-semibold text-lg">
                                    {billingStatus.plan_name} Plan
                                    <span className={`ml-2 text-xs px-2 py-0.5 rounded-full font-bold ${
                                        isActive ? 'bg-green-500 text-white' :
                                        isTrialing ? 'bg-yellow-500 text-white' :
                                        'bg-red-500 text-white'
                                    }`}>
                                        {isActive ? 'Active' : isTrialing ? `Trial ‚Äî ${daysLeft}d left` : 'Expired'}
                                    </span>
                                </div>
                                <div className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Active Leads: {billingStatus.active_leads_count} / {billingStatus.active_leads_limit}
                                    &nbsp;¬∑&nbsp;
                                    AI Generations: {billingStatus.ai_generations_this_month} / {billingStatus.ai_generations_limit} this month
                                </div>
                            </div>
                            {isActive && (
                                <button onClick={openPortal} disabled={portalLoading}
                                    className="px-4 py-2 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50">
                                    {portalLoading ? 'Opening...' : 'Manage Billing'}
                                </button>
                            )}
                        </div>
                    )}

                    {msg && (
                        <div className={`mb-6 p-3 rounded-lg text-sm ${msg.includes('success') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {msg}
                        </div>
                    )}

                    {/* Pricing cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        {/* Starter */}
                        <div className={billingStatus?.plan === 'starter' && isActive ? highlight : card}>
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h3 className="text-xl font-bold">Starter</h3>
                                    <p className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Perfect for solo founders</p>
                                </div>
                                {billingStatus?.plan === 'starter' && isActive && (
                                    <span className="text-xs bg-blue-500 text-white px-2 py-1 rounded-full font-bold">Current</span>
                                )}
                            </div>
                            <div className="mb-4">
                                <span className="text-4xl font-bold">$29</span>
                                <span className={`text-sm ml-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>/month</span>
                                <div className={`text-xs mt-0.5 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                    or $279/year (save $69)
                                </div>
                            </div>
                            <ul className={`space-y-2 text-sm mb-6 flex-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                <li>‚úì 300 active leads in sequences</li>
                                <li>‚úì 3 email sequences</li>
                                <li>‚úì 600 AI email generations/month</li>
                                <li>‚úì AI reply analysis (unlimited)</li>
                                <li>‚úì Gmail integration</li>
                                <li>‚úì Analytics dashboard</li>
                                <li>‚úì Email support</li>
                            </ul>
                            {!(billingStatus?.plan === 'starter' && isActive) && (
                                <div className="flex flex-col gap-2">
                                    <button
                                        onClick={() => checkout(PRICES.starter_monthly)}
                                        disabled={loading}
                                        className="w-full py-3 px-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold disabled:opacity-50"
                                    >
                                        {loading ? 'Loading...' : 'Subscribe Monthly ‚Äî $29'}
                                    </button>
                                    <button
                                        onClick={() => checkout(PRICES.starter_annual)}
                                        disabled={loading}
                                        className="w-full py-2 px-4 rounded-xl border border-blue-500 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-950 font-medium disabled:opacity-50 text-sm"
                                    >
                                        Annual ‚Äî $279/year
                                    </button>
                                </div>
                            )}
                            {billingStatus?.plan === 'starter' && isActive && (
                                <button onClick={openPortal} disabled={portalLoading}
                                    className="w-full py-2 px-4 rounded-xl border border-gray-400 text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 font-medium text-sm disabled:opacity-50">
                                    {portalLoading ? 'Opening...' : 'Manage / Cancel'}
                                </button>
                            )}
                        </div>

                        {/* Growth */}
                        <div className={billingStatus?.plan === 'growth' && isActive ? highlight : card}>
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h3 className="text-xl font-bold">Growth</h3>
                                    <p className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>For scaling sales teams</p>
                                </div>
                                <div className="flex flex-col items-end gap-1">
                                    <span className="text-xs bg-purple-500 text-white px-2 py-1 rounded-full font-bold">Most Popular</span>
                                    {billingStatus?.plan === 'growth' && isActive && (
                                        <span className="text-xs bg-blue-500 text-white px-2 py-1 rounded-full font-bold">Current</span>
                                    )}
                                </div>
                            </div>
                            <div className="mb-4">
                                <span className="text-4xl font-bold">$79</span>
                                <span className={`text-sm ml-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>/month</span>
                                <div className={`text-xs mt-0.5 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                    or $759/year (save $189)
                                </div>
                            </div>
                            <ul className={`space-y-2 text-sm mb-6 flex-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                <li>‚úì Unlimited active leads in sequences</li>
                                <li>‚úì Unlimited email sequences</li>
                                <li>‚úì 3,000 AI email generations/month</li>
                                <li>‚úì AI reply analysis (unlimited)</li>
                                <li>‚úì Gmail integration</li>
                                <li>‚úì Analytics dashboard</li>
                                <li>‚úì Priority email support</li>
                            </ul>
                            {!(billingStatus?.plan === 'growth' && isActive) && (
                                <div className="flex flex-col gap-2">
                                    <button
                                        onClick={() => checkout(PRICES.growth_monthly)}
                                        disabled={loading}
                                        className="w-full py-3 px-4 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-semibold disabled:opacity-50"
                                    >
                                        {loading ? 'Loading...' : 'Subscribe Monthly ‚Äî $79'}
                                    </button>
                                    <button
                                        onClick={() => checkout(PRICES.growth_annual)}
                                        disabled={loading}
                                        className="w-full py-2 px-4 rounded-xl border border-purple-500 text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-950 font-medium disabled:opacity-50 text-sm"
                                    >
                                        Annual ‚Äî $759/year
                                    </button>
                                </div>
                            )}
                            {billingStatus?.plan === 'growth' && isActive && (
                                <button onClick={openPortal} disabled={portalLoading}
                                    className="w-full py-2 px-4 rounded-xl border border-gray-400 text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 font-medium text-sm disabled:opacity-50">
                                    {portalLoading ? 'Opening...' : 'Manage / Cancel'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* FAQ */}
                    <div className={`rounded-2xl p-6 ${darkMode ? 'bg-gray-900 border border-gray-700' : 'bg-gray-50 border border-gray-200'}`}>
                        <h3 className="font-bold text-lg mb-4">Common Questions</h3>
                        <div className="space-y-4 text-sm">
                            <div>
                                <p className="font-semibold">What is an active lead?</p>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>A lead currently enrolled in a running email sequence. Leads marked as Dead or with completed sequences don't count.</p>
                            </div>
                            <div>
                                <p className="font-semibold">What counts as an AI generation?</p>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Every time AI writes a personalized email for you. Automatic reply analysis does not count toward this limit.</p>
                            </div>
                            <div>
                                <p className="font-semibold">Can I cancel anytime?</p>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Yes. Cancel from the billing portal ‚Äî you keep access until your paid period ends. No refunds on partial months.</p>
                            </div>
                            <div>
                                <p className="font-semibold">Is annual billing a one-time charge?</p>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Yes ‚Äî billed once per year. You save 20% compared to monthly billing.</p>
                            </div>
                        </div>
                    </div>

                    {/* Stripe Setup Guide */}
                    <div className={`rounded-2xl p-6 mt-6 ${darkMode ? 'bg-gray-900 border border-gray-700' : 'bg-gray-50 border border-gray-200'}`}>
                        <h3 className="font-bold text-lg mb-4">‚öôÔ∏è Stripe Setup Guide (One-Time)</h3>
                        <ol className={`space-y-3 text-sm list-decimal list-inside ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            <li>
                                <span className="font-semibold">Create a free Stripe account</span> at{' '}
                                <span className={`font-mono text-xs px-1 py-0.5 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>stripe.com</span>
                            </li>
                            <li>
                                <span className="font-semibold">Get your test API key:</span> Dashboard ‚Üí Developers ‚Üí API Keys ‚Üí copy <span className={`font-mono text-xs px-1 py-0.5 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>Secret key</span> (starts with <span className="font-mono text-xs">sk_test_...</span>)
                            </li>
                            <li>
                                <span className="font-semibold">Create 4 products</span> in Dashboard ‚Üí Products ‚Üí Add Product:
                                <ul className={`mt-1 ml-4 space-y-1 list-disc ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    <li>Starter Monthly ‚Äî $29 / month (recurring)</li>
                                    <li>Starter Annual ‚Äî $279 / year (recurring)</li>
                                    <li>Growth Monthly ‚Äî $79 / month (recurring)</li>
                                    <li>Growth Annual ‚Äî $759 / year (recurring)</li>
                                </ul>
                            </li>
                            <li>
                                <span className="font-semibold">Copy each Price ID</span> (looks like <span className="font-mono text-xs">price_1ABC...</span>) from each product
                            </li>
                            <li>
                                <span className="font-semibold">Paste into</span> <span className={`font-mono text-xs px-1 py-0.5 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>backend/.env</span>:
                                <pre className={`mt-2 p-3 rounded-lg text-xs overflow-x-auto ${darkMode ? 'bg-black text-green-400' : 'bg-gray-900 text-green-400'}`}>{`STRIPE_SECRET_KEY=sk_test_YOUR_KEY_HERE
STRIPE_PRICE_STARTER_MONTHLY=price_YOUR_ID_HERE
STRIPE_PRICE_GROWTH_MONTHLY=price_YOUR_ID_HERE
STRIPE_PRICE_STARTER_ANNUAL=price_YOUR_ID_HERE
STRIPE_PRICE_GROWTH_ANNUAL=price_YOUR_ID_HERE`}</pre>
                            </li>
                            <li><span className="font-semibold">Restart your server</span> after saving .env</li>
                            <li>
                                <span className="font-semibold">Set up webhook</span> (for subscription events): Dashboard ‚Üí Developers ‚Üí Webhooks ‚Üí Add endpoint ‚Üí URL: <span className={`font-mono text-xs px-1 py-0.5 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>https://yourdomain.com/api/webhooks/stripe</span>
                                <br/><span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Events: checkout.session.completed, invoice.payment_succeeded, invoice.payment_failed, customer.subscription.deleted, customer.subscription.updated</span>
                            </li>
                        </ol>
                        <div className={`mt-4 p-3 rounded-lg text-xs ${darkMode ? 'bg-blue-900/40 text-blue-300' : 'bg-blue-50 text-blue-700'}`}>
                            <strong>Tip:</strong> Use test mode (sk_test_...) while developing. Switch to live keys (sk_live_...) when you're ready to accept real payments.
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            // Initialize view based on URL pathname
            const getInitialView = () => {
                const path = window.location.pathname;
                if (path === '/settings') return 'settings';
                if (path === '/billing') return 'billing';
                if (path === '/leads' || path === '/inbox-hub' || path === '/inbox' || path === '/emails' || path === '/reviews') return 'inbox-hub';
                if (path === '/appointments') return 'appointments';
                return 'dashboard';
            };
            const [currentView, setCurrentView] = useState(getInitialView());
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [isDemoMode, setIsDemoMode] = useState(localStorage.getItem(DEMO_MODE_KEY) === 'true');
            const [connectionStatus, setConnectionStatus] = useState('checking');
            const [darkMode, setDarkMode] = useState(localStorage.getItem('dark_mode') === 'true');
            const [connectedEmail, setConnectedEmail] = useState(null);
            const [billingStatus, setBillingStatus] = useState(null); // plan info

            // Notification system state
            const [toastNotifications, setToastNotifications] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);
            const [unreadLeadIds, setUnreadLeadIds] = useState([]); // Track which leads have unread emails
            const [apptUnreadCount, setApptUnreadCount] = useState(0); // AI-detected appointment notifications
            // Persist shown-reminder keys in localStorage so we don't re-fire on page reload
            const shownRemindersRef = React.useRef(
                new Set(JSON.parse(localStorage.getItem('ztm-shown-reminders') || '[]'))
            );
            const audioCtxRef = React.useRef(null); // persistent AudioContext ‚Äî must be created after user interaction
            const [upcomingAlerts, setUpcomingAlerts] = useState([]); // persistent global alert bar data
            const [notificationPermission, setNotificationPermission] = useState(
                typeof Notification !== 'undefined' ? Notification.permission : 'denied'
            );

            // Apply dark mode class to html element
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('dark_mode', darkMode);
            }, [darkMode]);

            const toggleDarkMode = async () => {
                const newMode = !darkMode;
                setDarkMode(newMode);

                if (!isDemoMode && token) {
                    try {
                        await fetch(`${API_URL}/api/settings/dark-mode`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ dark_mode: newMode })
                        });
                    } catch (error) {
                        console.error('Error saving dark mode preference:', error);
                    }
                }
            };

            // Navigate and update URL
            const navigateTo = (view) => {
                setCurrentView(view);
                const path = view === 'dashboard' ? '/' : `/${view}`;
                try { window.history.pushState({}, '', path); } catch(e) { /* file:// protocol doesn't support pushState */ }
            };

            // Handle notification click to show email details
            const handleNotificationClick = (leadId) => {
                navigateTo('inbox-hub');
                // Store the lead id to select it in CommandCenterView
                localStorage.setItem('selected-lead-from-notification', leadId);
                // Also dispatch event so CommandCenterView reacts even if already mounted
                window.dispatchEvent(new CustomEvent('selectLeadFromNotification', { detail: { leadId } }));
            };

            useEffect(() => {
                checkConnection();
            }, []);

            useEffect(() => {
                if (token) {
                    if (isDemoMode) {
                        setUser(DEMO_DATA.user);
                        setIsAuthenticated(true);
                    } else {
                        fetchUser();
                    }
                }
            }, [token, isDemoMode]);

            // Notification system - request permission, start polling, register Service Worker
            useEffect(() => {
                if (isAuthenticated && !isDemoMode) {
                    // Request notification permission on first load
                    if (Notification.permission === 'default') {
                        const shouldAsk = localStorage.getItem('notification-prompt-shown') !== 'true';
                        if (shouldAsk) {
                            setTimeout(() => {
                                if (confirm('Enable desktop notifications?\n\nThis lets ZeroTouch Mail alert you about:\n‚Ä¢ New email replies from leads\n‚Ä¢ Upcoming appointments (even when you\'re on another website)\n\nClick OK to allow.')) {
                                    requestNotificationPermission();
                                }
                                localStorage.setItem('notification-prompt-shown', 'true');
                            }, 2000);
                        }
                    }

                    // ‚îÄ‚îÄ Service Worker: register + hand off auth token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    let swMessageHandler = null;
                    let keepAliveTimer   = null;

                    if ('serviceWorker' in navigator) {
                        // Register the SW (no-op if already registered)
                        navigator.serviceWorker.register('/sw.js').catch(err => {
                            console.warn('[App] SW registration failed:', err);
                        });

                        // As soon as a controller is ready, send our auth token
                        const sendAuth = (controller) => {
                            controller.postMessage({ type: 'AUTH', token, url: API_URL });
                        };
                        navigator.serviceWorker.ready.then(reg => {
                            if (reg.active) sendAuth(reg.active);
                        });
                        // Also handle controller changes (first activation)
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            if (navigator.serviceWorker.controller) {
                                sendAuth(navigator.serviceWorker.controller);
                            }
                        });

                        // Listen for messages coming FROM the Service Worker
                        swMessageHandler = (event) => {
                            const msg = event.data || {};
                            if (msg.type === 'SW_APPOINTMENT_DETECTED') {
                                // New AI-detected appointment ‚Äî SW already handled the OS notif if page was closed
                                // We handle the in-app toast + sound here
                                const apt = msg.apt || {};
                                const leadName = apt.lead
                                    ? (`${apt.lead.first_name || ''} ${apt.lead.last_name || ''}`.trim() || apt.lead.email)
                                    : 'A lead';
                                const dateStr = apt.date ? ` on ${apt.date}` : '';
                                const timeStr = apt.time ? ` at ${apt.time}` : '';
                                setApptUnreadCount(prev => prev + 1);
                                addToastNotification({
                                    id: `apt-sw-${apt.id}`,
                                    type: 'appointment',
                                    lead_id: apt.lead_id,
                                    subject: 'üìÖ Appointment Detected',
                                    preview: `${leadName}${dateStr}${timeStr} (${apt.appointment_type || 'call'})`
                                });
                                playNotificationSound();

                            } else if (msg.type === 'SW_REMINDER') {
                                // Upcoming reminder from SW ‚Äî show in-app toast + sound
                                // Dedup: skip if the page already handled this reminder
                                const { reminderType, apt = {}, minsUntil, hoursUntil, leadName = 'Lead', timeLabel = '' } = msg;
                                const swKey = `${apt.id}-${reminderType}`;
                                if (shownRemindersRef.current.has(swKey)) return;
                                shownRemindersRef.current.add(swKey);
                                localStorage.setItem('ztm-shown-reminders', JSON.stringify(Array.from(shownRemindersRef.current)));

                                const toastId = `sw-reminder-${reminderType}-${apt.id}-${Date.now()}`;
                                if (reminderType === '15m') {
                                    const label = minsUntil <= 0 ? 'Starting NOW!' : `in ${minsUntil} min!`;
                                    setToastNotifications(prev => [...prev, {
                                        id: toastId, type: 'appointment_reminder', urgent: true,
                                        emoji: 'üî¥', lead_name: `Appointment ${label}`,
                                        lead_company: leadName, body: timeLabel
                                    }]);
                                    setTimeout(() => setToastNotifications(prev => prev.filter(t => t.id !== toastId)), 60000);
                                } else if (reminderType === '1h') {
                                    setToastNotifications(prev => [...prev, {
                                        id: toastId, type: 'appointment_reminder', urgent: false,
                                        emoji: 'üü°', lead_name: `Appointment in ${minsUntil} min ‚Äî prepare!`,
                                        lead_company: leadName, body: timeLabel
                                    }]);
                                    setTimeout(() => setToastNotifications(prev => prev.filter(t => t.id !== toastId)), 20000);
                                } else {
                                    setToastNotifications(prev => [...prev, {
                                        id: toastId, type: 'appointment_reminder', urgent: false,
                                        emoji: '‚è∞', lead_name: `Appointment in ${hoursUntil}h`,
                                        lead_company: leadName, body: timeLabel
                                    }]);
                                    setTimeout(() => setToastNotifications(prev => prev.filter(t => t.id !== toastId)), 15000);
                                }
                                playNotificationSound();

                            } else if (msg.type === 'NOTIFICATION_CLICKED') {
                                // User clicked a browser notification while app was closed; now page is focused
                                navigateTo('appointments');
                                playNotificationSound();
                            }
                        };
                        navigator.serviceWorker.addEventListener('message', swMessageHandler);

                        // Keep the SW alive with periodic pings every 25 s
                        keepAliveTimer = setInterval(() => {
                            if (navigator.serviceWorker.controller) {
                                navigator.serviceWorker.controller.postMessage({ type: 'KEEPALIVE' });
                            }
                        }, 25_000);
                    }
                    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                    // Check for notifications immediately
                    fetchNotifications();
                    fetchAppointmentNotifications();
                    checkAppointmentReminders();

                    // Poll for new email notifications every 30 seconds
                    const notificationInterval = setInterval(() => {
                        fetchNotifications();
                    }, 30000);

                    // Poll for AI-detected appointment notifications every 60 seconds
                    const apptNotifInterval = setInterval(() => {
                        fetchAppointmentNotifications();
                    }, 60000);

                    // Check upcoming appointment reminders every 2 minutes (SW also covers background)
                    const reminderInterval = setInterval(() => {
                        checkAppointmentReminders();
                    }, 2 * 60 * 1000);

                    return () => {
                        clearInterval(notificationInterval);
                        clearInterval(apptNotifInterval);
                        clearInterval(reminderInterval);
                        if (keepAliveTimer) clearInterval(keepAliveTimer);
                        if (swMessageHandler && 'serviceWorker' in navigator) {
                            navigator.serviceWorker.removeEventListener('message', swMessageHandler);
                        }
                    };
                }
            }, [isAuthenticated, isDemoMode, token]);

            const checkConnection = async () => {
                if (isDemoMode) {
                    setConnectionStatus('demo');
                    return;
                }

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    const response = await fetch(`${API_URL}/health`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    setConnectionStatus(response.ok ? 'connected' : 'error');
                } catch (error) {
                    setConnectionStatus('offline');
                }
            };

            const fetchUser = async () => {
                try {
                    const response = await fetch(`${API_URL}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setUser(data.user);
                        setIsAuthenticated(true);
                        fetchConnectedEmail();
                        fetchBillingStatus();
                    } else {
                        logout();
                    }
                } catch (error) {
                    console.error('Error fetching user:', error);
                    logout();
                }
            };

            const fetchBillingStatus = async () => {
                if (isDemoMode) return;
                try {
                    const res = await fetch(`${API_URL}/api/billing/status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setBillingStatus(data);
                    }
                } catch (e) {
                    console.error('Error fetching billing status:', e);
                }
            };

            const fetchConnectedEmail = async () => {
                if (isDemoMode) {
                    setConnectedEmail('demo@example.com');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/settings/email`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.email && data.provider === 'gmail') {
                            setConnectedEmail(data.email);
                        } else {
                            setConnectedEmail(null);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching connected email:', error);
                }
            };

            const login = (newToken, userData) => {
                localStorage.setItem('token', newToken);
                setToken(newToken);
                setUser(userData);
                setIsAuthenticated(true);
                fetchConnectedEmail();
                // Tell the Service Worker about the new auth token immediately
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'AUTH', token: newToken, url: API_URL });
                }
            };

            const logout = () => {
                localStorage.removeItem('token');
                // Clear persisted reminder keys so they fire fresh next login
                localStorage.removeItem('ztm-shown-reminders');
                setToken(null);
                setUser(null);
                setIsAuthenticated(false);
                setConnectedEmail(null);
                // Tell the Service Worker to stop polling
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'LOGOUT' });
                }
            };

            const enableDemoMode = () => {
                localStorage.setItem(DEMO_MODE_KEY, 'true');
                setIsDemoMode(true);
                login(DEMO_DATA.token, DEMO_DATA.user);
                setConnectionStatus('demo');
            };

            const disableDemoMode = () => {
                localStorage.removeItem(DEMO_MODE_KEY);
                setIsDemoMode(false);
                logout();
                checkConnection();
            };

            // Request notification permission
            const requestNotificationPermission = async () => {
                if (typeof Notification === 'undefined') {
                    console.log('Browser notifications not supported');
                    return;
                }

                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    setNotificationPermission(permission);

                    if (permission === 'granted') {
                        // Show a test notification
                        new Notification('Notifications Enabled ‚úÖ', {
                            body: 'You will receive alerts for new email replies and upcoming appointments ‚Äî even when on another website.',
                            icon: '/favicon.ico',
                            tag: 'notification-enabled'
                        });
                    }
                }
            };

            // Add a toast notification to the corner
            const addToastNotification = (notif) => {
                const toastId = `toast-${notif.id}-${Date.now()}`;
                const intentEmoji = {
                    'INTERESTED': 'üéØ',
                    'OBJECTION': 'ü§î',
                    'NOT_NOW': '‚è∞',
                    'DEAD': '‚ùå',
                    'GHOSTING': 'üëª'
                }[notif.ai_intent] || 'üìß';

                const toast = {
                    id: toastId,
                    lead_name: notif.lead_name,
                    lead_company: notif.lead_company,
                    subject: notif.subject,
                    body: notif.body.substring(0, 80),
                    intent: notif.ai_intent,
                    emoji: intentEmoji,
                    lead_id: notif.lead_id
                };

                setToastNotifications(prev => [...prev, toast]);

                // Auto-dismiss after 6 seconds
                setTimeout(() => {
                    setToastNotifications(prev => prev.filter(t => t.id !== toastId));
                }, 6000);
            };

            // Fetch new notifications from backend
            const fetchNotifications = async () => {
                if (isDemoMode || !token) return;

                try {
                    const response = await fetch(`${API_URL}/api/emails/notifications`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // If there are new notifications, show them
                        if (data.notifications && data.notifications.length > 0) {
                            const newNotifs = data.notifications;

                            // Show toast and browser notifications for new emails
                            newNotifs.forEach(notif => {
                                // Show toast in corner
                                addToastNotification(notif);

                                // Play notification sound
                                playNotificationSound();
                            });

                            setUnreadCount(prev => prev + newNotifs.length);

                            // Track which leads have unread emails
                            const newUnreadLeadIds = newNotifs
                                .map(n => n.lead_id)
                                .filter(id => id && !unreadLeadIds.includes(id));
                            if (newUnreadLeadIds.length > 0) {
                                setUnreadLeadIds(prev => [...new Set([...prev, ...newUnreadLeadIds])]);
                            }

                            // Dispatch event to refresh leads and current lead details
                            window.dispatchEvent(new CustomEvent('newEmailsReceived', { detail: { notifications: newNotifs } }));

                            // Mark as notified on backend
                            const threadIds = newNotifs.map(n => n.id);
                            await fetch(`${API_URL}/api/emails/mark-notified`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ threadIds })
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                }
            };

            // Fetch AI-detected appointment notifications
            const fetchAppointmentNotifications = async () => {
                if (isDemoMode || !token) return;
                try {
                    const res = await fetch(`${API_URL}/api/appointments/notifications`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.notifications && data.notifications.length > 0) {
                            setApptUnreadCount(prev => prev + data.notifications.length);
                            data.notifications.forEach(apt => {
                                const leadName = apt.lead
                                    ? `${apt.lead.first_name || ''} ${apt.lead.last_name || ''}`.trim() || apt.lead.email
                                    : 'A lead';
                                const dateStr = apt.date ? ` on ${apt.date}` : '';
                                const timeStr = apt.time ? ` at ${apt.time}` : '';
                                addToastNotification({
                                    id: `apt-${apt.id}`,
                                    type: 'appointment',
                                    lead_id: apt.lead_id,
                                    subject: `üìÖ Appointment Detected`,
                                    preview: `${leadName}${dateStr}${timeStr} (${apt.appointment_type || 'call'})`
                                });
                                playNotificationSound();
                            });
                        }
                    }
                } catch (e) {
                    console.error('Error fetching appointment notifications:', e);
                }
            };

            // Check upcoming appointments ‚Äî updates persistent alert bar + fires one-time toast & browser notif
            const checkAppointmentReminders = async () => {
                if (isDemoMode || !token) return;
                try {
                    const res = await fetch(`${API_URL}/api/appointments`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) return;
                    const data = await res.json();
                    const now = Date.now();
                    const alerts = [];

                    (data.appointments || []).forEach(apt => {
                        if (apt.status !== 'scheduled' || !apt.date || !apt.time) return;
                        const aptTime = parseLocalDateTime(apt.date, apt.time).getTime();
                        // Allow up to 2 minutes past the appointment time (handles polling gaps)
                        if (isNaN(aptTime) || aptTime < now - 2 * 60 * 1000) return;
                        const minsUntil = Math.round((aptTime - now) / 60000);
                        const leadName = apt.lead
                            ? `${apt.lead.first_name || ''} ${apt.lead.last_name || ''}`.trim() || apt.lead.email
                            : 'Unknown lead';
                        const timeStr = `${apt.date} at ${apt.time}`;

                        // Persistent alert bar: show for appointments within 1 hour
                        if (minsUntil <= 60 && minsUntil >= 0) {
                            alerts.push({ ...apt, minsUntil, leadName, timeStr });
                        }

                        // ‚îÄ‚îÄ Tier 1: 24-hour heads-up ‚îÄ‚îÄ
                        const key24h = `${apt.id}-24h`;
                        if (minsUntil > 60 && minsUntil <= 1440 && !shownRemindersRef.current.has(key24h)) {
                            shownRemindersRef.current.add(key24h);
                            localStorage.setItem('ztm-shown-reminders', JSON.stringify(Array.from(shownRemindersRef.current)));
                            const hoursUntil = Math.round(minsUntil / 60);

                            const toastId = `reminder-24h-${apt.id}-${Date.now()}`;
                            setToastNotifications(prev => [...prev, {
                                id: toastId, type: 'appointment_reminder', urgent: false,
                                emoji: '‚è∞', lead_name: `Appointment in ${hoursUntil} hour${hoursUntil !== 1 ? 's' : ''}`,
                                lead_company: leadName, body: timeStr
                            }]);
                            setTimeout(() => setToastNotifications(prev => prev.filter(t => t.id !== toastId)), 15000);

                            if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                                new Notification(`‚è∞ Appointment in ${hoursUntil} hour${hoursUntil !== 1 ? 's' : ''}`, {
                                    body: `${leadName} ¬∑ ${timeStr}`,
                                    icon: '/favicon.ico',
                                    tag: `apt-24h-${apt.id}`
                                });
                            }
                            playNotificationSound();
                        }

                        // ‚îÄ‚îÄ Tier 2: 1-hour "prepare now" reminder ‚îÄ‚îÄ
                        const key1h = `${apt.id}-1h`;
                        if (minsUntil > 15 && minsUntil <= 60 && !shownRemindersRef.current.has(key1h)) {
                            shownRemindersRef.current.add(key1h);
                            localStorage.setItem('ztm-shown-reminders', JSON.stringify(Array.from(shownRemindersRef.current)));

                            const toastId = `reminder-1h-${apt.id}-${Date.now()}`;
                            setToastNotifications(prev => [...prev, {
                                id: toastId, type: 'appointment_reminder', urgent: false,
                                emoji: 'üü°', lead_name: `Appointment in ${minsUntil} min ‚Äî prepare!`,
                                lead_company: leadName, body: timeStr
                            }]);
                            setTimeout(() => setToastNotifications(prev => prev.filter(t => t.id !== toastId)), 20000);

                            if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                                new Notification(`üü° Appointment in ${minsUntil} min ‚Äî prepare!`, {
                                    body: `${leadName} ¬∑ ${timeStr}`,
                                    icon: '/favicon.ico',
                                    tag: `apt-1h-${apt.id}`
                                });
                            }
                            playNotificationSound();
                        }

                        // ‚îÄ‚îÄ Tier 3: 15-minute URGENT reminder ‚îÄ‚îÄ
                        const key15m = `${apt.id}-15m`;
                        if (minsUntil <= 15 && minsUntil >= 0 && !shownRemindersRef.current.has(key15m)) {
                            shownRemindersRef.current.add(key15m);
                            localStorage.setItem('ztm-shown-reminders', JSON.stringify(Array.from(shownRemindersRef.current)));
                            const label = minsUntil <= 0 ? 'Starting NOW!' : `in ${minsUntil} min!`;

                            const toastId = `reminder-15m-${apt.id}-${Date.now()}`;
                            setToastNotifications(prev => [...prev, {
                                id: toastId, type: 'appointment_reminder', urgent: true,
                                emoji: 'üî¥', lead_name: `Appointment ${label}`,
                                lead_company: leadName, body: timeStr
                            }]);
                            setTimeout(() => setToastNotifications(prev => prev.filter(t => t.id !== toastId)), 60000);

                            if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                                new Notification(`üî¥ Appointment ${label}`, {
                                    body: `${leadName} ¬∑ ${timeStr}`,
                                    icon: '/favicon.ico',
                                    tag: `apt-15m-${apt.id}`,
                                    requireInteraction: true
                                });
                            }
                            playNotificationSound();
                        }
                    });

                    // Update the persistent global alert bar (recalculates every 5 min)
                    setUpcomingAlerts(alerts);
                } catch (e) {
                    console.error('Error checking appointment reminders:', e);
                }
            };

            // Initialize AudioContext on first user click (browser requires a gesture to unlock audio).
            // Does NOT play any sound ‚Äî sounds only fire on actual notification events, not on every click.
            const initAudio = () => {
                if (!audioCtxRef.current) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtxRef.current.state === 'suspended') {
                    audioCtxRef.current.resume();
                }
            };

            // Play notification sound ‚Äî uses the pre-initialized context so it works from timers too
            const playNotificationSound = () => {
                try {
                    const ctx = audioCtxRef.current;
                    if (!ctx || ctx.state !== 'running') return; // silently skip if user hasn't interacted yet

                    // Two-tone ding: high then mid
                    const playTone = (freq, startTime, duration) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.35, startTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                        osc.start(startTime);
                        osc.stop(startTime + duration);
                    };

                    playTone(880, ctx.currentTime, 0.18);        // high ding
                    playTone(660, ctx.currentTime + 0.2, 0.28);  // lower follow-up
                } catch (e) {
                    console.error('Sound error:', e.message);
                }
            };

            if (!isAuthenticated) {
                return <AuthScreen 
                    onLogin={login} 
                    connectionStatus={connectionStatus}
                    onEnableDemoMode={enableDemoMode}
                    isDemoMode={isDemoMode}
                />;
            }

            return (
                <div className={currentView === 'inbox-hub' ? 'h-screen flex flex-col overflow-hidden' : 'min-h-screen'} onClick={initAudio}>
                    {/* Connection Status Banner */}
                    {connectionStatus !== 'connected' && (
                        <div className={`${connectionStatus === 'demo' ? 'bg-blue-600' : 'bg-yellow-600'} text-white px-4 py-2 text-center text-sm`}>
                            {connectionStatus === 'demo' && 'üéÆ Demo Mode - Using sample data'}
                            {connectionStatus === 'offline' && '‚ö†Ô∏è Backend offline - Using demo mode'}
                            {connectionStatus === 'error' && '‚ö†Ô∏è Connection error - Using demo mode'}
                            {isDemoMode && (
                                <button 
                                    onClick={disableDemoMode}
                                    className="ml-4 underline hover:text-gray-200"
                                >
                                    Exit Demo Mode
                                </button>
                            )}
                        </div>
                    )}

                    {/* ‚îÄ‚îÄ Trial / Plan Expired Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
                    {billingStatus && billingStatus.plan_status === 'trialing' && (() => {
                        const daysLeft = Math.max(0, Math.ceil((new Date(billingStatus.trial_ends_at) - new Date()) / (1000*60*60*24)));
                        return (
                            <div className={`text-center text-sm py-2 px-4 ${daysLeft <= 3 ? 'bg-red-500' : 'bg-yellow-500'} text-white font-medium flex items-center justify-center gap-3`}>
                                <span>
                                    {daysLeft === 0
                                        ? 'Your free trial ends today!'
                                        : `Free trial: ${daysLeft} day${daysLeft === 1 ? '' : 's'} remaining`}
                                </span>
                                <button
                                    onClick={() => navigateTo('billing')}
                                    className="bg-white text-yellow-700 px-3 py-0.5 rounded text-xs font-bold hover:bg-yellow-50"
                                >
                                    Upgrade Now
                                </button>
                            </div>
                        );
                    })()}
                    {billingStatus && (billingStatus.plan_status === 'expired' || billingStatus.plan_status === 'past_due') && (
                        <div className="text-center text-sm py-2 px-4 bg-red-600 text-white font-medium flex items-center justify-center gap-3">
                            <span>
                                {billingStatus.plan_status === 'past_due'
                                    ? 'Payment failed ‚Äî please update your billing details to continue.'
                                    : 'Your free trial has expired. Upgrade to keep using ZeroTouch Mail AI.'}
                            </span>
                            <button
                                onClick={() => navigateTo('billing')}
                                className="bg-white text-red-700 px-3 py-0.5 rounded text-xs font-bold hover:bg-red-50"
                            >
                                {billingStatus.plan_status === 'past_due' ? 'Fix Payment' : 'Upgrade Now'}
                            </button>
                        </div>
                    )}

                    <nav className="bg-white dark:bg-black shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center space-x-8">
                                    <h1 className="text-2xl font-bold text-blue-600 dark:text-blue-400">
                                        ZeroTouch Mail AI
                                    </h1>
                                    <div className="space-x-4">
                                        <button
                                            onClick={() => navigateTo('dashboard')}
                                            className={`px-3 py-2 rounded ${currentView === 'dashboard' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            Dashboard
                                        </button>
                                        <button
                                            onClick={() => { navigateTo('inbox-hub'); setUnreadCount(0); setUnreadLeadIds([]); }}
                                            className={`px-3 py-2 rounded relative ${currentView === 'inbox-hub' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            Leads & Inbox
                                            {unreadCount > 0 && (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        navigateTo('inbox-hub');
                                                        setUnreadCount(0);
                                                        setUnreadLeadIds([]);
                                                    }}
                                                    className="absolute -top-1 -right-2 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center cursor-pointer transition-all hover:scale-110"
                                                    title="Click to view inbox"
                                                >
                                                    {unreadCount > 9 ? '9+' : unreadCount}
                                                </button>
                                            )}
                                        </button>
                                        <button
                                            onClick={() => navigateTo('sequences')}
                                            className={`px-3 py-2 rounded ${currentView === 'sequences' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            Sequences
                                        </button>
                                        <button
                                            onClick={() => navigateTo('templates')}
                                            className={`px-3 py-2 rounded ${currentView === 'templates' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            Templates
                                        </button>
                                        <button
                                            onClick={() => { navigateTo('appointments'); setApptUnreadCount(0); }}
                                            className={`px-3 py-2 rounded relative ${currentView === 'appointments' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            Appointments
                                            {apptUnreadCount > 0 && (
                                                <span className="absolute -top-1 -right-2 bg-green-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                                    {apptUnreadCount > 9 ? '9+' : apptUnreadCount}
                                                </span>
                                            )}
                                        </button>
                                        <button
                                            onClick={() => navigateTo('settings')}
                                            className={`px-3 py-2 rounded ${currentView === 'settings' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            Settings
                                        </button>
                                        <button
                                            onClick={() => navigateTo('billing')}
                                            className={`px-3 py-2 rounded flex items-center gap-1 ${currentView === 'billing' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            {billingStatus && billingStatus.plan_status === 'trialing' && (
                                                <span className="inline-block w-2 h-2 rounded-full bg-yellow-400"></span>
                                            )}
                                            {billingStatus && (billingStatus.plan_status === 'expired' || billingStatus.plan_status === 'past_due') && (
                                                <span className="inline-block w-2 h-2 rounded-full bg-red-500"></span>
                                            )}
                                            Billing
                                        </button>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    {/* Dark Mode Toggle */}
                                    <button
                                        onClick={toggleDarkMode}
                                        className="p-2 rounded-lg bg-gray-100 dark:bg-gray-900 hover:bg-gray-200 dark:hover:bg-gray-600"
                                        title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                                    >
                                        {darkMode ? (
                                            <svg className="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd" />
                                            </svg>
                                        ) : (
                                            <svg className="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                                            </svg>
                                        )}
                                    </button>
                                    <div className="flex flex-col items-end text-sm">
                                        <span className="text-gray-600 dark:text-gray-300">{user?.email}</span>
                                        {connectedEmail && (
                                            <span className="text-xs text-green-600 dark:text-green-400">
                                                üìß Sending from: {connectedEmail}
                                            </span>
                                        )}
                                        {!connectedEmail && (
                                            <span className="text-xs text-orange-600 dark:text-orange-400">
                                                ‚ö†Ô∏è No email connected
                                            </span>
                                        )}
                                    </div>
                                    <button
                                        onClick={logout}
                                        className="px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded"
                                    >
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* ‚îÄ‚îÄ Global Appointment Alert Bar (shows on every page) ‚îÄ‚îÄ */}
                    {upcomingAlerts.length > 0 && (
                        <div className="bg-red-600 text-white px-4 py-2.5 flex items-center justify-between gap-4 shadow-md">
                            <div className="flex items-center gap-3 min-w-0">
                                <span className="text-xl flex-shrink-0 animate-pulse">üîî</span>
                                <div className="min-w-0">
                                    {upcomingAlerts.length === 1 ? (
                                        <span className="text-sm font-semibold">
                                            Appointment in <strong>{upcomingAlerts[0].minsUntil} min</strong> ‚Äî {upcomingAlerts[0].leadName} ¬∑ {upcomingAlerts[0].timeStr}
                                        </span>
                                    ) : (
                                        <span className="text-sm font-semibold">
                                            <strong>{upcomingAlerts.length} appointments</strong> starting within the next hour!
                                            {' '}{upcomingAlerts.map(a => a.leadName).join(', ')}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <div className="flex items-center gap-2 flex-shrink-0">
                                <button
                                    onClick={() => navigateTo('appointments')}
                                    className="text-xs bg-white text-red-600 font-semibold px-3 py-1 rounded-full hover:bg-red-50 transition-colors"
                                >View</button>
                                <button
                                    onClick={() => setUpcomingAlerts([])}
                                    className="text-white/80 hover:text-white text-xl leading-none px-1"
                                    title="Dismiss"
                                >√ó</button>
                            </div>
                        </div>
                    )}

                    {currentView === 'inbox-hub' ? (
                        <div className="flex-1 overflow-hidden">
                            <CommandCenterView token={token} isDemoMode={isDemoMode} darkMode={darkMode} toastNotifications={toastNotifications} addToastNotification={addToastNotification} unreadLeadIds={unreadLeadIds} setUnreadLeadIds={setUnreadLeadIds} onNotificationClick={handleNotificationClick} />
                        </div>
                    ) : (
                        <main className="max-w-7xl mx-auto px-4 py-8">
                            {currentView === 'dashboard' && <Dashboard token={token} isDemoMode={isDemoMode} darkMode={darkMode} onNavigate={setCurrentView} />}
                            {currentView === 'sequences' && <SequencesView token={token} isDemoMode={isDemoMode} darkMode={darkMode} />}
                            {currentView === 'templates' && <TemplatesView token={token} isDemoMode={isDemoMode} darkMode={darkMode} />}
                            {currentView === 'appointments' && <AppointmentsView token={token} isDemoMode={isDemoMode} darkMode={darkMode} />}
                            {currentView === 'settings' && <SettingsView token={token} isDemoMode={isDemoMode} darkMode={darkMode} onEmailConnected={fetchConnectedEmail} />}
                            {currentView === 'billing' && <BillingView token={token} isDemoMode={isDemoMode} darkMode={darkMode} billingStatus={billingStatus} onRefresh={fetchBillingStatus} />}
                        </main>
                    )}

                    {/* Toast Notifications Container - Bottom Right Corner */}
                    <div className="fixed bottom-4 right-4 z-50 space-y-3 pointer-events-none">
                        {toastNotifications.map(toast => (
                            <div
                                key={toast.id}
                                className={`bg-white dark:bg-gray-800 rounded-lg shadow-2xl border-l-4 ${
                                    toast.type === 'appointment_reminder'
                                        ? (toast.urgent ? 'border-red-500' : 'border-orange-400')
                                        : 'border-blue-500'
                                } p-4 max-w-sm pointer-events-auto animate-slideIn hover:shadow-lg transition-shadow`}
                            >
                                <div className="flex items-start gap-3">
                                    <div className="text-2xl flex-shrink-0">{toast.emoji}</div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-semibold text-gray-900 dark:text-white truncate">
                                            {toast.lead_name}
                                        </h4>
                                        {toast.lead_company && (
                                            <p className="text-xs text-gray-600 dark:text-gray-400 truncate">
                                                {toast.lead_company}
                                            </p>
                                        )}
                                        {toast.type === 'appointment_reminder' ? (
                                            <>
                                                <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{toast.body}</p>
                                                <button onClick={() => navigateTo('appointments')} className="inline-block text-xs mt-2 px-3 py-1 bg-blue-500 text-white rounded font-medium hover:bg-blue-600 transition-colors cursor-pointer">View Appointment ‚Üí</button>
                                            </>
                                        ) : (
                                            <>
                                                <p className="text-sm font-medium text-gray-700 dark:text-gray-200 mt-1 truncate">
                                                    üìß {toast.subject}
                                                </p>
                                                <p className="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2">
                                                    {toast.body}
                                                </p>
                                                <div className="mt-2 flex items-center justify-between">
                                                    <span className={`inline-block px-2 py-1 text-xs rounded-full font-medium ${
                                                        toast.intent === 'INTERESTED' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' :
                                                        toast.intent === 'OBJECTION' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' :
                                                        toast.intent === 'NOT_NOW' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' :
                                                        toast.intent === 'DEAD' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' :
                                                        toast.intent === 'GHOSTING' ? 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' :
                                                        'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                                                    }`}>
                                                        {toast.intent || 'NEW'}
                                                    </span>
                                                    <button onClick={() => handleNotificationClick(toast.lead_id)} className="text-xs px-2 py-1 bg-blue-500 text-white rounded font-medium hover:bg-blue-600 transition-colors cursor-pointer">View Email ‚Üí</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                                {/* Progress bar for auto-dismiss */}
                                <div className="mt-2 h-0.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div className={`h-full ${
                                        toast.type === 'appointment_reminder' && toast.urgent ? 'bg-red-500' :
                                        toast.type === 'appointment_reminder' ? 'bg-orange-400' : 'bg-blue-500'
                                    } rounded-full animate-shrink`}></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Auth Screen
        function AuthScreen({ onLogin, connectionStatus, onEnableDemoMode, isDemoMode }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [companyName, setCompanyName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // If offline, show error and suggest demo mode
                if (connectionStatus === 'offline' || connectionStatus === 'error') {
                    setError('Cannot connect to backend server. Click "Try Demo Mode" below.');
                    return;
                }

                setError('');
                setLoading(true);

                try {
                    const endpoint = isLogin ? '/auth/login' : '/auth/register';
                    const body = isLogin 
                        ? { email, password }
                        : { email, password, company_name: companyName };

                    const response = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        onLogin(data.token, data.user);
                    } else {
                        setError(data.error || 'Authentication failed');
                    }
                } catch (error) {
                    setError('Network error. Backend server is not running.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div className="bg-white p-8 rounded-lg shadow-lg w-96">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-blue-600 mb-2">
                                ü•á ZeroTouch Mail AI
                            </h1>
                            <p className="text-gray-600">
                                {isLogin ? 'Welcome back!' : 'Create your account'}
                            </p>
                        </div>

                        {/* Connection Status */}
                        {connectionStatus !== 'connected' && connectionStatus !== 'checking' && (
                            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p className="text-sm text-yellow-800 mb-2">
                                    ‚ö†Ô∏è Backend server is offline
                                </p>
                                <button
                                    onClick={onEnableDemoMode}
                                    className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"
                                >
                                    Try Demo Mode
                                </button>
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="you@company.com"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Password
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                />
                            </div>

                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Company Name
                                    </label>
                                    <input
                                        type="text"
                                        value={companyName}
                                        onChange={(e) => setCompanyName(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Acme Inc"
                                    />
                                </div>
                            )}

                            {error && (
                                <div className="bg-red-50 text-red-600 px-3 py-2 rounded text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading || connectionStatus === 'offline'}
                                className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium"
                            >
                                {loading ? 'Please wait...' : (isLogin ? 'Login' : 'Sign Up')}
                            </button>
                        </form>

                        <div className="mt-4 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-sm text-blue-600 hover:text-blue-700"
                            >
                                {isLogin ? "Don't have an account? Sign up" : 'Already have an account? Login'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Dashboard Component
        function Dashboard({ token, isDemoMode, onNavigate }) {
            const [analytics, setAnalytics] = useState(null);
            const [loading, setLoading] = useState(true);
            const [dateRange, setDateRange] = useState('30'); // days
            const [composeModal, setComposeModal] = useState({ isOpen: false, lead: null });
            const [outcomeModal, setOutcomeModal] = useState({ isOpen: false, appointment: null });

            useEffect(() => {
                fetchAnalytics();
            }, [dateRange]);

            const fetchAnalytics = async () => {
                if (isDemoMode) {
                    setTimeout(() => {
                        setAnalytics(DEMO_DATA.analytics);
                        setLoading(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/analytics/dashboard?days=${dateRange}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    setAnalytics(data);
                } catch (error) {
                    console.error('Error fetching analytics:', error);
                    setAnalytics(DEMO_DATA.analytics);
                } finally {
                    setLoading(false);
                }
            };

            const markOutcome = async (appointmentId, outcome) => {
                try {
                    const resp = await fetch(`${API_URL}/api/appointments/${appointmentId}/outcome`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ outcome })
                    });
                    if (!resp.ok) { const e = await resp.json(); throw new Error(e.error); }
                    setOutcomeModal({ isOpen: false, appointment: null });
                    fetchAnalytics();
                } catch (e) {
                    alert('Failed to mark outcome: ' + e.message);
                }
            };

            const cancelAppointment = async (appointmentId) => {
                if (!confirm('Cancel this appointment?')) return;
                try {
                    await fetch(`${API_URL}/api/appointments/${appointmentId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    fetchAnalytics();
                } catch (e) {
                    alert('Failed to cancel appointment: ' + e.message);
                }
            };

            if (loading) return <div className="text-center py-8">Loading...</div>;
            if (!analytics) return <div className="text-center py-8">No data available</div>;

            const recoveredLeads = analytics.overview.recovered_this_month || 0;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Analytics Dashboard</h2>
                        <select 
                            value={dateRange}
                            onChange={(e) => setDateRange(e.target.value)}
                            className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                        >
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <KPICard
                            title="Total Leads"
                            value={analytics.overview.total_leads}
                            icon="üë•"
                        />
                        <KPICard
                            title="Recovered This Month"
                            value={recoveredLeads}
                            icon="üîÑ"
                            highlight={true}
                            tooltip="Leads that moved from Ghosting or Dead status to Interested status this month"
                        />
                    </div>

                    {/* Manual vs AI Mode Comparison */}
                    {analytics.mode_comparison && (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                            <h3 className="text-lg font-semibold mb-4 dark:text-white">Manual vs AI Mode</h3>
                            {(() => {
                                const manual = analytics.mode_comparison.manual;
                                const ai = analytics.mode_comparison.ai;
                                const metrics = [
                                    { label: 'Emails Sent', manual: manual.sent, ai: ai.sent, icon: 'üì§' },
                                    { label: 'Leads Contacted', manual: manual.leads_contacted, ai: ai.leads_contacted, icon: 'üë•' },
                                    { label: 'Replies Received', manual: manual.replies, ai: ai.replies, icon: 'üí¨' },
                                    { label: 'Reply Rate', manual: `${manual.reply_rate}%`, ai: `${ai.reply_rate}%`, manualRaw: manual.reply_rate, aiRaw: ai.reply_rate, icon: 'üìß', isRate: true }
                                ];
                                return (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Headers */}
                                        <div className="hidden md:grid grid-cols-3 gap-4 col-span-2 pb-2 border-b dark:border-gray-700">
                                            <div className="text-sm font-medium text-gray-500 dark:text-gray-400"></div>
                                            <div className="text-center">
                                                <span className="text-sm font-semibold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-full">‚úã Manual Mode</span>
                                            </div>
                                            <div className="text-center">
                                                <span className="text-sm font-semibold text-purple-600 bg-purple-50 dark:bg-purple-900/30 px-3 py-1 rounded-full">ü§ñ AI Mode</span>
                                            </div>
                                        </div>
                                        {/* Metric rows */}
                                        <div className="col-span-2 space-y-3">
                                            {metrics.map((m, idx) => {
                                                const manualVal = m.manualRaw ?? (typeof m.manual === 'number' ? m.manual : 0);
                                                const aiVal = m.aiRaw ?? (typeof m.ai === 'number' ? m.ai : 0);
                                                const winner = manualVal > aiVal ? 'manual' : aiVal > manualVal ? 'ai' : 'tie';
                                                return (
                                                    <div key={idx} className="grid grid-cols-3 gap-4 items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-900 transition">
                                                        <div className="flex items-center">
                                                            <span className="text-xl mr-2">{m.icon}</span>
                                                            <span className="text-sm font-medium text-gray-700 dark:text-gray-300">{m.label}</span>
                                                        </div>
                                                        <div className={`text-center text-lg font-bold ${winner === 'manual' ? 'text-blue-600' : 'text-gray-600 dark:text-gray-400'}`}>
                                                            {m.manual}
                                                            {winner === 'manual' && <span className="ml-1 text-xs text-green-500">&#9650;</span>}
                                                        </div>
                                                        <div className={`text-center text-lg font-bold ${winner === 'ai' ? 'text-purple-600' : 'text-gray-600 dark:text-gray-400'}`}>
                                                            {m.ai}
                                                            {winner === 'ai' && <span className="ml-1 text-xs text-green-500">&#9650;</span>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* AI Intent Analysis - full width, 5 cols grid */}
                    <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                        <h3 className="text-lg font-semibold mb-4 dark:text-white">AI Intent Analysis</h3>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                            {[
                                { key: 'INTERESTED', label: 'Interested', sub: 'Ready to buy', icon: 'üî•', bg: 'bg-red-50 dark:bg-red-900/30', text: 'text-red-600' },
                                { key: 'NOT_NOW', label: 'Not Now', sub: 'Follow up later', icon: '‚è∞', bg: 'bg-yellow-50 dark:bg-yellow-900/30', text: 'text-yellow-600' },
                                { key: 'GHOSTING', label: 'Ghosting', sub: 'No response', icon: 'üëª', bg: 'bg-gray-50 dark:bg-gray-900', text: 'text-gray-600 dark:text-gray-300' },
                                { key: 'OBJECTION', label: 'Objection', sub: 'Has concerns', icon: 'üõë', bg: 'bg-orange-50 dark:bg-orange-900/30', text: 'text-orange-600' },
                                { key: 'DEAD', label: 'Dead', sub: 'Lost leads', icon: 'üíÄ', bg: 'bg-gray-100 dark:bg-gray-800', text: 'text-gray-500' }
                            ].map(item => (
                                <div key={item.key} className={`${item.bg} rounded-lg p-4 text-center`}>
                                    <div className="text-3xl mb-2">{item.icon}</div>
                                    <div className={`text-2xl font-bold ${item.text}`}>
                                        {analytics.intent_distribution?.[item.key] || 0}
                                    </div>
                                    <div className="font-medium text-sm dark:text-white mt-1">{item.label}</div>
                                    <div className="text-xs text-gray-500 dark:text-gray-400">{item.sub}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Hot Leads */}
                    {analytics.hot_leads && analytics.hot_leads.length > 0 && (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                            <h3 className="text-lg font-semibold mb-4 dark:text-white">üî• Hot Leads - Take Action Now!</h3>
                            <div className="space-y-3">
                                {analytics.hot_leads.map(lead => (
                                    <div key={lead.id} className="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/30 dark:to-orange-900/30 rounded-lg border-l-4 border-red-500">
                                        <div>
                                            <p className="font-medium text-gray-900 dark:text-white">{lead.first_name} {lead.last_name}</p>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">{lead.company || lead.email}</p>
                                            <p className="text-xs text-red-500 font-medium mt-1">Replied with interest ‚Äî needs next step</p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300 px-3 py-1 rounded-full font-medium">
                                                Interested!
                                            </span>
                                            <button
                                                onClick={() => setComposeModal({ isOpen: true, lead })}
                                                className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium cursor-pointer"
                                            >
                                                Email
                                            </button>
                                            <span className="text-xs text-gray-400 dark:text-gray-500 italic px-2">AI auto-books appointments from replies</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Upcoming Appointments ‚Äî summary card */}
                    {analytics.upcoming_appointments && analytics.upcoming_appointments.length > 0 && (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold dark:text-white">üìÖ Upcoming Appointments</h3>
                                <button
                                    onClick={() => onNavigate('appointments')}
                                    className="text-sm text-blue-600 dark:text-blue-400 hover:underline font-medium"
                                >
                                    View all ‚Üí
                                </button>
                            </div>
                            <div className="space-y-2">
                                {analytics.upcoming_appointments.slice(0, 3).map(apt => {
                                    const aptDate = apt.date && apt.time ? parseLocalDateTime(apt.date, apt.time) : null;
                                    const isPast = aptDate && aptDate < new Date();
                                    const leadName = apt.lead ? `${apt.lead.first_name || ''} ${apt.lead.last_name || ''}`.trim() || apt.lead.email : 'Unknown';
                                    const typeLabel = { call: 'Call', meeting: 'Meeting', video_call: 'Video Call', property_showing: 'Showing', demo: 'Demo', other: 'Appointment' };
                                    return (
                                        <div key={apt.id} className={`flex items-center justify-between px-4 py-3 rounded-lg border-l-4 ${isPast ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-400' : 'bg-green-50 dark:bg-green-900/20 border-green-500'}`}>
                                            <div>
                                                <p className="font-medium text-sm text-gray-900 dark:text-white">{leadName}</p>
                                                <p className="text-xs text-gray-500 dark:text-gray-400">
                                                    {apt.date} {apt.time && `at ${apt.time}`} ¬∑ {typeLabel[apt.appointment_type] || 'Appointment'}
                                                    {apt.source === 'ai_detected' && <span className="ml-1 text-purple-500">¬∑ ü§ñ AI</span>}
                                                </p>
                                            </div>
                                            {isPast && (
                                                <button
                                                    onClick={() => setOutcomeModal({ isOpen: true, appointment: apt })}
                                                    className="text-xs px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700"
                                                >Mark Outcome</button>
                                            )}
                                        </div>
                                    );
                                })}
                                {analytics.upcoming_appointments.length > 3 && (
                                    <p className="text-xs text-gray-400 dark:text-gray-500 text-center pt-1">
                                        +{analytics.upcoming_appointments.length - 3} more ‚Äî{' '}
                                        <button onClick={() => onNavigate('appointments')} className="text-blue-500 hover:underline">see all</button>
                                    </p>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Sequence Step Performance */}
                    {analytics.sequences && analytics.sequences.length > 0 && (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                            <h3 className="text-lg font-semibold dark:text-white">üìß Sequence Step Performance</h3>
                            <SequencePerformance sequences={analytics.sequences} onNavigate={onNavigate} />
                        </div>
                    )}

                    {/* Compose Modal */}
                    {composeModal.isOpen && composeModal.lead && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-900 rounded-lg shadow-2xl max-w-2xl w-full max-h-90vh overflow-y-auto">
                                <div className="sticky top-0 bg-white dark:bg-gray-900 border-b dark:border-gray-700 p-4 flex justify-between items-center">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-900 dark:text-white">Contact {composeModal.lead.first_name} {composeModal.lead.last_name}</h3>
                                        <p className="text-sm text-gray-600 dark:text-gray-400">{composeModal.lead.email}</p>
                                    </div>
                                    <button
                                        onClick={() => setComposeModal({ isOpen: false, lead: null })}
                                        className="text-2xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                                    >
                                        √ó
                                    </button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                                        <input
                                            type="text"
                                            placeholder="Enter email subject"
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message</label>
                                        <textarea
                                            placeholder="Write your message here..."
                                            rows="10"
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                        ></textarea>
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button
                                            onClick={() => setComposeModal({ isOpen: false, lead: null })}
                                            className="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                        >
                                            Send Email
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Mark Outcome Modal */}
                    {outcomeModal.isOpen && outcomeModal.appointment && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-900 rounded-lg shadow-2xl max-w-md w-full mx-4">
                                <div className="border-b dark:border-gray-700 p-4 flex justify-between items-center">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-900 dark:text-white">How did the call go?</h3>
                                        <p className="text-sm text-gray-500 dark:text-gray-400">
                                            {outcomeModal.appointment.lead ? `${outcomeModal.appointment.lead.first_name} ${outcomeModal.appointment.lead.last_name}` : ''} ¬∑ {outcomeModal.appointment.date} {outcomeModal.appointment.time}
                                        </p>
                                    </div>
                                    <button onClick={() => setOutcomeModal({ isOpen: false, appointment: null })} className="text-2xl text-gray-500 hover:text-gray-900 dark:hover:text-white cursor-pointer">√ó</button>
                                </div>
                                <div className="p-6 space-y-3">
                                    <button
                                        onClick={() => markOutcome(outcomeModal.appointment.id, 'won')}
                                        className="w-full flex items-center gap-3 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50 cursor-pointer text-left"
                                    >
                                        <span className="text-2xl">üéâ</span>
                                        <div>
                                            <p className="font-semibold text-green-800 dark:text-green-300">Won!</p>
                                            <p className="text-xs text-green-600 dark:text-green-400">Lead converts. System sends welcome email.</p>
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => markOutcome(outcomeModal.appointment.id, 'needs_more_time')}
                                        className="w-full flex items-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 cursor-pointer text-left"
                                    >
                                        <span className="text-2xl">‚è∞</span>
                                        <div>
                                            <p className="font-semibold text-blue-800 dark:text-blue-300">Needs More Time</p>
                                            <p className="text-xs text-blue-600 dark:text-blue-400">Sends a warm follow-up email, re-enters nurture in 7 days.</p>
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => markOutcome(outcomeModal.appointment.id, 'no_show')}
                                        className="w-full flex items-center gap-3 p-4 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50 cursor-pointer text-left"
                                    >
                                        <span className="text-2xl">üìû</span>
                                        <div>
                                            <p className="font-semibold text-yellow-800 dark:text-yellow-300">No-Show</p>
                                            <p className="text-xs text-yellow-600 dark:text-yellow-400">Sends a reschedule email to the lead automatically.</p>
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => markOutcome(outcomeModal.appointment.id, 'not_a_fit')}
                                        className="w-full flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-left"
                                    >
                                        <span className="text-2xl">‚ùå</span>
                                        <div>
                                            <p className="font-semibold text-gray-700 dark:text-gray-300">Not a Fit</p>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">Marks lead as dead. No more emails sent.</p>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function SequencePerformance({ sequences, onNavigate }) {
            const [showAll, setShowAll] = React.useState(false);
            const DISPLAY_LIMIT = 10;

            // Sort by reply rate descending ‚Äî best performing steps appear first.
            // Steps with 0 sent go to the bottom (rate treated as -1 so they sort last).
            const sorted = [...sequences].sort((a, b) => {
                const rateA = a.sent > 0 ? a.replies / a.sent : -1;
                const rateB = b.sent > 0 ? b.replies / b.sent : -1;
                return rateB - rateA;
            });

            // Rank top-3 by reply rate using a unique key: sequence_id + '_' + step.
            // Using only step.step (e.g. 1, 2, 3) as the key causes collisions when
            // multiple sequences all have a "Step 1" ‚Äî Object.fromEntries keeps only
            // the last entry for each duplicate key, destroying rank #1.
            const stepsWithSends = sorted.filter(s => s.sent > 0);
            const rankMap = {};
            for (let i = 0; i < Math.min(3, stepsWithSends.length); i++) {
                const s = stepsWithSends[i];
                rankMap[`${s.sequence_id}_${s.step}`] = i + 1;
            }
            const bestStep = stepsWithSends[0] || null;

            // "Leads started" = sum of sends across all step-1 entries (one per sequence).
            // Old code used sequences[0].sent which was just whatever came first.
            const totalLeadsStarted = sequences
                .filter(s => s.step === 1)
                .reduce((sum, s) => sum + s.sent, 0);

            // "Total replies" = sum across all steps.
            const totalReplies = sequences.reduce((sum, s) => sum + s.replies, 0);

            // "Overall reply rate" = total replies / total leads that entered any sequence.
            // Old code divided totalReplies by sequences[0].sent ‚Äî wrong denominator.
            const overallReplyRate = totalLeadsStarted > 0
                ? Math.round((totalReplies / totalLeadsStarted) * 100)
                : 0;

            const hasData = sequences.some(s => s.sent > 0);
            const displayedSequences = showAll ? sorted : sorted.slice(0, DISPLAY_LIMIT);
            const hasMore = sorted.length > DISPLAY_LIMIT;

            const rankBadge = (rank) => {
                if (rank === 1) return { emoji: 'ü•á', label: '#1', color: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300' };
                if (rank === 2) return { emoji: 'ü•à', label: '#2', color: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300' };
                if (rank === 3) return { emoji: 'ü•â', label: '#3', color: 'bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300' };
                return null;
            };

            return (
                <div>
                    {/* Steps ‚Äî sorted highest reply rate first */}
                    <div className="space-y-2">
                        {displayedSequences.map((step) => {
                            // Use sequence_id + step number as the unique key.
                            // key={step.step} alone caused duplicate React keys when
                            // multiple sequences all had a Step 1, Step 2, etc.
                            const uniqueKey = `${step.sequence_id}_${step.step}`;
                            const replyRate = step.sent > 0 ? Math.round((step.replies / step.sent) * 100) : 0;

                            // Bar width = reply rate capped at 100%.
                            // Old code used replyRate * 4 which maxed out the bar at 25% reply rate,
                            // making everything above 25% look identical.
                            const replyBarWidth = Math.min(replyRate, 100);

                            const rank = rankMap[uniqueKey];
                            const badge = rankBadge(rank);
                            const isTop1 = rank === 1;

                            const noData = step.sent === 0;
                            const perfColor = noData ? 'bg-gray-300 dark:bg-gray-600' : replyRate >= 5 ? 'bg-green-500' : replyRate >= 2 ? 'bg-yellow-400' : 'bg-red-400';
                            const perfTextColor = noData ? 'text-gray-400 dark:text-gray-500' : replyRate >= 5 ? 'text-green-700 dark:text-green-400' : replyRate >= 2 ? 'text-yellow-700 dark:text-yellow-400' : 'text-red-600 dark:text-red-400';
                            // Old code showed "Low" for 0-sent steps ‚Äî show "No data" instead.
                            const perfLabel = noData ? 'No data' : replyRate >= 5 ? 'Good' : replyRate >= 2 ? 'Average' : 'Low';

                            const handleStepClick = () => {
                                if (onNavigate && step.sequence_id != null) {
                                    // Store the target sequence ID so SequencesView can auto-open it
                                    localStorage.setItem('open-sequence-from-dashboard', String(step.sequence_id));
                                    onNavigate('sequences');
                                }
                            };

                            return (
                                <div key={uniqueKey}>
                                    <div
                                        onClick={handleStepClick}
                                        className={`rounded-lg border-2 p-4 ${onNavigate ? 'cursor-pointer hover:border-blue-400 dark:hover:border-blue-500' : ''} ${isTop1 && hasData ? 'border-green-400 dark:border-green-600 bg-green-50 dark:bg-green-900/10' : 'border-gray-200 dark:border-gray-700'}`}
                                    >
                                        <div className="flex items-center justify-between mb-1">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white text-xs font-bold whitespace-nowrap">Step {step.step}</span>
                                                <span className="font-semibold text-gray-900 dark:text-white">{step.name}</span>
                                                {badge && (
                                                    <span className={`text-xs px-2 py-0.5 rounded font-semibold ${badge.color}`}>{badge.emoji} {badge.label}</span>
                                                )}
                                            </div>
                                            <div className="text-right">
                                                <span className="text-sm text-gray-500 dark:text-gray-400">{step.sent} sent ¬∑ </span>
                                                <span className="text-sm font-bold text-gray-700 dark:text-gray-200">{step.replies} replied</span>
                                            </div>
                                        </div>
                                        {step.sequence_name && (
                                            <div className="text-xs text-gray-400 dark:text-gray-500 mb-2 ml-1">{step.sequence_name}</div>
                                        )}
                                        <div className="flex items-center gap-3">
                                            <div className="flex-1 bg-gray-100 dark:bg-gray-800 rounded-full h-4 overflow-hidden">
                                                <div
                                                    className={`h-4 rounded-full ${perfColor} transition-all duration-500`}
                                                    style={{width: noData ? '100%' : `${replyBarWidth}%`}}
                                                ></div>
                                            </div>
                                            <div className={`text-sm font-bold w-24 text-right ${perfTextColor}`}>
                                                {noData ? '‚Äî ¬∑ No data' : `${replyRate}% ¬∑ ${perfLabel}`}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Show all / collapse toggle */}
                    {hasMore && (
                        <button
                            onClick={() => setShowAll(!showAll)}
                            className="mt-3 w-full py-2 text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium border border-blue-200 dark:border-blue-800 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                        >
                            {showAll ? 'Show fewer steps ‚Üë' : `Show all ${sequences.length} steps ‚Üì`}
                        </button>
                    )}

                </div>
            );
        }

        // Export Analytics Function
        function KPICard({ title, value, icon, trend, highlight, tooltip }) {
            const [showTooltip, setShowTooltip] = React.useState(false);
            return (
                <div className={`${highlight ? 'bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 border-2 border-green-300 dark:border-green-800' : 'bg-white dark:bg-black border border-gray-300 dark:border-gray-700'} rounded-lg shadow-lg p-6 relative`}>
                    {tooltip && (
                        <div className="absolute top-3 right-3">
                            <div className="relative">
                                <button
                                    onMouseEnter={() => setShowTooltip(true)}
                                    onMouseLeave={() => setShowTooltip(false)}
                                    className="text-xs w-5 h-5 rounded-full bg-gray-400 dark:bg-gray-600 text-white flex items-center justify-center font-bold hover:bg-gray-500 dark:hover:bg-gray-500"
                                >
                                    i
                                </button>
                                {showTooltip && (
                                    <div className="absolute top-8 right-0 w-56 bg-gray-900 dark:bg-gray-800 text-white text-xs rounded p-3 z-50 pointer-events-none shadow-lg">
                                        {tooltip}
                                        <div className="absolute -top-1 right-4 border-4 border-transparent border-b-gray-900 dark:border-b-gray-800"></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">{title}</p>
                            <p className="text-3xl font-bold mt-2 text-gray-900 dark:text-white">{value}</p>
                            {trend && (
                                <p className="text-xs text-green-600 dark:text-green-400 mt-1 font-medium">{trend}</p>
                            )}
                        </div>
                        <div className="text-4xl">{icon}</div>
                    </div>
                </div>
            );
        }

        // Leads View Component
        function LeadsView({ token, isDemoMode }) {
            const [leads, setLeads] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [showBulkImport, setShowBulkImport] = useState(false);
            const [showAIAnalysis, setShowAIAnalysis] = useState(false);
            const [selectedLead, setSelectedLead] = useState(null);
            const [replyText, setReplyText] = useState('');
            const [aiResult, setAiResult] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [loading, setLoading] = useState(true);

            // Send Email Modal States
            const [showSendEmail, setShowSendEmail] = useState(false);
            const [emailMode, setEmailMode] = useState(null); // 'manual' or 'ai'
            const [emailSubject, setEmailSubject] = useState('');
            const [emailBody, setEmailBody] = useState('');

            // Guided Email Template Fields
            const [emailGreeting, setEmailGreeting] = useState('');
            const [emailContext, setEmailContext] = useState('');
            const [emailMainMessage, setEmailMainMessage] = useState('');
            const [emailCallToAction, setEmailCallToAction] = useState('');
            const [emailSignature, setEmailSignature] = useState('');
            const [generatingAIContent, setGeneratingAIContent] = useState(false);
            const [generatingEmail, setGeneratingEmail] = useState(false);
            const [sendingEmail, setSendingEmail] = useState(false);
            const [writeMode, setWriteMode] = useState(null); // 'blank' or 'template'
            const [polishingField, setPolishingField] = useState(null); // which field is currently being polished

            // Rich Text Editor States
            const [emailHtmlBody, setEmailHtmlBody] = useState('');
            const [emailAttachments, setEmailAttachments] = useState([]);
            const [richTextFields, setRichTextFields] = useState({
                context: false,
                mainMessage: false,
                callToAction: false
            });

            // User settings for auto-fill
            const [userFromName, setUserFromName] = useState('');
            const [connectedEmail, setConnectedEmail] = useState(null);

            // Intent Filter State
            const [intentFilter, setIntentFilter] = useState('ALL');
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                fetchLeads();
                fetchUserSettings();

                // Auto-refresh leads every 10 seconds to pick up intent/status changes from background email checks
                const interval = setInterval(() => {
                    fetchLeads();
                }, 10000);

                return () => clearInterval(interval);
            }, []);

            const fetchUserSettings = async () => {
                if (isDemoMode) {
                    setUserFromName('Demo Company');
                    setConnectedEmail('demo@example.com');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/settings/email`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setUserFromName(data.from_name || '');
                        if (data.email && data.provider === 'gmail') {
                            setConnectedEmail(data.email);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user settings:', error);
                }
            };

            const fetchLeads = async () => {
                if (isDemoMode) {
                    setTimeout(() => {
                        setLeads(DEMO_DATA.leads);
                        setLoading(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/leads`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    setLeads(data.leads);
                    // Sync selected lead with fresh data so the preview reflects the latest intent/status
                    setSelectedLead(prev => {
                        if (!prev) return prev;
                        const updated = data.leads.find(l => l.id === prev.id);
                        return updated || prev;
                    });
                } catch (error) {
                    console.error('Error fetching leads:', error);
                    setLeads(DEMO_DATA.leads);
                } finally {
                    setLoading(false);
                }
            };

            const addLead = async (leadData) => {
                if (isDemoMode) {
                    const newLead = {
                        id: leads.length + 1,
                        ...leadData,
                        status: 'new',
                        ai_intent: null
                    };
                    setLeads([...leads, newLead]);
                    setShowAddForm(false);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/leads`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(leadData)
                    });
                    
                    if (response.ok) {
                        fetchLeads();
                        setShowAddForm(false);
                    }
                } catch (error) {
                    console.error('Error adding lead:', error);
                }
            };

            const bulkImportLeads = async (leadsArray) => {
                if (isDemoMode) {
                    const newLeads = leadsArray.map((lead, index) => ({
                        id: leads.length + index + 1,
                        ...lead,
                        status: 'new',
                        ai_intent: null
                    }));
                    setLeads([...leads, ...newLeads]);
                    setShowBulkImport(false);
                    return { success: newLeads.length, failed: 0 };
                }

                try {
                    const response = await fetch(`${API_URL}/leads/bulk`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ leads: leadsArray })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        fetchLeads();
                        setShowBulkImport(false);
                        return data;
                    }
                    return { success: 0, failed: leadsArray.length };
                } catch (error) {
                    console.error('Error bulk importing:', error);
                    return { success: 0, failed: leadsArray.length };
                }
            };

            const analyzeReply = async () => {
                if (!replyText.trim()) return;
                
                setAnalyzing(true);
                setAiResult(null);
                
                if (isDemoMode) {
                    // Demo mode simulation
                    setTimeout(() => {
                        const demoIntents = ['INTERESTED', 'NOT_NOW', 'OBJECTION', 'GHOSTING'];
                        const randomIntent = demoIntents[Math.floor(Math.random() * demoIntents.length)];
                        
                        const recommendations = {
                            'INTERESTED': 'üî• HOT LEAD! Contact them immediately - they want to buy!',
                            'NOT_NOW': '‚è∞ Follow up in 2-4 weeks. Set a reminder.',
                            'OBJECTION': 'üí° Send case study or testimonial addressing their concern.',
                            'GHOSTING': 'üëª Try a different approach - change subject line or angle.'
                        };
                        
                        const reasoning = {
                            'INTERESTED': 'Reply shows positive engagement and buying signals',
                            'NOT_NOW': 'Lead indicates timing is not right currently',
                            'OBJECTION': 'Reply raises concerns or questions about the offer',
                            'GHOSTING': 'Generic or delayed response with low engagement'
                        };
                        
                        setAiResult({
                            ai_intent: randomIntent,
                            ai_reasoning: reasoning[randomIntent],
                            recommendation: recommendations[randomIntent]
                        });
                        
                        // Update lead in demo mode
                        const updatedLeads = leads.map(l =>
                            l.id === selectedLead.id
                                ? { ...l, ai_intent: randomIntent, status: randomIntent === 'INTERESTED' ? 'interested' : (randomIntent === 'DEAD' ? 'dead' : 'analyzed') }
                                : l
                        );
                        setLeads(updatedLeads);
                        setAnalyzing(false);
                    }, 1500);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/leads/${selectedLead.id}/analyze-reply`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reply_text: replyText })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        setAiResult(data);
                        fetchLeads(); // Refresh leads to show updated status
                    }
                } catch (error) {
                    console.error('Error analyzing reply:', error);
                } finally {
                    setAnalyzing(false);
                }
            };

            const generateEmail = async () => {
                if (!selectedLead) return;

                setGeneratingEmail(true);

                if (isDemoMode) {
                    setTimeout(() => {
                        const demoBody = `Hi ${selectedLead.first_name},\n\nI noticed your work at ${selectedLead.company || 'your company'} and wanted to reach out.\n\nWe help businesses like yours improve their lead recovery and customer engagement. I'd love to share some insights that might be valuable for your team.\n\nWould you be open to a quick 15-minute call this week?\n\nBest regards`;
                        setEmailSubject(`Quick question about ${selectedLead.company || 'your business'}`);
                        setEmailBody(demoBody);
                        setEmailHtmlBody(demoBody.replace(/\n/g, '<br>'));
                        setEmailMode('ai');
                        setGeneratingEmail(false);
                    }, 1000);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/leads/${selectedLead.id}/generate-initial-email`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setEmailSubject(`Quick question about ${selectedLead.company || 'your business'}`);
                        setEmailBody(data.email_body);
                        setEmailHtmlBody(data.email_body.replace(/\n/g, '<br>'));
                        setEmailMode('ai');
                    }
                } catch (error) {
                    console.error('Error generating email:', error);
                    alert('Failed to generate email. Please try writing it yourself.');
                } finally {
                    setGeneratingEmail(false);
                }
            };

            // AI Power - Generate only main content fields (context, main message, CTA)
            const generateAIContent = async () => {
                if (!selectedLead) return;

                setGeneratingAIContent(true);

                if (isDemoMode) {
                    setTimeout(() => {
                        setEmailContext(`I noticed your work at ${selectedLead.company || 'your company'} and wanted to reach out about a solution that might help.`);
                        setEmailMainMessage(`We help businesses like yours improve their lead recovery and customer engagement. Many companies similar to ${selectedLead.company || 'yours'} have seen impressive results:\n\n‚Ä¢ 35% increase in response rates\n‚Ä¢ 2x faster lead conversion\n‚Ä¢ Automated follow-ups that feel personal\n\nI believe this could be valuable for your team.`);
                        setEmailCallToAction(`Would you be open to a quick 15-minute call this week to discuss how this could work for ${selectedLead.company || 'your company'}?`);
                        setGeneratingAIContent(false);
                    }, 1500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/leads/${selectedLead.id}/generate-email-content`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            greeting: emailGreeting,
                            signature: emailSignature
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setEmailContext(data.context || '');
                        setEmailMainMessage(data.main_message || '');
                        setEmailCallToAction(data.call_to_action || '');
                    } else {
                        alert('Failed to generate content. Please try again.');
                    }
                } catch (error) {
                    console.error('Error generating AI content:', error);
                    alert('Failed to generate content. Please check your connection.');
                } finally {
                    setGeneratingAIContent(false);
                }
            };

            // Polish / Enhance any email field or full body with AI
            const polishWithAI = async (content, fieldType, setter, htmlSetter) => {
                if (!content || !content.trim() || !selectedLead) return;

                setPolishingField(fieldType);

                if (isDemoMode) {
                    setTimeout(() => {
                        setter(content + '\n\n[Polished for clarity and impact ‚Äî upgrade to see AI changes]');
                        if (htmlSetter) htmlSetter((content + '\n\n[Polished for clarity and impact ‚Äî upgrade to see AI changes]').replace(/\n/g, '<br>'));
                        setPolishingField(null);
                    }, 1200);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/leads/${selectedLead.id}/polish-email`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content, field_type: fieldType })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setter(data.polished_content);
                        if (htmlSetter) htmlSetter(data.polished_content.replace(/\n/g, '<br>'));
                    } else {
                        const err = await response.json().catch(() => ({}));
                        alert(err.message || 'Failed to polish content. Please try again.');
                    }
                } catch (error) {
                    console.error('Error polishing content:', error);
                    alert('Failed to polish content. Check your connection.');
                } finally {
                    setPolishingField(null);
                }
            };

            const sendEmail = async () => {
                // Check if using guided template or blank email mode
                const usingTemplate = emailMode === 'ai-power' || writeMode === 'template';

                let finalEmailBody = emailBody;
                let finalHtmlBody = emailHtmlBody;

                if (usingTemplate) {
                    // Construct email from template fields
                    const parts = [];
                    if (emailGreeting.trim()) parts.push(emailGreeting.trim());
                    if (emailContext.trim()) parts.push(emailContext.trim());
                    if (emailMainMessage.trim()) parts.push(emailMainMessage.trim());
                    if (emailCallToAction.trim()) parts.push(emailCallToAction.trim());
                    if (emailSignature.trim()) parts.push(emailSignature.trim());

                    finalEmailBody = parts.join('\n\n');
                    // Convert to HTML for template mode (simple conversion)
                    finalHtmlBody = parts.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
                }

                if (!finalEmailBody.trim() && !finalHtmlBody.trim()) {
                    alert('Please write an email message');
                    return;
                }

                // Validate total attachment size (40MB limit)
                const totalSize = emailAttachments.reduce((sum, att) => sum + (att.size || 0), 0);
                if (totalSize > 40 * 1024 * 1024) {
                    alert(`Total attachment size (${(totalSize / 1024 / 1024).toFixed(2)}MB) exceeds 40MB limit`);
                    return;
                }

                setSendingEmail(true);

                if (isDemoMode) {
                    setTimeout(() => {
                        const updatedLeads = leads.map(l =>
                            l.id === selectedLead.id
                                ? { ...l, status: 'contacted', initial_email_sent: true }
                                : l
                        );
                        setLeads(updatedLeads);
                        setSendingEmail(false);
                        setShowSendEmail(false);
                        setEmailMode(null);
                        setEmailSubject('');
                        setEmailBody('');
                        setEmailHtmlBody('');
                        setEmailAttachments([]);
                        setEmailGreeting('');
                        setEmailContext('');
                        setEmailMainMessage('');
                        setEmailCallToAction('');
                        setEmailSignature('');
                        alert('Email sent successfully!');
                    }, 1000);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/leads/${selectedLead.id}/send-initial-email`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subject: emailSubject,
                            email_body: finalEmailBody,
                            html_body: finalHtmlBody,
                            attachments: emailAttachments
                        })
                    });

                    if (response.ok) {
                        fetchLeads();
                        setShowSendEmail(false);
                        setEmailMode(null);
                        setEmailSubject('');
                        setEmailBody('');
                        setEmailHtmlBody('');
                        setEmailAttachments([]);
                        setEmailGreeting('');
                        setEmailContext('');
                        setEmailMainMessage('');
                        setEmailCallToAction('');
                        setEmailSignature('');
                        alert('Email sent successfully!');
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to send email');
                    }
                } catch (error) {
                    console.error('Error sending email:', error);
                    alert('Failed to send email. Please check your settings.');
                } finally {
                    setSendingEmail(false);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Leads</h2>
                        <div className="flex space-x-3">
                            <button
                                onClick={() => setShowBulkImport(true)}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2"
                            >
                                <span>üìä</span>
                                <span>Import CSV</span>
                            </button>
                        </div>
                    </div>

                    {/* Intent Filter Section */}
                    <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-4">
                        <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Filter by Intent:</h3>
                        <div className="flex flex-wrap gap-2">
                            {[
                                { key: 'ALL', label: 'All Leads', icon: 'üìã', color: 'gray' },
                                { key: 'INTERESTED', label: 'Interested', icon: 'üî•', color: 'green' },
                                { key: 'NOT_NOW', label: 'Not Now', icon: '‚è∞', color: 'yellow' },
                                { key: 'OBJECTION', label: 'Objection', icon: 'üí°', color: 'orange' },
                                { key: 'GHOSTING', label: 'Ghosting', icon: 'üëª', color: 'purple' },
                                { key: 'DEAD', label: 'Dead', icon: '‚ùå', color: 'red' },
                                { key: 'NO_INTENT', label: 'No Intent', icon: '‚ö™', color: 'gray' }
                            ].map(({ key, label, icon, color }) => {
                                const count = key === 'ALL'
                                    ? leads.length
                                    : key === 'NO_INTENT'
                                    ? leads.filter(l => !l.ai_intent).length
                                    : leads.filter(l => l.ai_intent === key).length;

                                const isActive = intentFilter === key;
                                const colorClasses = {
                                    gray: isActive ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300',
                                    green: isActive ? 'bg-green-600 text-white' : 'bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-900 dark:text-green-300',
                                    yellow: isActive ? 'bg-yellow-600 text-white' : 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-300',
                                    orange: isActive ? 'bg-orange-600 text-white' : 'bg-orange-100 text-orange-800 hover:bg-orange-200 dark:bg-orange-900 dark:text-orange-300',
                                    purple: isActive ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-800 hover:bg-purple-200 dark:bg-purple-900 dark:text-purple-300',
                                    red: isActive ? 'bg-red-600 text-white' : 'bg-red-100 text-red-800 hover:bg-red-200 dark:bg-red-900 dark:text-red-300'
                                };

                                return (
                                    <button
                                        key={key}
                                        onClick={() => setIntentFilter(key)}
                                        className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center space-x-2 ${colorClasses[color]}`}
                                    >
                                        <span>{icon}</span>
                                        <span>{label}</span>
                                        <span className={`ml-1 px-2 py-0.5 rounded-full text-xs font-bold ${isActive ? 'bg-white/20' : 'bg-black/10 dark:bg-white/10'}`}>
                                            {count}
                                        </span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Search Bar */}
                    <div className="relative">
                        <span className="absolute inset-y-0 left-3 flex items-center text-gray-400 pointer-events-none">üîç</span>
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="Search by email, name, or company..."
                            className="w-full pl-9 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>

                    {showBulkImport && (
                        <BulkImportForm
                            onImport={bulkImportLeads}
                            onCancel={() => setShowBulkImport(false)}
                        />
                    )}

                    {showAddForm && (
                        <AddLeadForm 
                            onSubmit={addLead}
                            onCancel={() => setShowAddForm(false)}
                        />
                    )}

                    {loading ? (
                        <div className="text-center py-8 text-gray-600 dark:text-gray-400">Loading leads...</div>
                    ) : leads.length === 0 ? (
                        <div className="bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg p-8 text-center">
                            <p className="text-gray-600 dark:text-gray-400 mb-4">No leads yet. Add your first lead!</p>
                        </div>
                    ) : (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg overflow-hidden overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead className="bg-gray-50 dark:bg-gray-900">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Intent</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Attempts</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Next Send</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Auto</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white dark:bg-black divide-y divide-gray-200 dark:divide-gray-700">
                                    {(() => {
                                        const q = searchQuery.trim().toLowerCase();
                                        const filteredLeads = leads.filter(lead => {
                                            const intentMatch = intentFilter === 'ALL' ? true
                                                : intentFilter === 'NO_INTENT' ? !lead.ai_intent
                                                : lead.ai_intent === intentFilter;
                                            if (!intentMatch) return false;
                                            if (!q) return true;
                                            return (
                                                (lead.email || '').toLowerCase().includes(q) ||
                                                (lead.first_name || '').toLowerCase().includes(q) ||
                                                (lead.last_name || '').toLowerCase().includes(q) ||
                                                (lead.company || '').toLowerCase().includes(q)
                                            );
                                        });

                                        if (filteredLeads.length === 0) {
                                            return (
                                                <tr>
                                                    <td colSpan="7" className="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                                        No leads found for this intent filter
                                                    </td>
                                                </tr>
                                            );
                                        }

                                        return filteredLeads.map(lead => (
                                        <tr key={lead.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <td className="px-4 py-4 whitespace-nowrap">
                                                <div className="font-medium text-gray-900 dark:text-white">
                                                    {lead.first_name} {lead.last_name}
                                                </div>
                                                {lead.company && (
                                                    <div className="text-xs text-gray-500 dark:text-gray-400">{lead.company}</div>
                                                )}
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                                                {lead.email}
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap">
                                                <StatusBadge status={lead.status} />
                                                {lead.status === 'customer' && (
                                                    <span className="ml-1 text-green-500">üí∞</span>
                                                )}
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap">
                                                <div className="space-y-1">
                                                    {lead.ai_intent ? (
                                                        <IntentBadge intent={lead.ai_intent} />
                                                    ) : (
                                                        <span className="text-sm text-gray-400 dark:text-gray-500">-</span>
                                                    )}
                                                    {lead.ai_paused_by_human && (
                                                        <span className="ml-1 text-xs px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300" title="AI paused - human replied">‚è∏ Human</span>
                                                    )}
                                                    {lead.objection_subtype && (
                                                        <div className="text-xs text-gray-500 dark:text-gray-400">
                                                            ({lead.objection_subtype.replace('_', ' ')})
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                                                {lead.retry_count || 0}
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap text-xs text-gray-500 dark:text-gray-400">
                                                {lead.next_send_date ? (
                                                    new Date(lead.next_send_date).toLocaleDateString()
                                                ) : (
                                                    <span className="text-gray-400">-</span>
                                                )}
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap">
                                                <label className="flex items-center cursor-pointer">
                                                    <div className="relative">
                                                        <input
                                                            type="checkbox"
                                                            checked={lead.auto_send_enabled !== false && lead.sequence_active !== false}
                                                            onChange={async (e) => {
                                                                if (!isDemoMode) {
                                                                    try {
                                                                        await fetch(`${API_URL}/leads/${lead.id}/auto-send`, {
                                                                            method: 'PATCH',
                                                                            headers: {
                                                                                'Authorization': `Bearer ${token}`,
                                                                                'Content-Type': 'application/json'
                                                                            },
                                                                            body: JSON.stringify({ auto_send_enabled: e.target.checked })
                                                                        });
                                                                        fetchLeads();
                                                                    } catch (error) {
                                                                        console.error('Error toggling auto-send:', error);
                                                                    }
                                                                } else {
                                                                    const updatedLeads = leads.map(l =>
                                                                        l.id === lead.id ? { ...l, auto_send_enabled: e.target.checked } : l
                                                                    );
                                                                    setLeads(updatedLeads);
                                                                }
                                                            }}
                                                            disabled={lead.status === 'customer' || lead.status === 'closed_by_system'}
                                                            className="sr-only peer"
                                                        />
                                                        <div className="w-9 h-5 bg-gray-200 dark:bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600 peer-disabled:opacity-50"></div>
                                                    </div>
                                                </label>
                                            </td>
                                            <td className="px-4 py-4 whitespace-nowrap">
                                                <button
                                                    onClick={() => {
                                                        setSelectedLead(lead);
                                                        setShowSendEmail(true);
                                                        setEmailMode(null);
                                                        setEmailSubject('');
                                                        setEmailBody('');
                                                    }}
                                                    className="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                    title="Send initial email to this lead"
                                                >
                                                    ‚úâÔ∏è Send Email
                                                </button>
                                            </td>
                                        </tr>
                                        ));
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {/* AI Reply Analysis Modal */}
                    {showAIAnalysis && selectedLead && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                                <div className="p-6 border-b">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-xl font-bold">ü§ñ AI Reply Analysis</h3>
                                        <button
                                            onClick={() => setShowAIAnalysis(false)}
                                            className="text-gray-400 hover:text-gray-600 text-2xl"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-2">
                                        Lead: <strong>{selectedLead.first_name} {selectedLead.last_name}</strong> ({selectedLead.email})
                                    </p>
                                    <p className="text-xs text-gray-500 mt-1">
                                        AI will analyze the reply to determine intent (Interested, Not Now, Objection, etc.) and suggest next steps
                                    </p>
                                </div>

                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            üì® Paste the lead's email reply for AI analysis:
                                        </label>
                                        <textarea
                                            value={replyText}
                                            onChange={(e) => setReplyText(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                            rows="6"
                                            placeholder="Example: Thanks for reaching out! I'm interested in learning more..."
                                        />
                                    </div>

                                    <button
                                        onClick={analyzeReply}
                                        disabled={!replyText.trim() || analyzing}
                                        className="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium flex items-center justify-center"
                                    >
                                        {analyzing ? (
                                            <>
                                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Analyzing...
                                            </>
                                        ) : 'üîç Analyze with AI'}
                                    </button>

                                    {aiResult && (
                                        <div className="mt-6 space-y-4 animate-fadeIn">
                                            <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border-2 border-purple-200">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-bold text-lg">Classification:</h4>
                                                    <IntentBadge intent={aiResult.ai_intent} />
                                                </div>

                                                <div className="space-y-3">
                                                    {aiResult.objection_subtype && (
                                                        <div>
                                                            <div className="text-sm font-medium text-gray-700 mb-1">üîç Objection Type:</div>
                                                            <div className="text-sm bg-white p-3 rounded">
                                                                <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                                                                    {aiResult.objection_subtype.replace('_', ' ')}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div>
                                                        <div className="text-sm font-medium text-gray-700 mb-1">üß† Why:</div>
                                                        <div className="text-sm text-gray-600 bg-white p-3 rounded">{aiResult.ai_reasoning}</div>
                                                    </div>

                                                    {aiResult.decision_recommendation && (
                                                        <div>
                                                            <div className="text-sm font-medium text-gray-700 mb-1">‚ö° Decision:</div>
                                                            <div className="text-sm bg-white p-3 rounded">
                                                                <DecisionBadge decision={aiResult.decision_recommendation} />
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div>
                                                        <div className="text-sm font-medium text-gray-700 mb-1">üí° Next Step:</div>
                                                        <div className="text-sm font-medium bg-white p-3 rounded border-l-4 border-purple-500">{aiResult.recommendation}</div>
                                                    </div>

                                                    {aiResult.auto_sent && (
                                                        <div className="bg-green-50 border border-green-200 rounded p-3">
                                                            <div className="flex items-center space-x-2 text-green-700">
                                                                <span>‚úÖ</span>
                                                                <span className="text-sm font-medium">Email automatically sent!</span>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {aiResult.draft_id && !aiResult.auto_sent && (
                                                        <div className="bg-blue-50 border border-blue-200 rounded p-3">
                                                            <div className="flex items-center space-x-2 text-blue-700">
                                                                <span>üìù</span>
                                                                <span className="text-sm font-medium">Draft created - review in Drafts tab</span>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <button
                                                onClick={() => setShowAIAnalysis(false)}
                                                className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                            >
                                                Done
                                            </button>
                                        </div>
                                    )}

                                    {!aiResult && (
                                        <div className="p-4 bg-blue-50 rounded-lg">
                                            <p className="text-sm text-blue-800 font-medium mb-2">üí° Try examples:</p>
                                            <div className="space-y-2">
                                                <button onClick={() => setReplyText("Thanks! I'm interested. Can we schedule a call?")} className="block w-full text-left text-xs bg-white p-2 rounded hover:bg-blue-100">Interested reply</button>
                                                <button onClick={() => setReplyText("Not now, check back in Q3.")} className="block w-full text-left text-xs bg-white p-2 rounded hover:bg-blue-100">Not now reply</button>
                                                <button onClick={() => setReplyText("Price seems high. Can you send more info?")} className="block w-full text-left text-xs bg-white p-2 rounded hover:bg-blue-100">Objection reply</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Send Email Modal */}
                    {showSendEmail && selectedLead && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                                <div className="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white">‚úâÔ∏è Send Email</h3>
                                        <button
                                            onClick={() => {
                                                setShowSendEmail(false);
                                                setEmailMode(null);
                                                setWriteMode(null);
                                                setEmailSubject('');
                                                setEmailBody('');
                                                setEmailHtmlBody('');
                                                setEmailAttachments([]);
                                                setEmailGreeting('');
                                                setEmailContext('');
                                                setEmailMainMessage('');
                                                setEmailCallToAction('');
                                                setEmailSignature('');
                                            }}
                                            className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 text-2xl"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">
                                        To: <strong>{selectedLead.first_name} {selectedLead.last_name}</strong> ({selectedLead.email})
                                    </p>
                                </div>

                                <div className="p-6 space-y-4">
                                    {!emailMode ? (
                                        <div className="space-y-4">
                                            <p className="text-gray-700 dark:text-gray-300 font-medium">How would you like to create the email?</p>

                                            <button
                                                onClick={() => {
                                                    setEmailMode('ai-power');
                                                    setEmailSubject(`Quick question about ${selectedLead.company || 'your business'}`);
                                                    setEmailGreeting(`Hi ${selectedLead.first_name || 'there'},`);
                                                    setEmailSignature(`Best regards,\n${userFromName || '[Your Name]'}`);
                                                }}
                                                className="w-full p-6 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 border-2 border-purple-200 dark:border-purple-700 rounded-lg hover:border-purple-300 dark:hover:border-purple-600 transition-all"
                                            >
                                                <div className="text-left">
                                                    <div className="text-lg font-bold text-gray-800 dark:text-white mb-2">‚ö° AI Power</div>
                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                        Use guided template with AI to generate personalized content
                                                    </div>
                                                </div>
                                            </button>

                                            <button
                                                onClick={() => {
                                                    setEmailMode('manual');
                                                    setEmailSubject(`Quick question about ${selectedLead.company || 'your business'}`);
                                                }}
                                                className="w-full p-6 bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-lg hover:border-gray-300 dark:hover:border-gray-600 transition-all"
                                            >
                                                <div className="text-left">
                                                    <div className="text-lg font-bold text-gray-800 dark:text-white mb-2">‚úçÔ∏è Write it Yourself</div>
                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                        Write a custom email with or without a template
                                                    </div>
                                                </div>
                                            </button>
                                        </div>
                                    ) : emailMode === 'manual' && !writeMode ? (
                                        <div className="space-y-4">
                                            <button
                                                onClick={() => setEmailMode(null)}
                                                className="text-blue-600 dark:text-blue-400 hover:underline flex items-center text-sm"
                                            >
                                                ‚Üê Back
                                            </button>
                                            <p className="text-gray-700 dark:text-gray-300 font-medium">Choose your writing style:</p>

                                            <button
                                                onClick={() => {
                                                    setWriteMode('template');
                                                    setEmailGreeting(`Hi ${selectedLead.first_name || 'there'},`);
                                                    setEmailSignature(`Best regards,\n${userFromName || '[Your Name]'}`);
                                                }}
                                                className="w-full p-6 bg-gradient-to-r from-green-50 to-teal-50 dark:from-green-900/20 dark:to-teal-900/20 border-2 border-green-200 dark:border-green-700 rounded-lg hover:border-green-300 dark:hover:border-green-600 transition-all"
                                            >
                                                <div className="text-left">
                                                    <div className="text-lg font-bold text-gray-800 dark:text-white mb-2">üìù Use Template</div>
                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                        Structured template with guidance for each section
                                                    </div>
                                                </div>
                                            </button>

                                            <button
                                                onClick={() => {
                                                    setWriteMode('blank');
                                                }}
                                                className="w-full p-6 bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-lg hover:border-gray-300 dark:hover:border-gray-600 transition-all"
                                            >
                                                <div className="text-left">
                                                    <div className="text-lg font-bold text-gray-800 dark:text-white mb-2">üìÑ Blank Email</div>
                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                        Start from scratch with a blank email
                                                    </div>
                                                </div>
                                            </button>
                                        </div>
                                    ) : emailMode === 'ai-power' || (emailMode === 'manual' && writeMode === 'template') ? (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Subject:
                                                </label>
                                                <input
                                                    type="text"
                                                    value={emailSubject}
                                                    onChange={(e) => setEmailSubject(e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                                    placeholder="Enter email subject"
                                                />
                                            </div>

                                            {/* Guided Template Fields */}
                                            <div className="border-2 border-green-200 dark:border-green-700 rounded-lg p-4 space-y-4 bg-green-50/30 dark:bg-green-900/10">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h4 className="font-semibold text-gray-800 dark:text-white">Email Template</h4>
                                                    {emailMode === 'ai-power' && (
                                                        <button
                                                            onClick={generateAIContent}
                                                            disabled={generatingAIContent}
                                                            className="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:opacity-50 font-medium flex items-center space-x-2"
                                                        >
                                                            {generatingAIContent ? (
                                                                <>
                                                                    <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                    </svg>
                                                                    <span>Generating...</span>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span>{emailContext || emailMainMessage || emailCallToAction ? 'üîÑ' : '‚ö°'}</span>
                                                                    <span>{emailContext || emailMainMessage || emailCallToAction ? 'Regenerate' : 'AI Generate'}</span>
                                                                </>
                                                            )}
                                                        </button>
                                                    )}
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                        Greeting <span className="text-xs text-gray-500">(Edit as needed)</span>
                                                    </label>
                                                    <textarea
                                                        value={emailGreeting}
                                                        onChange={(e) => setEmailGreeting(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                                        rows="1"
                                                        placeholder="e.g., Hi {{first_name}},"
                                                    />
                                                </div>

                                                <div>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                            Context / Reason for Reaching Out {emailMode === 'ai-power' && <span className="text-xs text-purple-600 dark:text-purple-400">‚ú® AI Generated</span>}
                                                        </label>
                                                        {emailContext.trim() && (
                                                            <button
                                                                onClick={() => polishWithAI(emailContext, 'context', setEmailContext)}
                                                                disabled={polishingField !== null}
                                                                className="text-xs px-2 py-1 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border border-amber-300 dark:border-amber-600 rounded hover:bg-amber-100 dark:hover:bg-amber-900/40 disabled:opacity-50 flex items-center space-x-1"
                                                            >
                                                                {polishingField === 'context' ? (
                                                                    <><svg className="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Polishing...</span></>
                                                                ) : <><span>‚ú®</span><span>Polish</span></>}
                                                            </button>
                                                        )}
                                                    </div>
                                                    <textarea
                                                        value={emailContext}
                                                        onChange={(e) => setEmailContext(e.target.value)}
                                                        className={`w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white ${emailMode === 'ai-power' ? 'border-purple-300 dark:border-purple-600 bg-purple-50/50 dark:bg-purple-900/20' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'}`}
                                                        rows="2"
                                                        placeholder={emailMode === 'ai-power' ? "AI will generate the context here..." : "Why are you reaching out? What caught your attention?"}
                                                    />
                                                </div>

                                                <div>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                            Main Message {emailMode === 'ai-power' && <span className="text-xs text-purple-600 dark:text-purple-400">‚ú® AI Generated</span>}
                                                        </label>
                                                        {emailMainMessage.trim() && (
                                                            <button
                                                                onClick={() => polishWithAI(emailMainMessage, 'main_message', setEmailMainMessage)}
                                                                disabled={polishingField !== null}
                                                                className="text-xs px-2 py-1 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border border-amber-300 dark:border-amber-600 rounded hover:bg-amber-100 dark:hover:bg-amber-900/40 disabled:opacity-50 flex items-center space-x-1"
                                                            >
                                                                {polishingField === 'main_message' ? (
                                                                    <><svg className="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Polishing...</span></>
                                                                ) : <><span>‚ú®</span><span>Polish</span></>}
                                                            </button>
                                                        )}
                                                    </div>
                                                    <textarea
                                                        value={emailMainMessage}
                                                        onChange={(e) => setEmailMainMessage(e.target.value)}
                                                        className={`w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white ${emailMode === 'ai-power' ? 'border-purple-300 dark:border-purple-600 bg-purple-50/50 dark:bg-purple-900/20' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'}`}
                                                        rows="5"
                                                        placeholder={emailMode === 'ai-power' ? "AI will generate the main message here..." : "Your product/service benefits, value proposition, success stories..."}
                                                    />
                                                </div>

                                                <div>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                            Call to Action {emailMode === 'ai-power' && <span className="text-xs text-purple-600 dark:text-purple-400">‚ú® AI Generated</span>}
                                                        </label>
                                                        {emailCallToAction.trim() && (
                                                            <button
                                                                onClick={() => polishWithAI(emailCallToAction, 'call_to_action', setEmailCallToAction)}
                                                                disabled={polishingField !== null}
                                                                className="text-xs px-2 py-1 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border border-amber-300 dark:border-amber-600 rounded hover:bg-amber-100 dark:hover:bg-amber-900/40 disabled:opacity-50 flex items-center space-x-1"
                                                            >
                                                                {polishingField === 'call_to_action' ? (
                                                                    <><svg className="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Polishing...</span></>
                                                                ) : <><span>‚ú®</span><span>Polish</span></>}
                                                            </button>
                                                        )}
                                                    </div>
                                                    <textarea
                                                        value={emailCallToAction}
                                                        onChange={(e) => setEmailCallToAction(e.target.value)}
                                                        className={`w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white ${emailMode === 'ai-power' ? 'border-purple-300 dark:border-purple-600 bg-purple-50/50 dark:bg-purple-900/20' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'}`}
                                                        rows="2"
                                                        placeholder={emailMode === 'ai-power' ? "AI will generate the call to action here..." : "What's the next step? (e.g., schedule a call, request demo)"}
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                        Signature <span className="text-xs text-gray-500">(Auto-filled from settings)</span>
                                                    </label>
                                                    <textarea
                                                        value={emailSignature}
                                                        onChange={(e) => setEmailSignature(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                                        rows="2"
                                                        placeholder="Best regards,\n[Your Name]"
                                                    />
                                                </div>

                                                {emailMode === 'ai-power' && (
                                                    <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-3">
                                                        <p className="text-sm text-blue-800 dark:text-blue-300">
                                                            üí° <strong>Tip:</strong> Click "‚ö° AI Power" to auto-generate the context, main message, and call to action. Greeting and signature stay under your control!
                                                        </p>
                                                    </div>
                                                )}
                                            </div>

                                            <AttachmentManager
                                                attachments={emailAttachments}
                                                onAdd={(att) => setEmailAttachments([...emailAttachments, att])}
                                                onRemove={(idx) => setEmailAttachments(emailAttachments.filter((_, i) => i !== idx))}
                                            />

                                            <div className="flex space-x-3">
                                                <button
                                                    onClick={sendEmail}
                                                    disabled={(!emailGreeting.trim() && !emailContext.trim() && !emailMainMessage.trim()) || sendingEmail}
                                                    className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium flex items-center justify-center"
                                                >
                                                    {sendingEmail ? (
                                                        <>
                                                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                            </svg>
                                                            Sending...
                                                        </>
                                                    ) : 'üì§ Send Email'}
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (emailMode === 'manual' && writeMode) {
                                                            setWriteMode(null);
                                                            setEmailGreeting('');
                                                            setEmailContext('');
                                                            setEmailMainMessage('');
                                                            setEmailCallToAction('');
                                                            setEmailSignature('');
                                                        } else {
                                                            setEmailMode(null);
                                                            setWriteMode(null);
                                                            setEmailSubject('');
                                                            setEmailGreeting('');
                                                            setEmailContext('');
                                                            setEmailMainMessage('');
                                                            setEmailCallToAction('');
                                                            setEmailSignature('');
                                                        }
                                                    }}
                                                    className="px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                                >
                                                    Back
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Subject:
                                                </label>
                                                <input
                                                    type="text"
                                                    value={emailSubject}
                                                    onChange={(e) => setEmailSubject(e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                                    placeholder="Enter email subject"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Email Message:
                                                </label>
                                                <RichTextEditor
                                                    content={emailHtmlBody}
                                                    onChange={(html) => {
                                                        setEmailHtmlBody(html);
                                                        // Extract plain text for backward compatibility
                                                        const tempDiv = document.createElement('div');
                                                        tempDiv.innerHTML = html;
                                                        setEmailBody(tempDiv.textContent || tempDiv.innerText || '');
                                                    }}
                                                    placeholder="Write your email here..."
                                                />
                                            </div>

                                            <AttachmentManager
                                                attachments={emailAttachments}
                                                onAdd={(att) => setEmailAttachments([...emailAttachments, att])}
                                                onRemove={(idx) => setEmailAttachments(emailAttachments.filter((_, i) => i !== idx))}
                                            />

                                            {/* Regenerate / Polish action row */}
                                            {(emailMode === 'ai' || emailBody.trim()) && (
                                                <div className="flex space-x-2">
                                                    {emailMode === 'ai' && (
                                                        <button
                                                            onClick={generateEmail}
                                                            disabled={generatingEmail}
                                                            className="flex-1 px-3 py-2 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 border border-purple-300 dark:border-purple-600 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/40 disabled:opacity-50 text-sm font-medium flex items-center justify-center space-x-2"
                                                        >
                                                            {generatingEmail ? (
                                                                <>
                                                                    <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                    </svg>
                                                                    <span>Generating...</span>
                                                                </>
                                                            ) : (
                                                                <><span>üîÑ</span><span>Regenerate</span></>
                                                            )}
                                                        </button>
                                                    )}
                                                    {emailBody.trim() && (
                                                        <button
                                                            onClick={() => polishWithAI(emailBody, 'body', setEmailBody, setEmailHtmlBody)}
                                                            disabled={polishingField === 'body'}
                                                            className="flex-1 px-3 py-2 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border border-amber-300 dark:border-amber-600 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 disabled:opacity-50 text-sm font-medium flex items-center justify-center space-x-2"
                                                        >
                                                            {polishingField === 'body' ? (
                                                                <>
                                                                    <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                    </svg>
                                                                    <span>Polishing...</span>
                                                                </>
                                                            ) : (
                                                                <><span>‚ú®</span><span>Polish with AI</span></>
                                                            )}
                                                        </button>
                                                    )}
                                                </div>
                                            )}

                                            <div className="flex space-x-3">
                                                <button
                                                    onClick={sendEmail}
                                                    disabled={!emailBody.trim() || sendingEmail}
                                                    className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium flex items-center justify-center"
                                                >
                                                    {sendingEmail ? (
                                                        <>
                                                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                            </svg>
                                                            Sending...
                                                        </>
                                                    ) : 'üì§ Send Email'}
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (writeMode) {
                                                            setWriteMode(null);
                                                            setEmailBody('');
                                                        } else {
                                                            setEmailMode(null);
                                                            setEmailSubject('');
                                                            setEmailBody('');
                                                        }
                                                    }}
                                                    className="px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                                >
                                                    Back
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function RichTextEditor({ content, onChange, placeholder }) {
            const editorRef = React.useRef(null);
            const quillRef = React.useRef(null);
            const onChangeRef = React.useRef(onChange);

            // Keep onChangeRef always pointing to the latest onChange so the
            // Quill text-change listener never has a stale closure over steps state
            React.useEffect(() => {
                onChangeRef.current = onChange;
            }, [onChange]);

            React.useEffect(() => {
                if (!editorRef.current || quillRef.current) return;

                // Initialize Quill editor
                const quill = new Quill(editorRef.current, {
                    theme: 'snow',
                    placeholder: placeholder || 'Write your email here...',
                    modules: {
                        toolbar: {
                            container: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'color': [] }, { 'background': [] }],
                                ['link', 'image'],
                                ['clean']
                            ],
                            handlers: {
                                image: async function() {
                                    const input = document.createElement('input');
                                    input.setAttribute('type', 'file');
                                    input.setAttribute('accept', 'image/*');
                                    input.click();

                                    input.onchange = async () => {
                                        const file = input.files[0];
                                        if (file) {
                                            if (file.size > 10 * 1024 * 1024) {
                                                alert('Image size must be less than 10MB');
                                                return;
                                            }

                                            const formData = new FormData();
                                            formData.append('file', file);

                                            try {
                                                const token = localStorage.getItem('token');
                                                const response = await fetch(`${API_URL}/email/upload-attachment`, {
                                                    method: 'POST',
                                                    headers: { 'Authorization': `Bearer ${token}` },
                                                    body: formData
                                                });

                                                if (response.ok) {
                                                    const data = await response.json();
                                                    const dataUrl = `data:${data.content_type};base64,${data.content}`;
                                                    const range = quill.getSelection();
                                                    quill.insertEmbed(range ? range.index : 0, 'image', dataUrl);
                                                } else {
                                                    const errorData = await response.json();
                                                    alert('Failed to upload image: ' + (errorData.error || response.statusText));
                                                    console.error('Upload error:', errorData);
                                                }
                                            } catch (error) {
                                                console.error('Image upload error:', error);
                                                alert('Failed to upload image: ' + error.message);
                                            }
                                        }
                                    };
                                }
                            }
                        }
                    }
                });

                // Set initial content
                if (content) {
                    quill.root.innerHTML = content;
                }

                // Handle content changes ‚Äî use ref so we always call the latest
                // onChange and never hit a stale closure over the parent's state
                quill.on('text-change', () => {
                    const html = quill.root.innerHTML;
                    onChangeRef.current(html);
                });

                quillRef.current = quill;

                // Cleanup
                return () => {
                    if (quillRef.current) {
                        quillRef.current = null;
                    }
                };
            }, []);

            // Update content when prop changes
            React.useEffect(() => {
                if (quillRef.current && content !== undefined) {
                    const currentHtml = quillRef.current.root.innerHTML;
                    if (currentHtml !== content) {
                        quillRef.current.root.innerHTML = content || '';
                    }
                }
            }, [content]);

            return (
                <div className="border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-800">
                    <div ref={editorRef} style={{ minHeight: '200px' }} />
                </div>
            );
        }

        function AttachmentManager({ attachments, onAdd, onRemove }) {
            const [uploading, setUploading] = useState(false);

            const handleFileUpload = async (file) => {
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    return;
                }

                setUploading(true);
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_URL}/email/upload-attachment`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        onAdd({
                            filename: data.filename,
                            content: data.content,
                            content_type: data.content_type,
                            size: data.size
                        });
                    } else {
                        const errorData = await response.json();
                        alert('Failed to upload file: ' + (errorData.error || response.statusText));
                        console.error('Upload error:', errorData);
                    }
                } catch (error) {
                    console.error('File upload error:', error);
                    alert('Failed to upload file: ' + error.message);
                } finally {
                    setUploading(false);
                }
            };

            const formatFileSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1024 / 1024).toFixed(1) + ' MB';
            };

            const totalSize = attachments.reduce((sum, att) => sum + (att.size || 0), 0);
            const totalMB = (totalSize / 1024 / 1024).toFixed(1);

            return (
                <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Attachments:
                    </label>

                    {attachments.length > 0 && (
                        <div className="space-y-1">
                            {attachments.map((att, idx) => (
                                <div key={idx} className="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded">
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm">üìé</span>
                                        <span className="text-sm text-gray-900 dark:text-white">{att.filename}</span>
                                        <span className="text-xs text-gray-500 dark:text-gray-400">
                                            ({formatFileSize(att.size)})
                                        </span>
                                    </div>
                                    <button
                                        onClick={() => onRemove(idx)}
                                        className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm"
                                    >
                                        Remove
                                    </button>
                                </div>
                            ))}
                            <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Total: {totalMB} MB / 40 MB
                            </div>
                        </div>
                    )}

                    <label className="cursor-pointer inline-flex items-center space-x-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors">
                        <span>üìé</span>
                        <span className="text-sm text-gray-900 dark:text-white">
                            {uploading ? 'Uploading...' : 'Add Attachment'}
                        </span>
                        <input
                            type="file"
                            className="hidden"
                            multiple
                            accept=".pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,image/*"
                            onChange={(e) => {
                                Array.from(e.target.files || []).forEach(handleFileUpload);
                                e.target.value = '';
                            }}
                            disabled={uploading}
                        />
                    </label>

                    <p className="text-xs text-gray-500 dark:text-gray-400">
                        Maximum file size: 10MB per file. Total limit: 40MB per email.
                    </p>
                </div>
            );
        }

        function AddLeadForm({ onSubmit, onCancel }) {
            const [formData, setFormData] = useState({
                email: '',
                first_name: '',
                last_name: '',
                company: '',
                phone: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };

            return (
                <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                    <h3 className="text-lg font-semibold mb-4 dark:text-white">Add New Lead</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    First Name
                                </label>
                                <input
                                    type="text"
                                    value={formData.first_name}
                                    onChange={(e) => setFormData({...formData, first_name: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    Last Name
                                </label>
                                <input
                                    type="text"
                                    value={formData.last_name}
                                    onChange={(e) => setFormData({...formData, last_name: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Email *
                            </label>
                            <input
                                type="email"
                                required
                                value={formData.email}
                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Company
                            </label>
                            <input
                                type="text"
                                value={formData.company}
                                onChange={(e) => setFormData({...formData, company: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                            />
                        </div>
                        <div className="flex space-x-3">
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Add Lead
                            </button>
                            <button
                                type="button"
                                onClick={onCancel}
                                className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        function BulkImportForm({ onImport, onCancel }) {
            const [importMethod, setImportMethod] = useState(null); // 'file' or 'paste'
            const [step, setStep] = useState(1); // 1: Upload, 2: Map Columns, 3: Validate, 4: Import
            const [file, setFile] = useState(null);
            const [pastedText, setPastedText] = useState('');
            const [csvData, setCsvData] = useState([]);
            const [csvHeaders, setCsvHeaders] = useState([]);
            const [columnMapping, setColumnMapping] = useState({
                email: '',
                first_name: '',
                last_name: '',
                company: '',
                phone: ''
            });
            const [validationResults, setValidationResults] = useState(null);
            const [importing, setImporting] = useState(false);
            const [result, setResult] = useState(null);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    const fileName = selectedFile.name.toLowerCase();
                    
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        parseExcel(selectedFile);
                    } else if (fileName.endsWith('.csv')) {
                        parseCSV(selectedFile);
                    } else if (fileName.endsWith('.txt')) {
                        parseTextFile(selectedFile);
                    }
                }
            };

            const parseExcel = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length > 0) {
                        const headers = Object.keys(jsonData[0]);
                        setCsvHeaders(headers);
                        setCsvData(jsonData);
                        autoDetectColumns(headers);
                        setStep(2);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const parseCSV = (file) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.data.length > 0) {
                            const headers = Object.keys(results.data[0]);
                            setCsvHeaders(headers);
                            setCsvData(results.data);
                            autoDetectColumns(headers);
                            setStep(2);
                        }
                    }
                });
            };

            const parseTextFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    processPastedText(text);
                };
                reader.readAsText(file);
            };

            const handlePasteSubmit = () => {
                if (!pastedText.trim()) return;
                processPastedText(pastedText);
            };

            const processPastedText = (text) => {
                const lines = text.trim().split('\n').filter(line => line.trim());
                const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi;
                
                const leads = [];
                
                // Detect separator (pipe, comma, or tab)
                const detectSeparator = (line) => {
                    if (line.includes('|')) return '|';
                    if (line.includes('\t')) return '\t';
                    if (line.includes(',')) return ',';
                    return null; // No separator, just parse normally
                };
                
                lines.forEach(line => {
                    const emails = line.match(emailRegex);
                    if (!emails) return;
                    
                    const email = emails[0];
                    const separator = detectSeparator(line);
                    
                    let first_name = '';
                    let last_name = '';
                    let company = '';
                    
                    if (separator) {
                        // Split by separator
                        const parts = line.split(separator).map(p => p.trim()).filter(p => p);
                        
                        // Find which part has the email
                        const emailIndex = parts.findIndex(p => p.includes(email));
                        
                        // Parts before email = name
                        // Parts after email = company (or more name)
                        const beforeEmail = parts.slice(0, emailIndex).join(' ');
                        const afterEmail = parts.slice(emailIndex + 1).join(' ');
                        
                        // Remove email from the part that contains it
                        let namePart = beforeEmail || parts[emailIndex].replace(email, '').trim();
                        namePart = namePart.replace(/[<>()[\]{}]/g, '').trim();
                        
                        // Split name into first and last
                        const nameWords = namePart.split(/\s+/).filter(w => w.length > 0);
                        if (nameWords.length === 1) {
                            first_name = nameWords[0];
                        } else if (nameWords.length >= 2) {
                            first_name = nameWords[0];
                            last_name = nameWords.slice(1).join(' ');
                        }
                        
                        // Everything after email is company
                        company = afterEmail.replace(/[<>()[\]{}]/g, '').trim();
                        
                    } else {
                        // No separator - smart extraction
                        let nameText = line.replace(email, '').trim();
                        nameText = nameText.replace(/[<>()[\]{}]/g, ' ').trim();
                        nameText = nameText.replace(/\s+/g, ' ');
                        
                        const parts = nameText.split(/\s+/).filter(p => p.length > 0);
                        
                        if (parts.length === 1) {
                            // Only 1 word: First name
                            first_name = parts[0];
                        } else if (parts.length === 2) {
                            // 2 words: First + Last name
                            first_name = parts[0];
                            last_name = parts[1];
                        } else if (parts.length >= 3) {
                            // 3+ words: First name + Last word is Company
                            first_name = parts[0];
                            company = parts[parts.length - 1]; // Last word = company
                            // Middle words = last name (if any)
                            if (parts.length > 2) {
                                last_name = parts.slice(1, -1).join(' ');
                            }
                        }
                    }
                    
                    leads.push({
                        email: email.trim(),
                        first_name,
                        last_name,
                        company,
                        phone: ''
                    });
                });

                if (leads.length > 0) {
                    setCsvHeaders(['email', 'first_name', 'last_name', 'company', 'phone']);
                    setCsvData(leads);
                    setColumnMapping({
                        email: 'email',
                        first_name: 'first_name',
                        last_name: 'last_name',
                        company: 'company',
                        phone: 'phone'
                    });
                    setStep(3);
                    validateDataDirect(leads);
                } else {
                    alert('No valid emails found in the pasted text');
                }
            };

            const autoDetectColumns = (headers) => {
                const autoMapping = { ...columnMapping };
                headers.forEach(header => {
                    const lower = header.toLowerCase().trim();
                    if (lower.includes('email') || lower === 'e-mail') autoMapping.email = header;
                    if (lower.includes('first') && lower.includes('name')) autoMapping.first_name = header;
                    if (lower.includes('last') && lower.includes('name')) autoMapping.last_name = header;
                    if (lower.includes('company') || lower.includes('organization')) autoMapping.company = header;
                    if (lower.includes('phone') || lower.includes('mobile') || lower.includes('tel')) autoMapping.phone = header;
                });
                setColumnMapping(autoMapping);
            };

            const validateDataDirect = (data) => {
                const results = {
                    valid: [],
                    invalid: [],
                    duplicates: [],
                    warnings: []
                };

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const seenEmails = new Set();

                data.forEach((lead, index) => {
                    const cleanLead = {
                        rowNumber: index + 1,
                        email: lead.email?.trim() || '',
                        first_name: lead.first_name?.trim() || '',
                        last_name: lead.last_name?.trim() || '',
                        company: lead.company?.trim() || '',
                        phone: lead.phone?.trim() || ''
                    };

                    const issues = [];

                    if (!cleanLead.email) {
                        issues.push('Missing email');
                    } else if (!emailRegex.test(cleanLead.email)) {
                        issues.push('Invalid email format');
                    } else if (seenEmails.has(cleanLead.email.toLowerCase())) {
                        results.duplicates.push({ ...cleanLead, issue: 'Duplicate email' });
                        return;
                    } else {
                        seenEmails.add(cleanLead.email.toLowerCase());
                    }

                    if (!cleanLead.first_name && !cleanLead.last_name) {
                        issues.push('Missing name');
                    }

                    if (issues.length > 0) {
                        results.invalid.push({ ...cleanLead, issues: issues.join(', ') });
                    } else {
                        results.valid.push(cleanLead);
                    }
                });

                setValidationResults(results);
            };

            const validateData = () => {
                const results = {
                    valid: [],
                    invalid: [],
                    duplicates: [],
                    warnings: []
                };

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const seenEmails = new Set();

                csvData.forEach((row, index) => {
                    const lead = {
                        rowNumber: index + 1,
                        email: row[columnMapping.email]?.trim() || '',
                        first_name: row[columnMapping.first_name]?.trim() || '',
                        last_name: row[columnMapping.last_name]?.trim() || '',
                        company: row[columnMapping.company]?.trim() || '',
                        phone: row[columnMapping.phone]?.trim() || ''
                    };

                    const issues = [];

                    if (!lead.email) {
                        issues.push('Missing email');
                    } else if (!emailRegex.test(lead.email)) {
                        issues.push('Invalid email format');
                    } else if (seenEmails.has(lead.email.toLowerCase())) {
                        results.duplicates.push({ ...lead, issue: 'Duplicate email' });
                        return;
                    } else {
                        seenEmails.add(lead.email.toLowerCase());
                    }

                    if (!lead.first_name && !lead.last_name) {
                        issues.push('Missing name');
                    }

                    if (issues.length > 0) {
                        results.invalid.push({ ...lead, issues: issues.join(', ') });
                    } else {
                        results.valid.push(lead);
                    }
                });

                setValidationResults(results);
                setStep(3);
            };

            const handleImport = async () => {
                if (!validationResults || validationResults.valid.length === 0) return;

                setImporting(true);
                setStep(4);
                
                const importResult = await onImport(validationResults.valid);
                setResult(importResult);
                setImporting(false);
            };

            const downloadTemplate = () => {
                const csv = 'email,first_name,last_name,company,phone\njohn@example.com,John,Doe,Acme Inc,555-1234\njane@example.com,Jane,Smith,Tech Corp,555-5678';
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lead_import_template.csv';
                a.click();
            };

            const downloadErrors = () => {
                if (!validationResults) return;
                const errors = validationResults.invalid.map(lead => ({
                    email: lead.email,
                    issues: lead.issues,
                    row: lead.rowNumber
                }));
                const csv = Papa.unparse(errors);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'import_errors.csv';
                a.click();
            };

            return (
                <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-lg font-semibold dark:text-white">Smart Lead Import</h3>
                        {importMethod && (
                            <div className="flex items-center space-x-2 text-sm">
                                <div className={`px-3 py-1 rounded ${step >= 1 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400'}`}>
                                    1. Upload
                                </div>
                                {importMethod === 'file' && (
                                    <div className={`px-3 py-1 rounded ${step >= 2 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400'}`}>
                                        2. Map
                                    </div>
                                )}
                                <div className={`px-3 py-1 rounded ${step >= 3 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400'}`}>
                                    {importMethod === 'file' ? '3' : '2'}. Validate
                                </div>
                                <div className={`px-3 py-1 rounded ${step >= 4 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400'}`}>
                                    {importMethod === 'file' ? '4' : '3'}. Import
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* METHOD SELECTION */}
                    {!importMethod && (
                        <div className="space-y-4">
                            <p className="text-gray-600 dark:text-gray-400 mb-4">Choose how you want to import your leads:</p>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button
                                    onClick={() => { setImportMethod('file'); setStep(1); }}
                                    className="p-6 border-2 border-gray-200 dark:border-gray-700 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition"
                                >
                                    <div className="text-4xl mb-3">üìÅ</div>
                                    <h4 className="font-semibold text-lg mb-2 dark:text-white">Upload File</h4>
                                    <p className="text-sm text-gray-600 dark:text-gray-400">
                                        CSV, Excel (.xlsx), or Text files
                                    </p>
                                </button>

                                <button
                                    onClick={() => { setImportMethod('paste'); setStep(1); }}
                                    className="p-6 border-2 border-gray-200 dark:border-gray-700 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition"
                                >
                                    <div className="text-4xl mb-3">üìã</div>
                                    <h4 className="font-semibold text-lg mb-2 dark:text-white">Copy & Paste</h4>
                                    <p className="text-sm text-gray-600 dark:text-gray-400">
                                        From Word, Excel, Notes, anywhere
                                    </p>
                                </button>
                            </div>

                            <button
                                onClick={onCancel}
                                className="mt-4 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                            >
                                Cancel
                            </button>
                        </div>
                    )}

                    {/* STEP 1: UPLOAD FILE */}
                    {importMethod === 'file' && step === 1 && (
                        <div className="space-y-4">
                            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <p className="text-sm text-blue-800 dark:text-blue-300 mb-2">
                                    <strong>üìä Supported formats:</strong> CSV, Excel (.xlsx, .xls), Text (.txt)
                                </p>
                                <button
                                    onClick={downloadTemplate}
                                    className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 underline"
                                >
                                    Download CSV Template
                                </button>
                            </div>

                            <div>
                                <input
                                    type="file"
                                    accept=".csv,.xlsx,.xls,.txt"
                                    onChange={handleFileChange}
                                    className="block w-full text-sm text-gray-500 dark:text-gray-400
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900/40 dark:file:text-blue-300
                                        hover:file:bg-blue-100 dark:hover:file:bg-blue-900/60"
                                />
                            </div>

                            <div className="flex space-x-3">
                                <button
                                    onClick={() => setImportMethod(null)}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Back
                                </button>
                                <button
                                    onClick={onCancel}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    {/* STEP 1: COPY-PASTE */}
                    {importMethod === 'paste' && step === 1 && (
                        <div className="space-y-4">
                            <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <p className="text-sm text-green-800 dark:text-green-300 mb-2">
                                    <strong>‚ú® Paste your leads - We'll auto-detect the format!</strong>
                                </p>
                                <p className="text-xs text-green-700 dark:text-green-400">
                                    Supports any format:
                                </p>
                                <ul className="text-xs text-green-700 dark:text-green-400 ml-4 mt-1">
                                    <li>‚Ä¢ Name | Email | Company (pipe separated)</li>
                                    <li>‚Ä¢ Name, Email, Company (comma separated)</li>
                                    <li>‚Ä¢ Name    Email    Company (tabs from Excel)</li>
                                    <li>‚Ä¢ Just emails (one per line)</li>
                                    <li>‚Ä¢ Copy directly from Excel/Google Sheets</li>
                                </ul>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Paste Your Data:
                                </label>
                                <textarea
                                    value={pastedText}
                                    onChange={(e) => setPastedText(e.target.value)}
                                    placeholder="John Doe | john@company.com | Acme Inc
Jane Smith, jane@startup.io, TechCorp
Bob Wilson    bob@email.com    StartUp LLC

Or just paste emails:
john@company.com
jane@startup.io"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg font-mono text-sm"
                                    rows="12"
                                />
                            </div>

                            <div className="flex space-x-3">
                                <button
                                    onClick={handlePasteSubmit}
                                    disabled={!pastedText.trim()}
                                    className="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 disabled:opacity-50"
                                >
                                    Process & Validate
                                </button>
                                <button
                                    onClick={() => setImportMethod(null)}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Back
                                </button>
                                <button
                                    onClick={onCancel}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    {/* STEP 2: MAP COLUMNS (File upload only) */}
                    {importMethod === 'file' && step === 2 && (
                        <div className="space-y-4">
                            <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <p className="text-sm text-green-800 dark:text-green-300">
                                    ‚úÖ Found {csvData.length} rows. Map your CSV columns to our fields:
                                </p>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                {Object.keys(columnMapping).map(field => (
                                    <div key={field}>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 capitalize">
                                            {field.replace('_', ' ')} {field === 'email' && <span className="text-red-500">*</span>}
                                        </label>
                                        <select
                                            value={columnMapping[field]}
                                            onChange={(e) => setColumnMapping({...columnMapping, [field]: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg"
                                        >
                                            <option value="">-- Select Column --</option>
                                            {csvHeaders.map(header => (
                                                <option key={header} value={header}>{header}</option>
                                            ))}
                                        </select>
                                    </div>
                                ))}
                            </div>

                            <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded">
                                <p className="text-sm font-medium dark:text-gray-300 mb-2">Preview:</p>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full text-xs dark:text-gray-300">
                                        <thead className="bg-white dark:bg-gray-700">
                                            <tr>
                                                <th className="px-2 py-1 text-left">Email</th>
                                                <th className="px-2 py-1 text-left">First</th>
                                                <th className="px-2 py-1 text-left">Last</th>
                                                <th className="px-2 py-1 text-left">Company</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {csvData.slice(0, 3).map((row, index) => (
                                                <tr key={index} className="border-t dark:border-gray-700">
                                                    <td className="px-2 py-1">{row[columnMapping.email]}</td>
                                                    <td className="px-2 py-1">{row[columnMapping.first_name]}</td>
                                                    <td className="px-2 py-1">{row[columnMapping.last_name]}</td>
                                                    <td className="px-2 py-1">{row[columnMapping.company]}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div className="flex space-x-3">
                                <button
                                    onClick={validateData}
                                    disabled={!columnMapping.email}
                                    className="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 disabled:opacity-50"
                                >
                                    Next: Validate Data
                                </button>
                                <button
                                    onClick={() => setStep(1)}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Back
                                </button>
                            </div>
                        </div>
                    )}

                    {/* STEP 3: VALIDATE */}
                    {step === 3 && validationResults && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                    <p className="text-2xl font-bold text-green-700 dark:text-green-300">{validationResults.valid.length}</p>
                                    <p className="text-sm text-green-600 dark:text-green-400">Valid Leads</p>
                                </div>
                                <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                                    <p className="text-2xl font-bold text-red-700 dark:text-red-300">{validationResults.invalid.length}</p>
                                    <p className="text-sm text-red-600 dark:text-red-400">Invalid Leads</p>
                                </div>
                                <div className="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                                    <p className="text-2xl font-bold text-yellow-700 dark:text-yellow-300">{validationResults.duplicates.length}</p>
                                    <p className="text-sm text-yellow-600 dark:text-yellow-400">Duplicates</p>
                                </div>
                            </div>

                            {validationResults.invalid.length > 0 && (
                                <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                                    <div className="flex justify-between items-start mb-2">
                                        <p className="text-sm font-medium text-red-800 dark:text-red-300">‚ùå Issues Found:</p>
                                        <button
                                            onClick={downloadErrors}
                                            className="text-xs text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 underline"
                                        >
                                            Download Error Report
                                        </button>
                                    </div>
                                    <div className="max-h-40 overflow-y-auto">
                                        <table className="min-w-full text-xs dark:text-gray-300">
                                            <thead className="bg-red-100 dark:bg-red-900/40 sticky top-0">
                                                <tr>
                                                    <th className="px-2 py-1 text-left">Row</th>
                                                    <th className="px-2 py-1 text-left">Email</th>
                                                    <th className="px-2 py-1 text-left">Issues</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {validationResults.invalid.slice(0, 10).map((lead, index) => (
                                                    <tr key={index} className="border-t border-red-200 dark:border-red-900/40">
                                                        <td className="px-2 py-1">{lead.rowNumber}</td>
                                                        <td className="px-2 py-1">{lead.email || '-'}</td>
                                                        <td className="px-2 py-1 text-red-700 dark:text-red-400">{lead.issues}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {validationResults.duplicates.length > 0 && (
                                <div className="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg">
                                    <p className="text-sm text-yellow-800 dark:text-yellow-300">
                                        ‚ö†Ô∏è {validationResults.duplicates.length} duplicate emails will be skipped
                                    </p>
                                </div>
                            )}

                            <div className="flex space-x-3">
                                <button
                                    onClick={handleImport}
                                    disabled={validationResults.valid.length === 0}
                                    className="px-4 py-2 bg-green-600 dark:bg-green-700 text-white rounded-lg hover:bg-green-700 dark:hover:bg-green-600 disabled:opacity-50"
                                >
                                    Import {validationResults.valid.length} Valid Leads
                                </button>
                                <button
                                    onClick={() => setStep(2)}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Back to Mapping
                                </button>
                                <button
                                    onClick={onCancel}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    {/* STEP 4: IMPORTING/RESULTS */}
                    {step === 4 && (
                        <div className="space-y-4">
                            {importing ? (
                                <div className="text-center py-8">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                    <p className="text-gray-600 dark:text-gray-400">Importing {validationResults.valid.length} leads...</p>
                                </div>
                            ) : result ? (
                                <div>
                                    <div className="bg-green-50 dark:bg-green-900/20 p-6 rounded-lg text-center">
                                        <div className="text-5xl mb-4">üéâ</div>
                                        <p className="text-2xl font-bold text-green-700 dark:text-green-300 mb-2">
                                            Import Complete!
                                        </p>
                                        <p className="text-lg text-green-600 dark:text-green-400">
                                            ‚úÖ Successfully imported {result.success} leads
                                        </p>
                                        {result.failed > 0 && (
                                            <p className="text-sm text-red-600 dark:text-red-400 mt-2">
                                                ‚ùå {result.failed} leads failed to import
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        onClick={onCancel}
                                        className="mt-4 w-full px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600"
                                    >
                                        Done
                                    </button>
                                </div>
                            ) : null}
                        </div>
                    )}
                </div>
            );
        }

        // Settings View Component
        // Default intent settings
        const DEFAULT_INTENT_SETTINGS = {
            INTERESTED: { delay_days: 3, delay_unit: 'days', max_attempts: 20, after_max: 'NOT_NOW' },
            NOT_NOW: { delay_days: 7, delay_unit: 'days', max_attempts: 35, after_max: 'GHOSTING' },
            OBJECTION: { delay_days: 5, delay_unit: 'days', max_attempts: 6, after_max: 'review' },
            GHOSTING: { delay_days: 10, delay_unit: 'days', max_attempts: 6, after_max: 'DEAD' },
            DEAD: { delay_days: 25, delay_unit: 'days', max_attempts: 3, after_max: 'closed_by_system' }
        };

        function SettingsView({ token, isDemoMode, darkMode, onEmailConnected }) {
            const [emailSettings, setEmailSettings] = useState({
                email: '',
                from_name: '',
                sending_mode: 'manual',
                transition_mode: 'manual',
                intent_settings: { ...DEFAULT_INTENT_SETTINGS }
            });
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const settingsInitialized = React.useRef(false);
            const autoSaveTimer = React.useRef(null);
            const [testingEmail, setTestingEmail] = useState(false);
            const [message, setMessage] = useState(null);
            const [editingKey, setEditingKey] = useState(false);

            // Seller Profile State
            const [sellerProfile, setSellerProfile] = useState({
                seller_name: '',
                seller_company: '',
                seller_email: '',
                seller_phone: '',
                seller_website: '',
                seller_social: '',
                seller_signature: ''
            });
            const [savingSeller, setSavingSeller] = useState(false);

            // Product Profile State
            const [productProfile, setProductProfile] = useState({
                product_name: '',
                product_description: '',
                key_benefits: '',
                target_audience: '',
                pain_points: '',
                unique_selling_points: '',
                success_stories: '',
                special_offers: '',
                call_to_action: ''
            });
            const [savingProduct, setSavingProduct] = useState(false);

            // Business Type & Custom Instructions State
            const [businessType, setBusinessType] = useState('other');
            const [customInstructions, setCustomInstructions] = useState('');
            const [savingAIConfig, setSavingAIConfig] = useState(false);
            const [aiInstructionsMessage, setAIInstructionsMessage] = useState(null);
            const [businessKnowledge, setBusinessKnowledge] = useState('');
            const [liveUpdates, setLiveUpdates] = useState('');
            const [savingBusinessKnowledge, setSavingBusinessKnowledge] = useState(false);
            const [businessKnowledgeMessage, setBusinessKnowledgeMessage] = useState(null);

            // Smart AI Extraction State
            const [uploadMethod, setUploadMethod] = useState('file'); // 'file', 'url', 'text'
            const [selectedFile, setSelectedFile] = useState(null);
            const [urlInput, setUrlInput] = useState('');
            const [textInput, setTextInput] = useState('');
            const [extracting, setExtracting] = useState(false);
            const [extractedInfo, setExtractedInfo] = useState(null);

            useEffect(() => {
                fetchSettings();
                fetchSellerProfile();
                fetchProductProfile();

                // Check for OAuth callback success/error
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('success')) {
                    const successType = urlParams.get('success');
                    if (successType === 'gmail_connected') {
                        setMessage({
                            type: 'success',
                            text: '‚úÖ Gmail connected successfully! You can now send and receive emails.'
                        });
                        // Update connected email in parent component
                        if (onEmailConnected) {
                            onEmailConnected();
                        }
                    }
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (urlParams.has('error')) {
                    const errorType = urlParams.get('error');
                    if (errorType === 'oauth_failed') {
                        setMessage({
                            type: 'error',
                            text: '‚ùå Failed to connect Gmail. Please try again.'
                        });
                    }
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            const fetchSettings = async () => {
                if (isDemoMode) {
                    setTimeout(() => {
                        setEmailSettings({
                            email: 'demo@example.com',
                            from_name: 'Demo Company',
                            sending_mode: 'manual',
                            transition_mode: 'manual',
                            intent_settings: { ...DEFAULT_INTENT_SETTINGS }
                        });
                        setLoading(false);
                        settingsInitialized.current = true;
                    }, 500);
                    return;
                }

                try {
                    const [emailResponse, rulesResponse, automationResponse] = await Promise.all([
                        fetch(`${API_URL}/api/settings/email`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/api/settings/follow-up-rules`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/api/settings/automation`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);
                    const emailData = emailResponse.ok ? await emailResponse.json() : {};
                    const rulesData = rulesResponse.ok ? await rulesResponse.json() : {};
                    const automationData = automationResponse.ok ? await automationResponse.json() : {};
                    setEmailSettings(prev => ({
                        ...prev,
                        ...emailData,
                        intent_settings: rulesData.follow_up_rules || { ...DEFAULT_INTENT_SETTINGS }
                    }));
                    if (automationData.business_type) setBusinessType(automationData.business_type);
                    if (automationData.ai_custom_instructions !== undefined) setCustomInstructions(automationData.ai_custom_instructions);
                    if (automationData.business_knowledge !== undefined) setBusinessKnowledge(automationData.business_knowledge);
                    if (automationData.live_updates !== undefined) setLiveUpdates(automationData.live_updates);
                    if (onEmailConnected) {
                        onEmailConnected();
                    }
                } catch (error) {
                    console.error('Error fetching settings:', error);
                } finally {
                    setLoading(false);
                    settingsInitialized.current = true;
                }
            };

            useEffect(() => {
                if (!settingsInitialized.current) return;
                if (autoSaveTimer.current) clearTimeout(autoSaveTimer.current);
                autoSaveTimer.current = setTimeout(() => {
                    saveSettings();
                }, 300); // Reduced timeout for faster saves
                return () => clearTimeout(autoSaveTimer.current);
            }, [emailSettings, businessKnowledge, liveUpdates, customInstructions]);


            const saveSettings = async () => {
                setSaving(true);
                setMessage(null);

                if (isDemoMode) {
                    setTimeout(() => {
                        setMessage({ type: 'success', text: 'Settings saved successfully!' });
                        setSaving(false);
                    }, 500);
                    return;
                }

                try {
                    await Promise.all([
                        fetch(`${API_URL}/api/settings/email`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ from_name: emailSettings.from_name, sending_mode: emailSettings.sending_mode })
                        }),
                        fetch(`${API_URL}/api/settings/follow-up-rules`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                follow_up_rules: emailSettings.intent_settings,
                                email_mode: emailSettings.sending_mode === 'auto' ? 'AUTO' : 'MANUAL'
                            })
                        }),
                        fetch(`${API_URL}/api/settings/automation`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ai_custom_instructions: customInstructions, business_knowledge: businessKnowledge, live_updates: liveUpdates })
                        })
                    ]);
                    setMessage({ type: 'success', text: 'Settings saved' });
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to save settings' });
                } finally {
                    setSaving(false);
                }
            };

            const testEmailConnection = async () => {
                setTestingEmail(true);
                setMessage(null);

                if (isDemoMode) {
                    setTimeout(() => {
                        setMessage({ type: 'success', text: 'Test email sent successfully!' });
                        setTestingEmail(false);
                    }, 1000);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/settings/email/test`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage({ type: 'success', text: 'Test email sent successfully!' });
                    } else {
                        setMessage({ type: 'error', text: data.error || 'Failed to send test email' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to send test email' });
                } finally {
                    setTestingEmail(false);
                }
            };

            const updateIntentSetting = (intent, field, value) => {
                setEmailSettings({
                    ...emailSettings,
                    intent_settings: {
                        ...emailSettings.intent_settings,
                        [intent]: {
                            ...emailSettings.intent_settings[intent],
                            [field]: value
                        }
                    }
                });
            };

            // Seller Profile Functions
            const fetchSellerProfile = async () => {
                if (isDemoMode) return;
                try {
                    const response = await fetch(`${API_URL}/api/settings/seller-profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.configured) {
                            setSellerProfile({
                                seller_name: data.seller_name || '',
                                seller_company: data.seller_company || '',
                                seller_email: data.seller_email || '',
                                seller_phone: data.seller_phone || '',
                                seller_website: data.seller_website || '',
                                seller_social: data.seller_social || '',
                                seller_signature: data.seller_signature || ''
                            });
                        }
                    }
                } catch (error) { console.error('Error fetching seller profile:', error); }
            };

            const saveSellerProfile = async () => {
                if (isDemoMode) { setMessage({ type: 'success', text: 'Profile saved! (demo mode)' }); return; }
                setSavingSeller(true);
                try {
                    const profileRes = await fetch(`${API_URL}/api/settings/seller-profile`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(sellerProfile)
                    });
                    if (!profileRes.ok) {
                        const errData = await profileRes.json().catch(() => ({}));
                        setMessage({ type: 'error', text: `Failed to save profile: ${errData.error || 'Status ' + profileRes.status}` });
                    } else {
                        setMessage({ type: 'success', text: '‚úÖ Profile saved!' });
                        // Fire-and-forget the other saves (non-critical)
                        Promise.all([
                            fetch(`${API_URL}/api/settings/automation`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ business_type: businessType })
                            }),
                            fetch(`${API_URL}/api/settings/email`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ from_name: emailSettings.from_name, sending_mode: emailSettings.sending_mode })
                            })
                        ]).catch(() => {});
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Network error saving profile.' });
                } finally { setSavingSeller(false); }
            };

            // Product Profile Functions
            const fetchProductProfile = async () => {
                if (isDemoMode) return;

                try {
                    const response = await fetch(`${API_URL}/api/settings/product-profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.configured) {
                            setProductProfile(data);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching product profile:', error);
                }
            };

            const saveProductProfile = async () => {
                setSavingProduct(true);
                setMessage(null);

                if (isDemoMode) {
                    setTimeout(() => {
                        setMessage({ type: 'success', text: 'Product profile saved!' });
                        setSavingProduct(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/settings/product-profile`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(productProfile)
                    });

                    if (response.ok) {
                        setMessage({ type: 'success', text: 'Product profile saved! AI will now use this info to generate better emails.' });
                    } else {
                        setMessage({ type: 'error', text: 'Failed to save product profile' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to save product profile' });
                } finally {
                    setSavingProduct(false);
                }
            };

            const clearAllKnowledge = async () => {
                if (!window.confirm('Clear ALL product knowledge? This will delete your product profile, business knowledge, and live updates. The AI will stop using any previous product info.')) return;
                try {
                    const res = await fetch(`${API_URL}/api/settings/product-profile`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        setProductProfile({ product_name: '', product_description: '', key_benefits: '', target_audience: '', pain_points: '', unique_selling_points: '', success_stories: '', special_offers: '', call_to_action: '' });
                        setBusinessKnowledge('');
                        setLiveUpdates('');
                        setMessage({ type: 'success', text: 'All product knowledge cleared. AI will no longer reference previous product info.' });
                    } else {
                        setMessage({ type: 'error', text: 'Failed to clear knowledge' });
                    }
                } catch (e) {
                    setMessage({ type: 'error', text: 'Failed to clear knowledge' });
                }
            };

            // Format extracted product data into bullet-point text for Business Knowledge
            const formatExtractedToKnowledge = (extracted) => {
                const lines = [];
                if (extracted.product_name) lines.push(`‚Ä¢ Product: ${extracted.product_name}`);
                if (extracted.product_description) lines.push(`‚Ä¢ Description: ${extracted.product_description}`);
                if (extracted.key_benefits) lines.push(`‚Ä¢ Key Benefits: ${extracted.key_benefits}`);
                if (extracted.target_audience) lines.push(`‚Ä¢ Target Audience: ${extracted.target_audience}`);
                if (extracted.unique_selling_points) lines.push(`‚Ä¢ Unique Selling Points: ${extracted.unique_selling_points}`);
                if (extracted.pain_points) lines.push(`‚Ä¢ Pain Points Solved: ${extracted.pain_points}`);
                if (extracted.special_offers) lines.push(`‚Ä¢ Pricing / Offers: ${extracted.special_offers}`);
                if (extracted.success_stories) lines.push(`‚Ä¢ Success Stories: ${extracted.success_stories}`);
                if (extracted.call_to_action) lines.push(`‚Ä¢ Call to Action: ${extracted.call_to_action}`);
                return lines.join('\n');
            };

            // AI Smart Extraction Function
            const extractProductWithAI = async () => {
                setExtracting(true);
                setMessage(null);
                setExtractedInfo(null);

                if (isDemoMode) {
                    setTimeout(() => {
                        const demoExtracted = {
                            product_name: 'Demo Product',
                            product_description: 'A demo product for testing',
                            key_benefits: 'Fast, Easy, Powerful'
                        };
                        const formattedKnowledge = formatExtractedToKnowledge(demoExtracted);
                        setBusinessKnowledge(prev => prev ? prev + '\n' + formattedKnowledge : formattedKnowledge);
                        setExtractedInfo(demoExtracted);
                        setMessage({ type: 'success', text: '‚úÖ AI has compiled your product info! Scroll up to Business Knowledge to review.' });
                        setExtracting(false);
                    }, 1500);
                    return;
                }

                try {
                    const formData = new FormData();

                    if (uploadMethod === 'file' && selectedFile) {
                        formData.append('file', selectedFile);
                        formData.append('type', 'file');
                    } else if (uploadMethod === 'url' && urlInput.trim()) {
                        formData.append('url', urlInput.trim());
                        formData.append('type', 'url');
                    } else if (uploadMethod === 'text' && textInput.trim()) {
                        formData.append('text_content', textInput.trim());
                        formData.append('type', 'text');
                    } else {
                        setMessage({ type: 'error', text: 'Please provide content to analyze' });
                        setExtracting(false);
                        return;
                    }

                    const response = await fetch(`${API_URL}/api/settings/product-extract`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Format extracted data and append to Business Knowledge
                        const formattedKnowledge = formatExtractedToKnowledge(data.extracted);
                        setBusinessKnowledge(prev => prev ? prev + '\n' + formattedKnowledge : formattedKnowledge);

                        // Also save to productProfile for backward compatibility
                        setProductProfile(data.extracted);

                        // Show success notification
                        setExtractedInfo(data.extracted); // Trigger the "scroll up" notice
                        setMessage({
                            type: 'success',
                            text: '‚úÖ AI has compiled your product info! Scroll up to Business Knowledge to review and edit.'
                        });

                        // Clear inputs
                        setSelectedFile(null);
                        setUrlInput('');
                        setTextInput('');
                    } else {
                        setMessage({ type: 'error', text: data.error || 'Failed to extract product info' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to extract product info' });
                } finally {
                    setExtracting(false);
                }
            };

            const intentIcons = {
                INTERESTED: 'üî•',
                NOT_NOW: '‚è∞',
                OBJECTION: 'üí°',
                GHOSTING: 'üëª',
                DEAD: '‚ùå'
            };

            const intentLabels = {
                INTERESTED: 'Interested',
                NOT_NOW: 'Not Now',
                OBJECTION: 'Has Objection',
                GHOSTING: 'Ghosting',
                DEAD: 'No Longer Interested'
            };

            const afterMaxOptions = [
                { value: 'NOT_NOW', label: 'Not Now' },
                { value: 'GHOSTING', label: 'Ghosting' },
                { value: 'DEAD', label: 'No Longer Interested' },
                { value: 'OBJECTION', label: 'Has Objection' }
            ];

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Settings</h2>

                    {message && (
                        <div className={`p-4 rounded-lg ${message.type === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                            {message.text}
                        </div>
                    )}

                    {loading ? (
                        <div className="text-center py-8 text-gray-600 dark:text-gray-400">Loading settings...</div>
                    ) : (
                        <div className="space-y-6">

                            {/* ‚îÄ‚îÄ SELLER PROFILE ‚îÄ‚îÄ */}
                            <div className="bg-white dark:bg-black border border-blue-200 dark:border-blue-800 rounded-lg shadow-lg p-4">
                                <div className="flex items-center justify-between mb-3">
                                    <div>
                                        <h3 className="text-base font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                                            <span>ü™™</span> Your Profile
                                        </h3>
                                        <p className="text-xs text-gray-400 dark:text-gray-500 mt-0.5">Your info that the AI will include in email content when contacting leads.</p>
                                    </div>
                                    <button onClick={saveSellerProfile} disabled={savingSeller}
                                        className="flex-shrink-0 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-xs font-medium flex items-center gap-1.5">
                                        {savingSeller ? <><div className="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></div> Saving‚Ä¶</> : 'üíæ Save'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Full Name</label>
                                        <input type="text" value={sellerProfile.seller_name}
                                            onChange={e => setSellerProfile(prev => ({...prev, seller_name: e.target.value}))}
                                            className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                            placeholder="Your name" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Company / From Name</label>
                                        <input type="text" value={sellerProfile.seller_company}
                                            onChange={e => setSellerProfile(prev => ({...prev, seller_company: e.target.value}))}
                                            className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                            placeholder="Company or brand name" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Phone</label>
                                        <input type="text" value={sellerProfile.seller_phone}
                                            onChange={e => setSellerProfile(prev => ({...prev, seller_phone: e.target.value}))}
                                            className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                            placeholder="+1 555 000 0000" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Your Email</label>
                                        <input type="email" value={sellerProfile.seller_email}
                                            onChange={e => setSellerProfile(prev => ({...prev, seller_email: e.target.value}))}
                                            className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                            placeholder="you@yourcompany.com" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Website</label>
                                        <input type="text" value={sellerProfile.seller_website}
                                            onChange={e => setSellerProfile(prev => ({...prev, seller_website: e.target.value}))}
                                            className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                            placeholder="https://yourcompany.com" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Social / WhatsApp / Booking</label>
                                        <input type="text" value={sellerProfile.seller_social}
                                            onChange={e => setSellerProfile(prev => ({...prev, seller_social: e.target.value}))}
                                            className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                            placeholder="@handle or link" />
                                    </div>
                                </div>
                                <div className="mt-2">
                                    <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-0.5">Business Type</label>
                                    <select value={businessType} onChange={e => setBusinessType(e.target.value)}
                                        className="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm">
                                        <option value="real_estate">Property / Real Estate</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="saas">SaaS / App</option>
                                        <option value="ecommerce">E-commerce</option>
                                        <option value="consulting">Consulting</option>
                                        <option value="community">Community / Social</option>
                                        <option value="other">Other / Generic</option>
                                    </select>
                                </div>
                            </div>

                            {/* Email Configuration */}
                            <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                                    <span className="mr-2">üìß</span> Email
                                </h3>

                                {/* Status */}
                                <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg mb-6">
                                    <div className="flex items-center">
                                        <span className="text-green-500 text-2xl mr-3">‚úì</span>
                                        <div>
                                            <p className="font-medium text-green-800 dark:text-green-300">Email sending is included</p>
                                            <p className="text-xs text-green-600 dark:text-green-400">Recovery emails are sent automatically on your behalf</p>
                                        </div>
                                    </div>
                                </div>

                                <p className="text-xs text-gray-400 dark:text-gray-500">Set your name and company in the Seller Profile above ‚Äî it will be used as your email display name.</p>
                            </div>

                            {/* Gmail OAuth Connection */}
                            <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                                    <span className="mr-2">üì¨</span> Email Connection (OAuth)
                                </h3>

                                <div className="p-4 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg mb-6">
                                    <div className="flex items-start">
                                        <span className="text-purple-500 text-2xl mr-3">ü§ñ</span>
                                        <div>
                                            <p className="font-medium text-purple-800 dark:text-purple-300">AI Auto-Categorization Enabled</p>
                                            <p className="text-xs text-purple-600 dark:text-purple-400 mt-1">Connect your Gmail to automatically check your inbox every 5 minutes, read customer replies, and use AI to categorize leads as INTERESTED, NOT_NOW, OBJECTION, GHOSTING, or DEAD</p>
                                        </div>
                                    </div>
                                </div>

                                {emailSettings.email && emailSettings.provider === 'gmail' ? (
                                    <div className="space-y-4">
                                        <div className="flex items-center justify-between p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                                            <div className="flex items-center">
                                                <svg className="w-8 h-8 mr-3" viewBox="0 0 48 48">
                                                    <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                                                    <path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                                                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                                                    <path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                                                </svg>
                                                <div>
                                                    <p className="font-semibold text-gray-800 dark:text-gray-200">
                                                        {emailSettings.email || '(Email not saved - Please reconnect)'}
                                                    </p>
                                                    <p className="text-sm text-gray-600 dark:text-gray-400">
                                                        {emailSettings.email ? 'Connected via Google OAuth' : 'OAuth connected but email missing'}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                {!emailSettings.email && (
                                                    <button
                                                        onClick={async () => {
                                                            try {
                                                                const response = await fetch(`${API_URL}/api/auth/google`, {
                                                                    headers: { 'Authorization': `Bearer ${token}` }
                                                                });
                                                                const { authUrl } = await response.json();
                                                                window.location.href = authUrl;
                                                            } catch (error) {
                                                                setMessage({ type: 'error', text: 'Failed to reconnect Gmail' });
                                                            }
                                                        }}
                                                        className="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 border border-blue-600 rounded-lg transition-colors"
                                                    >
                                                        üîÑ Reconnect
                                                    </button>
                                                )}
                                                <button
                                                    onClick={async () => {
                                                        if (confirm('Disconnect Gmail account?')) {
                                                            try {
                                                                await fetch(`${API_URL}/api/auth/google`, {
                                                                    method: 'DELETE',
                                                                    headers: { 'Authorization': `Bearer ${token}` }
                                                                });
                                                                setEmailSettings(prev => ({ ...prev, email: '', provider: null, from_name: '', sending_mode: 'manual', intent_settings: prev.intent_settings || { ...DEFAULT_INTENT_SETTINGS } }));
                                                                setMessage({ type: 'success', text: 'Gmail disconnected' });
                                                                if (onEmailConnected) {
                                                                    onEmailConnected();
                                                                }
                                                            } catch (error) {
                                                                setMessage({ type: 'error', text: 'Failed to disconnect' });
                                                            }
                                                        }
                                                    }}
                                                    className="px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 border border-red-300 dark:border-red-800 rounded-lg transition-colors"
                                                >
                                                    Disconnect
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            {emailSettings.email
                                                ? '‚úÖ Your Gmail is connected and checking for new lead replies automatically'
                                                : '‚ö†Ô∏è Please click "Reconnect" to save your email address'}
                                        </p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <button
                                            onClick={async () => {
                                                try {
                                                    const response = await fetch(`${API_URL}/api/auth/google`, {
                                                        headers: { 'Authorization': `Bearer ${token}` }
                                                    });
                                                    const { authUrl } = await response.json();
                                                    window.location.href = authUrl;
                                                } catch (error) {
                                                    setMessage({ type: 'error', text: 'Failed to connect Gmail' });
                                                }
                                            }}
                                            className="w-full flex items-center justify-center gap-3 px-6 py-3 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg font-medium text-gray-800 dark:text-white shadow-sm transition-all"
                                        >
                                            <svg className="w-6 h-6" viewBox="0 0 48 48">
                                                <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/>
                                                <path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/>
                                                <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0124 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/>
                                                <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303a12.04 12.04 0 01-4.087 5.571l.003-.002 6.19 5.238C36.971 39.205 44 34 44 24c0-1.341-.138-2.65-.389-3.917z"/>
                                            </svg>
                                            Connect with Google
                                        </button>
                                        <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                            <p className="text-sm text-blue-800 dark:text-blue-300">
                                                <strong>üîí Secure OAuth:</strong> No password needed! Google will authorize this app to read and send emails on your behalf. You can revoke access anytime from your Google Account settings.
                                            </p>
                                        </div>
                                        <div className="text-sm text-gray-600 dark:text-gray-400">
                                            <p className="font-medium mb-2">Currently supporting:</p>
                                            <ul className="space-y-1 ml-4">
                                                <li>‚úÖ Gmail (@gmail.com)</li>
                                                <li>‚úÖ Google Workspace (your-domain.com via Google)</li>
                                                <li className="text-gray-400">‚è≥ Outlook/Hotmail (coming soon)</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Sending Mode */}
                            <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                                    <span className="mr-2">ü§ñ</span> Sending Mode
                                </h3>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <label className={`relative flex flex-col p-4 border-2 rounded-lg cursor-pointer ${emailSettings.sending_mode === 'manual' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-600'}`}>
                                        <input
                                            type="radio"
                                            name="sending_mode"
                                            value="manual"
                                            checked={emailSettings.sending_mode === 'manual'}
                                            onChange={async (e) => {
                                                const newMode = e.target.value;
                                                setEmailSettings({ ...emailSettings, sending_mode: newMode });
                                                if (!isDemoMode && token) {
                                                    await Promise.all([
                                                        fetch(`${API_URL}/api/settings/email`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ from_name: emailSettings.from_name, sending_mode: newMode }) }),
                                                        fetch(`${API_URL}/api/settings/follow-up-rules`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ follow_up_rules: emailSettings.intent_settings, email_mode: 'MANUAL' }) })
                                                    ]);
                                                }
                                            }}
                                            className="sr-only"
                                        />
                                        <span className="text-lg font-semibold text-gray-800 dark:text-white">üìù Manual Mode</span>
                                        <span className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                            AI creates drafts ‚Üí You review ‚Üí Click send
                                        </span>
                                    </label>

                                    <label className={`relative flex flex-col p-4 border-2 rounded-lg cursor-pointer ${emailSettings.sending_mode === 'auto' ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-gray-200 dark:border-gray-600'}`}>
                                        <input
                                            type="radio"
                                            name="sending_mode"
                                            value="auto"
                                            checked={emailSettings.sending_mode === 'auto'}
                                            onChange={async (e) => {
                                                const newMode = e.target.value;
                                                setEmailSettings({ ...emailSettings, sending_mode: newMode });
                                                if (!isDemoMode && token) {
                                                    await Promise.all([
                                                        fetch(`${API_URL}/api/settings/email`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ from_name: emailSettings.from_name, sending_mode: newMode }) }),
                                                        fetch(`${API_URL}/api/settings/follow-up-rules`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ follow_up_rules: emailSettings.intent_settings, email_mode: 'AUTO' }) })
                                                    ]);
                                                }
                                            }}
                                            className="sr-only"
                                        />
                                        <span className="text-lg font-semibold text-gray-800 dark:text-white">‚ö° Auto Mode</span>
                                        <span className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                            AI generates and sends automatically
                                        </span>
                                    </label>
                                </div>

                                {/* Email Flow Explanation */}
                                <div className="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                    <p className="text-sm text-gray-800 dark:text-gray-300 mb-2"><strong>How Emails Are Sent:</strong></p>
                                    {emailSettings.sending_mode === 'auto' ? (
                                        <div className="text-xs text-gray-700 dark:text-gray-400">
                                            <p className="mb-1">‚ö° <strong>Auto Mode Active</strong></p>
                                            <p>Emails are automatically generated and sent based on your Follow-Up Rules. No manual approval needed.</p>
                                        </div>
                                    ) : (
                                        <div className="text-xs text-gray-700 dark:text-gray-400">
                                            <p className="mb-1">üìù <strong>Manual Mode Active</strong></p>
                                            <p>AI generates email drafts for your review. Go to the Emails tab to approve and send them.</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Custom AI Instructions */}
                            <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                                    <span className="mr-2">‚úçÔ∏è</span> AI Reply Behaviour
                                </h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    Describe how you want the AI to sound and behave when writing or replying to customers ‚Äî tone, style, length, language, rules to follow.
                                </p>
                                <textarea
                                    value={customInstructions}
                                    onChange={e => setCustomInstructions(e.target.value)}
                                    rows={4}
                                    placeholder={"Examples:\n‚Ä¢ Always use a friendly and casual tone\n‚Ä¢ Keep every email under 80 words\n‚Ä¢ End each email with a question to keep the conversation going\n‚Ä¢ If the lead asks for pricing, say 'I'll send you a custom quote ‚Äî can we jump on a quick call?'"}
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm mb-4 resize-none"
                                />
                                <button
                                    onClick={async () => {
                                        setSavingAIConfig(true);
                                        try {
                                            const response = await fetch(`${API_URL}/api/settings/automation`, {
                                                method: 'POST',
                                                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ ai_custom_instructions: customInstructions })
                                            });
                                            if (response.ok) {
                                                setAIInstructionsMessage({ type: 'success', text: '‚úÖ AI Reply Behaviour saved!' });
                                                setTimeout(() => setAIInstructionsMessage(null), 3000);
                                            } else {
                                                const data = await response.json();
                                                setAIInstructionsMessage({ type: 'error', text: `‚ùå Failed to save: ${data.error || 'Unknown error'}` });
                                                setTimeout(() => setAIInstructionsMessage(null), 3000);
                                            }
                                        } catch(e) {
                                            setAIInstructionsMessage({ type: 'error', text: `‚ùå Failed to save: ${e.message}` });
                                            setTimeout(() => setAIInstructionsMessage(null), 3000);
                                        }
                                        finally { setSavingAIConfig(false); }
                                    }}
                                    disabled={savingAIConfig}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white rounded-lg text-sm"
                                >
                                    {savingAIConfig ? 'Saving...' : 'Save Instructions'}
                                </button>
                                {aiInstructionsMessage && (
                                    <div className={`mt-3 p-3 rounded-lg text-sm ${aiInstructionsMessage.type === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                                        {aiInstructionsMessage.text}
                                    </div>
                                )}
                            </div>

                            {/* Business Knowledge + Live Updates */}
                            <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-1 flex items-center">
                                    <span className="mr-2">üß†</span> Business Knowledge & Live Updates
                                </h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-5">
                                    Tell your AI what it needs to know about your business ‚Äî products, availability, pricing, or anything that changes. The AI will use this when replying to customers.
                                </p>

                                {/* Business Knowledge */}
                                <div className="mb-5">
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        üìö Business Knowledge <span className="font-normal text-gray-500">(stable info ‚Äî update occasionally)</span>
                                    </label>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mb-2">Products, packages, pricing, policies, FAQs ‚Äî anything the AI should always know about your business.</p>
                                    <textarea
                                        value={businessKnowledge}
                                        onChange={e => setBusinessKnowledge(e.target.value)}
                                        rows={5}
                                        placeholder={"Examples:\n‚Ä¢ Unit Type A: 3-bedroom, RM 650,000, 1,200 sqft, freehold\n‚Ä¢ Package B includes: 6 months coaching + weekly calls + private group\n‚Ä¢ Our refund policy: 30-day money back, no questions asked\n‚Ä¢ We serve clients in KL, Selangor, and Penang only"}
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm resize-none"
                                    />
                                </div>

                                {/* Live Updates */}
                                <div className="mb-5">
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        ‚ö° Live Updates <span className="font-normal text-gray-500">(time-sensitive ‚Äî update frequently)</span>
                                    </label>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mb-2">Current stock, active promotions, sold-out items, limited availability ‚Äî things that change often and the AI must know right now.</p>
                                    <textarea
                                        value={liveUpdates}
                                        onChange={e => setLiveUpdates(e.target.value)}
                                        rows={3}
                                        placeholder={"Examples:\n‚Ä¢ Unit A Block 5: only 10 units left as of today\n‚Ä¢ Promo: 5% early bird discount, ends 28 Feb\n‚Ä¢ Package C is currently sold out"}
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm resize-none"
                                    />
                                </div>

                                <button
                                    onClick={async () => {
                                        setSavingBusinessKnowledge(true);
                                        try {
                                            await fetch(`${API_URL}/api/settings/automation`, {
                                                method: 'POST',
                                                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ business_knowledge: businessKnowledge, live_updates: liveUpdates })
                                            });
                                            setBusinessKnowledgeMessage({ type: 'success', text: '‚úÖ Business Knowledge saved!' });
                                            setTimeout(() => setBusinessKnowledgeMessage(null), 3000);
                                        } catch(e) {
                                            setBusinessKnowledgeMessage({ type: 'error', text: '‚ùå Failed to save.' });
                                            setTimeout(() => setBusinessKnowledgeMessage(null), 3000);
                                        } finally { setSavingBusinessKnowledge(false); }
                                    }}
                                    disabled={savingBusinessKnowledge}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white rounded-lg text-sm"
                                >
                                    {savingBusinessKnowledge ? 'Saving...' : 'Save'}
                                </button>
                                {businessKnowledgeMessage && (
                                    <div className={`mt-3 p-3 rounded-lg text-sm ${businessKnowledgeMessage.type === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                                        {businessKnowledgeMessage.text}
                                    </div>
                                )}
                            </div>

                            {/* Product Knowledge Base - AI Smart Extraction */}
                            <div className="bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 border-2 border-purple-300 dark:border-purple-700 rounded-lg shadow-lg p-6">
                                <div className="mb-6">
                                    <h3 className="text-xl font-bold text-purple-900 dark:text-purple-100 mb-2 flex items-center">
                                        <span className="mr-2">ü§ñ</span> AI Product Knowledge Base
                                    </h3>
                                    <p className="text-sm text-purple-700 dark:text-purple-300">
                                        ‚ú® Just upload your product docs, paste a URL, or paste text - AI will automatically learn everything about your product and generate persuasive emails!
                                    </p>
                                </div>

                                {/* Upload Method Tabs */}
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => setUploadMethod('file')}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                            uploadMethod === 'file'
                                                ? 'bg-purple-600 text-white'
                                                : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600'
                                        }`}
                                    >
                                        üìÑ Upload File
                                    </button>
                                    <button
                                        onClick={() => setUploadMethod('url')}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                            uploadMethod === 'url'
                                                ? 'bg-purple-600 text-white'
                                                : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600'
                                        }`}
                                    >
                                        üîó Paste URL
                                    </button>
                                    <button
                                        onClick={() => setUploadMethod('text')}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                            uploadMethod === 'text'
                                                ? 'bg-purple-600 text-white'
                                                : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600'
                                        }`}
                                    >
                                        üìù Paste Text
                                    </button>
                                </div>

                                {/* File Upload */}
                                {uploadMethod === 'file' && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-purple-900 dark:text-purple-200 mb-2">
                                            Upload Product Document
                                        </label>
                                        <div className="border-2 border-dashed border-purple-300 dark:border-purple-600 rounded-lg p-6 text-center bg-white dark:bg-gray-900">
                                            <input
                                                type="file"
                                                accept=".pdf,.docx,.doc,.ppt,.pptx,.txt,.csv"
                                                onChange={(e) => setSelectedFile(e.target.files[0])}
                                                className="hidden"
                                                id="file-upload"
                                            />
                                            <label
                                                htmlFor="file-upload"
                                                className="cursor-pointer inline-block px-6 py-3 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-200 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 font-medium"
                                            >
                                                {selectedFile ? selectedFile.name : 'üìÅ Choose File'}
                                            </label>
                                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                                Supported: PDF, DOCX, PPT, TXT, CSV (Max 10MB)
                                            </p>
                                        </div>
                                    </div>
                                )}

                                {/* URL Input */}
                                {uploadMethod === 'url' && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-purple-900 dark:text-purple-200 mb-2">
                                            Paste Website URL or Document Link
                                        </label>
                                        <input
                                            type="url"
                                            value={urlInput}
                                            onChange={(e) => setUrlInput(e.target.value)}
                                            placeholder="https://yourwebsite.com/product or https://docs.google.com/..."
                                            className="w-full px-4 py-3 border border-purple-300 dark:border-purple-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                        />
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                            Supports: Website, Google Docs, Notion pages, any public URL
                                        </p>
                                    </div>
                                )}

                                {/* Text Input */}
                                {uploadMethod === 'text' && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-purple-900 dark:text-purple-200 mb-2">
                                            Paste Product Information
                                        </label>
                                        <textarea
                                            value={textInput}
                                            onChange={(e) => setTextInput(e.target.value)}
                                            placeholder="Paste your product description, FAQs, email content, or any text about your product..."
                                            rows="8"
                                            className="w-full px-4 py-3 border border-purple-300 dark:border-purple-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                        />
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                            Paste FAQs, product descriptions, old emails, support docs, etc.
                                        </p>
                                    </div>
                                )}

                                {/* Extract Button */}
                                <button
                                    onClick={extractProductWithAI}
                                    disabled={extracting || (!selectedFile && !urlInput.trim() && !textInput.trim())}
                                    className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold text-lg shadow-lg"
                                >
                                    {extracting ? 'ü§ñ AI is Learning Your Product...' : 'ü§ñ Let AI Learn My Product'}
                                </button>

                                {/* Clear All Knowledge Button */}
                                <button
                                    onClick={clearAllKnowledge}
                                    className="w-full mt-3 px-4 py-2 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-300 dark:border-red-700 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 text-sm font-medium"
                                >
                                    üóëÔ∏è Clear All Product Knowledge
                                </button>

                                {/* Extraction Success Notice */}
                                {extractedInfo && (
                                    <div className="mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-300 dark:border-green-700 rounded-lg">
                                        <p className="text-sm text-green-800 dark:text-green-200 flex items-center">
                                            <span className="mr-2">‚úÖ</span>
                                            <span><strong>AI extracted your product info!</strong> It's now in your Business Knowledge field above ‚Äî scroll up to review and edit it before saving.</span>
                                        </p>
                                    </div>
                                )}

                                {/* Help Text */}
                                <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-300 dark:border-blue-700 rounded-lg">
                                    <p className="text-xs text-blue-800 dark:text-blue-200">
                                        <strong>üí° Tip:</strong> The more information you provide, the better AI can generate persuasive emails. Try uploading your product brochure, pricing page, or case studies!
                                    </p>
                                </div>
                            </div>

                            {/* Follow-Up Rules */}
                            <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                            <span className="mr-2">‚öôÔ∏è</span> Follow-Up Rules
                                        </h3>
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-0.5">
                                            Set how often and how many times to follow up with each type of lead.
                                        </p>
                                    </div>
                                    <button onClick={saveSettings} disabled={saving}
                                        className="flex-shrink-0 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-xs font-medium flex items-center gap-1.5">
                                        {saving ? <><div className="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></div> Saving‚Ä¶</> : 'üíæ Save'}
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    {Object.entries(emailSettings.intent_settings || {}).map(([intent, settings]) => (
                                        <div key={intent} className="border dark:border-gray-700 rounded-lg p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center">
                                                    <span className="text-xl mr-2">{intentIcons[intent]}</span>
                                                    <span className="font-semibold text-gray-800 dark:text-white">{intentLabels[intent]}</span>
                                                </div>
                                                <button
                                                    onClick={() => setEmailSettings(prev => ({
                                                        ...prev,
                                                        intent_settings: {
                                                            ...prev.intent_settings,
                                                            [intent]: { ...DEFAULT_INTENT_SETTINGS[intent] }
                                                        }
                                                    }))}
                                                    className="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors"
                                                >
                                                    Default
                                                </button>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                                        Send Every
                                                    </label>
                                                    <div className="flex gap-1">
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            value={settings.delay_days}
                                                            onChange={(e) => updateIntentSetting(intent, 'delay_days', e.target.value === '' ? '' : parseInt(e.target.value) || 1)}
                                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                                        />
                                                        <select
                                                            value={settings.delay_unit || 'days'}
                                                            onChange={(e) => updateIntentSetting(intent, 'delay_unit', e.target.value)}
                                                            className="px-2 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm"
                                                        >
                                                            <option value="days">Days</option>
                                                            <option value="minutes">Mins</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                                        Max Emails
                                                    </label>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        value={settings.max_attempts}
                                                        onChange={(e) => updateIntentSetting(intent, 'max_attempts', e.target.value === '' ? '' : parseInt(e.target.value) || 1)}
                                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                                        When max reached
                                                    </label>
                                                    <select
                                                        value={settings.after_max}
                                                        onChange={(e) => updateIntentSetting(intent, 'after_max', e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                                    >
                                                        {afterMaxOptions.map(opt => (
                                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                        </div>
                    )}
                </div>
            );
        }

        // Pending Reviews View Component
        function PendingReviewsView({ token, isDemoMode, darkMode }) {
            const [reviews, setReviews] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchReviews();
            }, []);

            const fetchReviews = async () => {
                if (isDemoMode) {
                    setTimeout(() => {
                        setReviews([
                            { id: 1, email: 'john@example.com', first_name: 'John', last_name: 'Doe', current_intent: 'INTERESTED', suggested_intent: 'NOT_NOW', last_reply: 'Not right now, maybe later', retry_count: 20 },
                            { id: 2, email: 'jane@example.com', first_name: 'Jane', last_name: 'Smith', current_intent: 'NOT_NOW', suggested_intent: 'GHOSTING', last_reply: 'Thanks', retry_count: 35 }
                        ]);
                        setLoading(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/pending-reviews`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setReviews(data.pending_reviews || []);
                    }
                } catch (error) {
                    console.error('Error fetching reviews:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleApprove = async (id) => {
                if (isDemoMode) {
                    setReviews(reviews.filter(r => r.id !== id));
                    return;
                }

                try {
                    await fetch(`${API_URL}/pending-reviews/${id}/approve`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    fetchReviews();
                } catch (error) {
                    console.error('Error approving review:', error);
                }
            };

            const handleReject = async (id) => {
                if (isDemoMode) {
                    setReviews(reviews.filter(r => r.id !== id));
                    return;
                }

                try {
                    await fetch(`${API_URL}/pending-reviews/${id}/reject`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    fetchReviews();
                } catch (error) {
                    console.error('Error rejecting review:', error);
                }
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Pending Reviews</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                        Review leads that need intent changes or have reached max attempts.
                    </p>

                    {loading ? (
                        <div className="text-center py-8 text-gray-600 dark:text-gray-400">Loading...</div>
                    ) : reviews.length === 0 ? (
                        <div className="bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg p-8 text-center">
                            <p className="text-gray-600 dark:text-gray-400">No pending reviews</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {reviews.map(review => (
                                <div key={review.id} className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-semibold text-gray-800 dark:text-white">
                                                {review.first_name} {review.last_name}
                                            </h3>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">{review.email}</p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <IntentBadge intent={review.current_intent} />
                                            <span className="text-gray-400">‚Üí</span>
                                            <IntentBadge intent={review.suggested_intent} />
                                        </div>
                                    </div>

                                    <div className="mt-4 p-3 bg-gray-50 dark:bg-gray-900 rounded">
                                        <p className="text-sm text-gray-700 dark:text-gray-300">
                                            <strong>Last Reply:</strong> {review.last_reply || 'No reply'}
                                        </p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            Attempts: {review.retry_count}
                                        </p>
                                    </div>

                                    <div className="mt-4 flex space-x-3">
                                        <button
                                            onClick={() => handleApprove(review.id)}
                                            className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                                        >
                                            ‚úì Approve Change
                                        </button>
                                        <button
                                            onClick={() => handleReject(review.id)}
                                            className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-500"
                                        >
                                            ‚úó Keep Current
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function StatusBadge({ status }) {
            const colors = {
                new: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                active: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                replied: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
                interested: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                analyzed: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                customer: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200',
                purchased: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200',
                closed_by_system: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300',
                dead: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300'
            };

            return (
                <span className={`px-2 py-1 text-xs font-medium rounded ${colors[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300'}`}>
                    {status}
                </span>
            );
        }

        function IntentBadge({ intent }) {
            const colors = {
                INTERESTED: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                NOT_NOW: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                OBJECTION: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
                GHOSTING: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300',
                DEAD: 'bg-gray-800 text-white dark:bg-black dark:text-gray-300'
            };

            return (
                <span className={`px-2 py-1 text-xs font-medium rounded ${colors[intent] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300'}`}>
                    {intent}
                </span>
            );
        }

        function DecisionBadge({ decision }) {
            const configs = {
                AUTO_SEND: { color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200', icon: '‚úâÔ∏è', label: 'Auto Send' },
                DRAFT_ONLY: { color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200', icon: 'üìù', label: 'Draft Only' },
                WAIT: { color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200', icon: '‚è∞', label: 'Wait' },
                STOP: { color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200', icon: 'üõë', label: 'Stop' }
            };

            const config = configs[decision] || { color: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300', icon: '‚ùì', label: decision };

            return (
                <span className={`inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${config.color}`}>
                    <span className="mr-1">{config.icon}</span>
                    {config.label}
                </span>
            );
        }

        function getSequenceStatus(seq) {
            if (!seq.is_active) {
                return { label: 'Disabled', cls: 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400', icon: '‚óã' };
            }
            if ((seq.step_count || 0) === 0) {
                return { label: 'Incomplete', cls: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300', icon: '‚óê' };
            }
            if ((seq.active_leads_count || 0) > 0) {
                return { label: 'Running', cls: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300', icon: '‚ñ∂' };
            }
            if ((seq.total_enrolled || 0) === 0) {
                return { label: 'Ready', cls: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300', icon: '‚óè' };
            }
            return { label: 'Completed', cls: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300', icon: '‚úì' };
        }

        // Sequences View Component
        function SequencesView({ token, isDemoMode }) {
            const [sequences, setSequences] = useState([]);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [editingSequence, setEditingSequence] = useState(null);
            const [enrollingSequence, setEnrollingSequence] = useState(null);
            const [openDropdown, setOpenDropdown] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                fetchSequences();
                const interval = setInterval(fetchSequences, 30000);
                return () => clearInterval(interval);
            }, []);

            // When sequences finish loading, check if the dashboard sent us to a specific sequence.
            // The dashboard stores the target sequence_id in localStorage before navigating.
            useEffect(() => {
                if (loading || sequences.length === 0) return;
                const raw = localStorage.getItem('open-sequence-from-dashboard');
                if (!raw) return;
                localStorage.removeItem('open-sequence-from-dashboard');
                const targetId = parseInt(raw, 10);
                const seq = sequences.find(s => s.id === targetId);
                if (seq) openEdit(seq);
            }, [loading, sequences]);

            useEffect(() => {
                const handleClickOutside = () => setOpenDropdown(null);
                if (openDropdown) {
                    document.addEventListener('click', handleClickOutside);
                    return () => document.removeEventListener('click', handleClickOutside);
                }
            }, [openDropdown]);

            const fetchSequences = async () => {
                if (isDemoMode) {
                    setTimeout(() => {
                        setSequences(DEMO_DATA.sequences);
                        setLoading(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/sequences`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    setSequences(data.sequences);
                } catch (error) {
                    console.error('Error fetching sequences:', error);
                    setSequences(DEMO_DATA.sequences);
                } finally {
                    setLoading(false);
                }
            };

            const createSequence = async (sequenceData) => {
                if (isDemoMode) {
                    const newSequence = {
                        id: sequences.length + 1,
                        ...sequenceData,
                        is_active: false
                    };
                    setSequences([...sequences, newSequence]);
                    setShowCreateForm(false);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/sequences`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(sequenceData)
                    });

                    if (response.ok) {
                        fetchSequences();
                        setShowCreateForm(false);
                    }
                } catch (error) {
                    console.error('Error creating sequence:', error);
                }
            };

            const updateSequence = async (sequenceId, sequenceData) => {
                if (isDemoMode) {
                    setSequences(sequences.map(s => s.id === sequenceId ? { ...s, ...sequenceData } : s));
                    setEditingSequence(null);
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/sequences/${sequenceId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(sequenceData)
                    });
                    if (response.ok) {
                        fetchSequences();
                        setEditingSequence(null);
                    } else {
                        const errData = await response.json().catch(() => ({}));
                        console.error('Update sequence failed:', response.status, errData);
                        alert('Save failed: ' + (errData.error || response.status));
                    }
                } catch (error) {
                    console.error('Error updating sequence:', error);
                    alert('Save failed: ' + error.message);
                }
            };

            // Load full sequence data then open edit or send modal
            const openEdit = async (sequence) => {
                if (isDemoMode) {
                    setEditingSequence({
                        sequence,
                        steps: sequence.steps || [{ delay_days: 0, subject: '', email_template: '', attachments: [] }]
                    });
                    return;
                }
                try {
                    const r = await fetch(`${API_URL}/sequences/${sequence.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (r.ok) setEditingSequence(await r.json());
                } catch { setEditingSequence({ sequence, steps: [] }); }
            };

            const openSend = async (sequence) => {
                if (isDemoMode) {
                    setEnrollingSequence({
                        sequence,
                        steps: sequence.steps || [{ delay_days: 0, subject: '', email_template: '', attachments: [] }]
                    });
                    return;
                }
                try {
                    const r = await fetch(`${API_URL}/sequences/${sequence.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (r.ok) setEnrollingSequence(await r.json());
                } catch { setEnrollingSequence({ sequence, steps: [] }); }
            };

            const deleteSequence = async (sequenceId) => {
                if (!confirm('Are you sure you want to delete this sequence?')) return;

                try {
                    const response = await fetch(`${API_URL}/sequences/${sequenceId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        fetchSequences();
                    }
                } catch (error) {
                    console.error('Error deleting sequence:', error);
                }
            };

            const toggleSequenceActive = async (sequenceId, currentStatus) => {
                try {
                    const response = await fetch(`${API_URL}/sequences/${sequenceId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_active: !currentStatus })
                    });

                    if (response.ok) {
                        fetchSequences();
                    }
                } catch (error) {
                    console.error('Error updating sequence:', error);
                }
            };

            // Filter sequences by name, description, step subjects, and step body text.
            // step_subjects and step_bodies are provided by the backend list API.
            const filteredSequences = React.useMemo(() => {
                const q = searchQuery.trim().toLowerCase();
                if (!q) return sequences;
                return sequences.filter(seq => {
                    if ((seq.name || '').toLowerCase().includes(q)) return true;
                    if ((seq.description || '').toLowerCase().includes(q)) return true;
                    if ((seq.step_subjects || []).some(s => s.toLowerCase().includes(q))) return true;
                    if ((seq.step_bodies || []).some(b => b.toLowerCase().includes(q))) return true;
                    return false;
                });
            }, [sequences, searchQuery]);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Email Sequences</h2>
                        <button
                            onClick={() => setShowCreateForm(true)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                            + Create Sequence
                        </button>
                    </div>

                    {/* Search bar ‚Äî searches sequence name, description, step subjects, and email body text */}
                    <div className="relative">
                        <span className="absolute inset-y-0 left-3 flex items-center text-gray-400 pointer-events-none">üîç</span>
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="Search sequences by name, subject line, or email content..."
                            className="w-full pl-9 pr-9 py-2 text-sm border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                        {searchQuery && (
                            <button
                                onClick={() => setSearchQuery('')}
                                className="absolute inset-y-0 right-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
                            >‚úï</button>
                        )}
                    </div>

                    {showCreateForm && (
                        <CreateSequenceForm
                            onSubmit={createSequence}
                            onCancel={() => setShowCreateForm(false)}
                        />
                    )}

                    {loading ? (
                        <div className="text-center py-8">Loading sequences...</div>
                    ) : sequences.length === 0 ? (
                        <div className="bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg p-8 text-center">
                            <p className="text-gray-600 dark:text-gray-400 mb-4">No sequences yet. Create your first sequence!</p>
                        </div>
                    ) : filteredSequences.length === 0 ? (
                        <div className="bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg p-8 text-center">
                            <p className="text-gray-600 dark:text-gray-400">No sequences match <strong>"{searchQuery}"</strong></p>
                            <button onClick={() => setSearchQuery('')} className="mt-2 text-sm text-blue-600 dark:text-blue-400 hover:underline">Clear search</button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {filteredSequences.map(sequence => (
                                <div
                                    key={sequence.id}
                                    className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-5 hover:shadow-xl hover:border-blue-400 dark:hover:border-blue-600 transition-all flex flex-col"
                                >
                                    {/* Top row: status badge + 3-dot menu */}
                                    <div className="flex items-start justify-between mb-3">
                                        {(() => { const s = getSequenceStatus(sequence); return (
                                            <span className={`px-2 py-0.5 text-xs font-medium rounded ${s.cls}`}>
                                                {s.icon} {s.label}
                                            </span>
                                        ); })()}
                                        <div className="relative">
                                            <button
                                                onClick={(e) => { e.stopPropagation(); setOpenDropdown(openDropdown === sequence.id ? null : sequence.id); }}
                                                className="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 leading-none"
                                            >‚ãÆ</button>
                                            {openDropdown === sequence.id && (
                                                <div className="absolute right-0 mt-1 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-10">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); toggleSequenceActive(sequence.id, sequence.is_active); setOpenDropdown(null); }}
                                                        className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white"
                                                    >{sequence.is_active ? '‚è∏ Disable' : '‚ñ∂ Enable'}</button>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); deleteSequence(sequence.id); setOpenDropdown(null); }}
                                                        className="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                                                    >üóë Delete</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Sequence info */}
                                    <div className="flex-1 mb-4">
                                        <h3 className="text-base font-semibold dark:text-white mb-1">{sequence.name}</h3>
                                        {sequence.description && (
                                            <p className="text-sm text-gray-500 dark:text-gray-400 line-clamp-2">{sequence.description}</p>
                                        )}
                                    </div>

                                    {/* Direct action buttons ‚Äî 1 click */}
                                    <div className="flex gap-2 pt-3 border-t border-gray-100 dark:border-gray-800">
                                        <button
                                            onClick={() => openEdit(sequence)}
                                            className="flex-1 px-3 py-2 text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300 transition-colors"
                                        >‚úèÔ∏è Edit</button>
                                        <button
                                            onClick={() => openSend(sequence)}
                                            className="flex-1 px-3 py-2 text-sm font-medium bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors"
                                        >üì§ Send to Leads</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {editingSequence && (
                        <EditSequenceForm
                            data={editingSequence}
                            onSubmit={(data) => updateSequence(editingSequence.sequence.id, data)}
                            onCancel={() => setEditingSequence(null)}
                        />
                    )}

                    {enrollingSequence && (
                        <SendSequenceModal
                            token={token}
                            isDemoMode={isDemoMode}
                            sequenceData={enrollingSequence}
                            onClose={() => { setEnrollingSequence(null); fetchSequences(); }}
                        />
                    )}
                </div>
            );
        }

        // Emails View Component
        function EmailsView({ token, isDemoMode, darkMode }) {
            const [emails, setEmails] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('all'); // all, pending, sent, failed
            const [sendingMode, setSendingMode] = useState('manual'); // Can be 'auto' or 'manual'

            useEffect(() => {
                fetchAutoModeSettings();
                fetchEmails();
            }, []);

            const fetchAutoModeSettings = async () => {
                if (isDemoMode) return;
                try {
                    const response = await fetch(`${API_URL}/settings/auto-mode`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setSendingMode(data.auto_mode_enabled ? 'auto' : 'manual');
                    }
                } catch (error) {
                    console.error('Error fetching auto-mode settings:', error);
                }
            };

            const fetchEmails = async () => {
                if (isDemoMode) {
                    setTimeout(() => {
                        setEmails([
                            { id: 1, lead_name: 'John Doe', lead_email: 'john@example.com', subject: 'Re: Following up', status: 'sent', sent_at: new Date(Date.now() - 3600000), ai_drafted: true, draft_body: 'Hi John, thanks for getting back to me...' },
                            { id: 2, lead_name: 'Jane Smith', lead_email: 'jane@example.com', subject: 'Re: Following up', status: 'pending', sent_at: null, ai_drafted: true, draft_body: 'Hi Jane, I wanted to follow up on our conversation...' },
                            { id: 3, lead_name: 'Bob Wilson', lead_email: 'bob@example.com', subject: 'Re: Following up', status: 'pending', sent_at: null, ai_drafted: true, draft_body: 'Hi Bob, just checking in to see if you had any questions...' },
                        ]);
                        setLoading(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/drafts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setEmails(data.drafts || []);
                    }
                } catch (error) {
                    console.error('Error fetching drafts:', error);
                } finally {
                    setLoading(false);
                }
            };

            const [editingDraft, setEditingDraft] = useState(null);
            const [editBody, setEditBody] = useState('');

            const sendEmail = async (draftId, editedBody = null) => {
                try {
                    const response = await fetch(`${API_URL}/drafts/${draftId}/send`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(editedBody ? { edited_body: editedBody } : {})
                    });
                    if (response.ok) {
                        setEmails(prev => prev.filter(e => e.id !== draftId));
                        setEditingDraft(null);
                        setEditBody('');
                    }
                } catch (error) {
                    console.error('Error sending email:', error);
                }
            };

            const startEditing = (email) => {
                setEditingDraft(email.id);
                setEditBody(email.draft_body || '');
            };

            // In auto mode, only show needs_follow_up drafts; in manual mode, show all
            const filteredEmails = (filter === 'all' ? emails : emails.filter(e => e.status === filter))
                .filter(e => sendingMode === 'auto' ? e.needs_follow_up : true);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Emails</h2>
                        {sendingMode === 'auto' && (
                            <div className="px-4 py-3 bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-lg text-sm font-semibold border border-green-200 dark:border-green-800">
                                ü§ñ AI is auto-replying to all leads
                            </div>
                        )}
                    </div>

                    {/* Email Mode Info */}
                    {sendingMode === 'auto' && (
                        <div className="bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-500 dark:border-orange-600 rounded-lg p-4">
                            <p className="text-sm text-orange-900 dark:text-orange-200 font-medium">
                                ‚ö†Ô∏è <strong>Drafts below need your attention</strong> ‚Äî the AI couldn't answer the customer's question. Review each one, edit with the real answer, and send.
                            </p>
                        </div>
                    )}
                    {sendingMode === 'manual' && (
                        <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                            <p className="text-sm text-blue-800 dark:text-blue-300">
                                <strong>üìß Manual Mode:</strong> You review and approve AI-generated emails before sending.
                            </p>
                        </div>
                    )}

                    {/* Filter Tabs */}
                    {sendingMode === 'manual' && (
                        <div className="flex space-x-2">
                            <button
                                onClick={() => setFilter('all')}
                                className={`px-4 py-2 rounded-lg font-medium transition ${filter === 'all' ? 'bg-blue-600 text-white dark:bg-blue-700' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'}`}
                            >
                                All ({emails.length})
                            </button>
                            <button
                                onClick={() => setFilter('pending')}
                                className={`px-4 py-2 rounded-lg font-medium transition ${filter === 'pending' ? 'bg-yellow-600 text-white dark:bg-yellow-700' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'}`}
                            >
                                Pending ({emails.filter(e => e.status === 'pending').length})
                            </button>
                            <button
                                onClick={() => setFilter('sent')}
                                className={`px-4 py-2 rounded-lg font-medium transition ${filter === 'sent' ? 'bg-green-600 text-white dark:bg-green-700' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'}`}
                            >
                                Sent ({emails.filter(e => e.status === 'sent').length})
                            </button>
                            <button
                                onClick={() => setFilter('failed')}
                                className={`px-4 py-2 rounded-lg font-medium transition ${filter === 'failed' ? 'bg-red-600 text-white dark:bg-red-700' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'}`}
                            >
                                Failed ({emails.filter(e => e.status === 'failed').length})
                            </button>
                        </div>
                    )}

                    {/* Email List */}
                    {loading ? (
                        <div className="text-center py-8">
                            <p className="text-gray-600 dark:text-gray-400">Loading emails...</p>
                        </div>
                    ) : filteredEmails.length === 0 ? (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-8 text-center">
                            {sendingMode === 'auto' ? (
                                <>
                                    <p className="text-gray-600 dark:text-gray-400 mb-2 font-medium">‚úÖ All caught up!</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-500">
                                        The AI is auto-replying to all leads. Drafts will only appear here when the AI encounters a question it can't answer.
                                    </p>
                                </>
                            ) : (
                                <>
                                    <p className="text-gray-600 dark:text-gray-400 mb-2">No {filter !== 'all' ? filter : ''} emails yet.</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-500">
                                        Emails will appear here when replies are analyzed and approved by AI.
                                    </p>
                                </>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {filteredEmails.map(email => (
                                <div key={email.id} className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-4">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <div className="flex items-center space-x-3 mb-2">
                                                <h3 className="font-semibold text-gray-900 dark:text-white">{email.lead_name}</h3>
                                                <span className={`px-2 py-1 text-xs font-medium rounded ${
                                                    email.status === 'sent' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' :
                                                    email.status === 'pending' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
                                                    'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'
                                                }`}>
                                                    {email.status.charAt(0).toUpperCase() + email.status.slice(1)}
                                                </span>
                                                {email.ai_drafted && (
                                                    <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded">
                                                        AI Drafted
                                                    </span>
                                                )}
                                                {email.needs_follow_up && (
                                                    <span className="px-3 py-1 text-xs font-bold bg-orange-200 text-orange-900 dark:bg-orange-600 dark:text-white rounded-full animate-pulse border border-orange-400 dark:border-orange-500">
                                                        ‚ö†Ô∏è Needs Your Reply
                                                    </span>
                                                )}
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">{email.lead_email}</p>
                                            <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Subject: {email.subject || 'Re: Following up'}</p>
                                            {email.needs_follow_up && email.reply_text && (
                                                <div className="bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-500 dark:border-orange-600 rounded-lg p-3 mt-2 mb-3">
                                                    <p className="text-xs font-bold text-orange-900 dark:text-orange-200 mb-2 uppercase tracking-wide">üìã Customer Asked:</p>
                                                    <p className="text-sm text-orange-900 dark:text-orange-200 italic mb-2 bg-white dark:bg-gray-900 p-2 rounded border border-orange-200 dark:border-orange-800">
                                                        "{email.reply_text.substring(0, 250)}{email.reply_text.length > 250 ? '...' : ''}"
                                                    </p>
                                                    <p className="text-xs text-orange-700 dark:text-orange-300 font-medium">AI sent a holding reply. Edit the draft below with your real answer and click Send Reply.</p>
                                                </div>
                                            )}
                                            {(email.draft_body || email.final_body) && (
                                                <p className="text-sm text-gray-500 dark:text-gray-400 italic bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-2 mt-2 mb-2">
                                                    {(email.draft_body || email.final_body || '').substring(0, 120)}{(email.draft_body || email.final_body || '').length > 120 ? '...' : ''}
                                                </p>
                                            )}
                                            {email.sent_at && (
                                                <p className="text-xs text-gray-500 dark:text-gray-500">
                                                    Sent: {new Date(email.sent_at).toLocaleString()}
                                                </p>
                                            )}
                                        </div>
                                        {email.status === 'pending' && !email.needs_follow_up && (
                                            <button
                                                onClick={() => sendEmail(email.id)}
                                                className="ml-4 px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 text-sm font-medium whitespace-nowrap"
                                            >
                                                Send Now
                                            </button>
                                        )}
                                        {email.status === 'pending' && email.needs_follow_up && editingDraft !== email.id && (
                                            <button
                                                onClick={() => startEditing(email)}
                                                className="ml-4 px-4 py-2 bg-orange-600 dark:bg-orange-700 text-white rounded-lg hover:bg-orange-700 dark:hover:bg-orange-600 text-sm font-medium whitespace-nowrap"
                                            >
                                                Write Reply
                                            </button>
                                        )}
                                    </div>
                                    {editingDraft === email.id && (
                                        <div className="mt-3 border-t-2 border-orange-300 dark:border-orange-700 pt-4">
                                            <div className="bg-orange-50 dark:bg-orange-900/10 border border-orange-200 dark:border-orange-800 rounded-lg p-3 mb-3">
                                                <p className="text-xs font-semibold text-orange-900 dark:text-orange-200 uppercase">üìù AI Draft (pre-filled):</p>
                                                <p className="text-sm text-gray-700 dark:text-gray-300 italic mt-1 bg-white dark:bg-gray-900 p-2 rounded">{email.draft_body}</p>
                                            </div>
                                            <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">‚úèÔ∏è Edit with your real answer:</label>
                                            <textarea
                                                value={editBody}
                                                onChange={(e) => setEditBody(e.target.value)}
                                                className="w-full h-32 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm resize-y focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                                placeholder="Write your real answer here..."
                                            />
                                            <div className="flex space-x-2 mt-3">
                                                <button
                                                    onClick={() => sendEmail(email.id, editBody)}
                                                    className="px-4 py-2 bg-green-600 dark:bg-green-700 text-white rounded-lg hover:bg-green-700 dark:hover:bg-green-600 text-sm font-bold"
                                                >
                                                    ‚úì Send Reply
                                                </button>
                                                <button
                                                    onClick={() => { setEditingDraft(null); setEditBody(''); }}
                                                    className="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 text-sm font-medium"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function InboxView({ token, isDemoMode, darkMode }) {
            const [threads, setThreads] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedThread, setSelectedThread] = useState(null);
            const [lastCheck, setLastCheck] = useState(new Date());
            const [isAutoRefreshing, setIsAutoRefreshing] = useState(true);
            const [checkingEmails, setCheckingEmails] = useState(false);
            const [cleaningUp, setCleaningUp] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                fetchThreads();

                // Auto-refresh every 10 seconds
                const interval = setInterval(() => {
                    if (isAutoRefreshing) {
                        fetchThreads();
                        setLastCheck(new Date());
                    }
                }, 10000); // 10 seconds

                return () => clearInterval(interval);
            }, [isAutoRefreshing]);

            const fetchThreads = async (showLoading = false) => {
                if (showLoading) setLoading(true);
                if (isDemoMode) {
                    setTimeout(() => {
                        setThreads([
                            {
                                id: 1,
                                lead_name: 'John Doe',
                                lead_email: 'john@example.com',
                                lead_company: 'Acme Inc',
                                subject: 'Re: Product Inquiry',
                                body: 'Thanks for reaching out! I\'m interested in learning more about your product.',
                                received_at: new Date(Date.now() - 3600000).toISOString(),
                                ai_intent: 'INTERESTED',
                                lead_status: 'interested'
                            },
                            {
                                id: 2,
                                lead_name: 'Jane Smith',
                                lead_email: 'jane@example.com',
                                lead_company: 'Tech Corp',
                                subject: 'Re: Follow-up',
                                body: 'Not right now, maybe later this quarter.',
                                received_at: new Date(Date.now() - 7200000).toISOString(),
                                ai_intent: 'NOT_NOW',
                                lead_status: 'not_now'
                            }
                        ]);
                        setLoading(false);
                    }, 500);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/emails/interactions`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setThreads(data.threads || []);
                    }
                } catch (error) {
                    console.error('Error fetching email threads:', error);
                } finally {
                    setLoading(false);
                }
            };

            const checkForNewEmails = async () => {
                setCheckingEmails(true);
                try {
                    const response = await fetch(`${API_URL}/emails/check`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        alert(`‚úÖ Found ${data.new_replies} new ${data.new_replies === 1 ? 'reply' : 'replies'}!`);
                        fetchThreads(); // Refresh the list
                    } else {
                        const error = await response.json();
                        alert(`‚ùå Error: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error checking emails:', error);
                    alert('Failed to check emails. Please try again.');
                } finally {
                    setCheckingEmails(false);
                }
            };

            const cleanupDuplicates = async () => {
                if (!confirm('This will remove duplicate emails from your inbox. Continue?')) {
                    return;
                }

                setCleaningUp(true);
                try {
                    const response = await fetch(`${API_URL}/emails/cleanup-duplicates`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        alert(`‚úÖ ${data.message}`);
                        fetchThreads(); // Refresh the list
                    } else {
                        const error = await response.json();
                        alert(`‚ùå Error: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error cleaning up duplicates:', error);
                    alert('Failed to clean up duplicates. Please try again.');
                } finally {
                    setCleaningUp(false);
                }
            };

            const getIntentBadgeColor = (intent) => {
                switch(intent) {
                    case 'INTERESTED': return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
                    case 'NOT_NOW': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
                    case 'OBJECTION': return 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300';
                    case 'GHOSTING': return 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300';
                    case 'DEAD': return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
                    default: return 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300';
                }
            };

            const getIntentEmoji = (intent) => {
                switch(intent) {
                    case 'INTERESTED': return 'üî•';
                    case 'NOT_NOW': return '‚è∞';
                    case 'OBJECTION': return '‚ùì';
                    case 'GHOSTING': return 'üëª';
                    case 'DEAD': return '‚ùå';
                    default: return 'üìß';
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Email Inbox</h2>
                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Auto-refreshes every 10 seconds ‚Ä¢ Last check: {lastCheck.toLocaleTimeString()}
                            </p>
                        </div>
                        <div className="flex items-center space-x-2 px-4 py-2 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                            <span className="relative flex h-3 w-3">
                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </span>
                            <span className="text-sm font-medium text-green-700 dark:text-green-300">Live</span>
                        </div>
                    </div>

                    {/* Info Box */}
                    <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <p className="text-sm text-blue-800 dark:text-blue-300">
                            <strong>‚ú® Fully Automatic:</strong> Emails are checked by server every 60 seconds and this page refreshes every 10 seconds. New emails appear automatically!
                        </p>
                    </div>

                    {/* Search Bar */}
                    <div className="relative">
                        <span className="absolute inset-y-0 left-3 flex items-center text-gray-400 pointer-events-none">üîç</span>
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="Search by email or message content..."
                            className="w-full pl-9 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>

                    {loading ? (
                        <div className="text-center py-12">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p className="text-gray-600 dark:text-gray-400 mt-4">Loading inbox...</p>
                        </div>
                    ) : (() => {
                        const q = searchQuery.trim().toLowerCase();
                        const filteredThreads = q
                            ? threads.filter(t =>
                                (t.lead_email || '').toLowerCase().includes(q) ||
                                (t.lead_name || '').toLowerCase().includes(q) ||
                                (t.body || '').toLowerCase().includes(q) ||
                                (t.subject || '').toLowerCase().includes(q)
                              )
                            : threads;
                        return filteredThreads.length === 0 ? (
                        <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-12 text-center">
                            <div className="text-6xl mb-4">üì≠</div>
                            <h3 className="text-xl font-semibold text-gray-800 dark:text-white mb-2">{q ? 'No matching emails' : 'No emails yet'}</h3>
                            <p className="text-gray-600 dark:text-gray-400 mb-4">
                                {q ? 'Try a different search term.' : 'Customer replies will appear here automatically when they respond.'}
                            </p>
                            {!q && <p className="text-sm text-gray-500 dark:text-gray-500">
                                The system checks for new emails every 60 seconds in the background.
                            </p>}
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {filteredThreads.map(thread => (
                                <div
                                    key={thread.id}
                                    className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg hover:shadow-xl transition-shadow cursor-pointer"
                                    onClick={() => setSelectedThread(selectedThread?.id === thread.id ? null : thread)}
                                >
                                    <div className="p-5">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex-1">
                                                <div className="flex items-center space-x-3 mb-2">
                                                    <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                                                        {thread.lead_name || 'Unknown Lead'}
                                                    </h3>
                                                </div>
                                                <p className="text-sm text-gray-600 dark:text-gray-400">
                                                    {thread.lead_email} {thread.lead_company && `‚Ä¢ ${thread.lead_company}`}
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-gray-500 dark:text-gray-500">
                                                    {new Date(thread.received_at).toLocaleString()}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="mb-3">
                                            <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                <strong>Subject:</strong> {thread.subject || '(No Subject)'}
                                            </p>
                                        </div>

                                        {/* Email Body Preview */}
                                        <div className="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                                            <p className="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                                                {selectedThread?.id === thread.id
                                                    ? thread.body
                                                    : thread.body.substring(0, 150) + (thread.body.length > 150 ? '...' : '')
                                                }
                                            </p>
                                        </div>

                                        {/* Expand/Collapse Indicator */}
                                        <div className="mt-3 text-center">
                                            <button className="text-xs text-blue-600 dark:text-blue-400 hover:underline">
                                                {selectedThread?.id === thread.id ? '‚ñ≤ Show Less' : '‚ñº Show More'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                    })()}
                </div>
            );
        }

        function CreateSequenceForm({ onSubmit, onCancel }) {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [steps, setSteps] = useState([
                { delay_days: 0, delay_unit: 'days', subject: '', email_template: '', attachments: [] }
            ]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit({ name, description, steps });
            };

            const addStep = () => {
                setSteps([...steps, { delay_days: 3, delay_unit: 'days', subject: '', email_template: '', attachments: [] }]);
            };

            return (
                <div className="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg p-6">
                    <h3 className="text-lg font-semibold mb-4 dark:text-white">Create New Sequence</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Sequence Name *
                            </label>
                            <input
                                type="text"
                                required
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                placeholder="e.g., Standard 7-Day Follow-Up"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Description
                            </label>
                            <textarea
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                rows="2"
                                placeholder="What's this sequence for?"
                            />
                        </div>

                        <div className="space-y-3">
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Email Steps
                            </label>
                            {steps.map((step, index) => (
                                <div key={index} className="border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-3">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3">
                                            <span className="font-medium dark:text-white">Step {index + 1}</span>
                                            <input
                                                type="number"
                                                value={step.delay_days}
                                                onChange={(e) => {
                                                    const newSteps = [...steps];
                                                    newSteps[index].delay_days = parseInt(e.target.value) || 0;
                                                    setSteps(newSteps);
                                                }}
                                                className="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                                min="0"
                                            />
                                            <div className="flex rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600 text-xs font-medium">
                                                <button type="button"
                                                    onClick={() => { const ns = [...steps]; ns[index].delay_unit = 'days'; setSteps(ns); }}
                                                    className={`px-2 py-1 transition-colors ${(step.delay_unit || 'days') === 'days' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                                                >Days</button>
                                                <button type="button"
                                                    onClick={() => { const ns = [...steps]; ns[index].delay_unit = 'minutes'; setSteps(ns); }}
                                                    className={`px-2 py-1 transition-colors ${(step.delay_unit || 'days') === 'minutes' ? 'bg-orange-500 text-white' : 'bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                                                >Mins ‚ö°</button>
                                            </div>
                                        </div>
                                        {steps.length > 1 && (
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    const newSteps = steps.filter((_, i) => i !== index);
                                                    setSteps(newSteps);
                                                }}
                                                className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm"
                                            >
                                                Remove Step
                                            </button>
                                        )}
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                            Subject Line
                                        </label>
                                        <input
                                            type="text"
                                            value={step.subject || ''}
                                            onChange={(e) => {
                                                const newSteps = [...steps];
                                                newSteps[index].subject = e.target.value;
                                                setSteps(newSteps);
                                            }}
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white mb-3"
                                            placeholder="e.g., Quick question about {{company}}"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Email Content
                                        </label>
                                        <RichTextEditor
                                            content={step.email_template}
                                            onChange={(html) => {
                                                const newSteps = [...steps];
                                                newSteps[index].email_template = html;
                                                setSteps(newSteps);
                                            }}
                                            placeholder="Write your email template here..."
                                        />
                                    </div>

                                    <AttachmentManager
                                        attachments={step.attachments || []}
                                        onAdd={(attachment) => {
                                            const newSteps = [...steps];
                                            newSteps[index].attachments = [...(newSteps[index].attachments || []), attachment];
                                            setSteps(newSteps);
                                        }}
                                        onRemove={(attachmentIndex) => {
                                            const newSteps = [...steps];
                                            newSteps[index].attachments = newSteps[index].attachments.filter((_, i) => i !== attachmentIndex);
                                            setSteps(newSteps);
                                        }}
                                    />
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={addStep}
                                className="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300"
                            >
                                + Add Step
                            </button>
                        </div>

                        <div className="flex space-x-3">
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Create Sequence
                            </button>
                            <button
                                type="button"
                                onClick={onCancel}
                                className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        // ============================================
        // EDIT SEQUENCE FORM
        // ============================================

        function EditSequenceForm({ data, onSubmit, onCancel }) {
            const [name, setName] = useState(data.sequence.name || '');
            const [description, setDescription] = useState(data.sequence.description || '');
            const [steps, setSteps] = useState(
                (data.steps && data.steps.length > 0)
                    ? data.steps.map(s => ({ delay_days: s.delay_days || 0, delay_unit: s.delay_unit || 'days', subject: s.subject || '', email_template: s.email_template || '', attachments: s.attachments || [] }))
                    : [{ delay_days: 0, delay_unit: 'days', subject: '', email_template: '', attachments: [] }]
            );

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit({ name, description, steps });
            };

            const addStep = () => setSteps([...steps, { delay_days: 3, delay_unit: 'days', subject: '', email_template: '', attachments: [] }]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-6 flex justify-between items-center">
                            <h3 className="text-xl font-semibold dark:text-white">Edit Sequence</h3>
                            <button onClick={onCancel} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                        </div>
                        <div className="p-6">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sequence Name *</label>
                                    <input type="text" required value={name} onChange={(e) => setName(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                                    <textarea value={description} onChange={(e) => setDescription(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white" rows="2" />
                                </div>
                                <div className="space-y-3">
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Steps</label>
                                    {steps.map((step, index) => (
                                        <div key={index} className="border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-3">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-3">
                                                    <span className="font-medium dark:text-white">Step {index + 1}</span>
                                                    <input type="number" value={step.delay_days}
                                                        onChange={(e) => setSteps(steps.map((s, i) => i === index ? { ...s, delay_days: parseInt(e.target.value) || 0 } : s))}
                                                        className="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white" min="0" />
                                                    <div className="flex rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600 text-xs font-medium">
                                                        <button type="button"
                                                            onClick={() => setSteps(steps.map((s, i) => i === index ? { ...s, delay_unit: 'days' } : s))}
                                                            className={`px-2 py-1 transition-colors ${(step.delay_unit || 'days') === 'days' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                                        >Days</button>
                                                        <button type="button"
                                                            onClick={() => setSteps(steps.map((s, i) => i === index ? { ...s, delay_unit: 'minutes' } : s))}
                                                            className={`px-2 py-1 transition-colors ${(step.delay_unit || 'days') === 'minutes' ? 'bg-orange-500 text-white' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                                        >Mins ‚ö°</button>
                                                    </div>
                                                </div>
                                                {steps.length > 1 && (
                                                    <button type="button" onClick={() => setSteps(steps.filter((_, i) => i !== index))}
                                                        className="text-red-600 hover:text-red-800 dark:text-red-400 text-sm">Remove Step</button>
                                                )}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject Line</label>
                                                <input type="text" value={step.subject || ''}
                                                    onChange={(e) => setSteps(steps.map((s, i) => i === index ? { ...s, subject: e.target.value } : s))}
                                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white mb-3"
                                                    placeholder="e.g., Quick question about {{company}}" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Content</label>
                                                <RichTextEditor content={step.email_template}
                                                    onChange={(html) => setSteps(steps.map((s, i) => i === index ? { ...s, email_template: html } : s))}
                                                    placeholder="Write your email template here..." />
                                            </div>
                                            <AttachmentManager attachments={step.attachments || []}
                                                onAdd={(att) => setSteps(steps.map((s, i) => i === index ? { ...s, attachments: [...(s.attachments || []), att] } : s))}
                                                onRemove={(ri) => setSteps(steps.map((s, i) => i === index ? { ...s, attachments: (s.attachments || []).filter((_, j) => j !== ri) } : s))} />
                                        </div>
                                    ))}
                                    <button type="button" onClick={addStep}
                                        className="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                                        + Add Step
                                    </button>
                                </div>
                                <div className="flex space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                                    <button type="button" onClick={onCancel}
                                        className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // SEND SEQUENCE MODAL (enroll leads)
        // ============================================

        function SendSequenceModal({ token, isDemoMode, sequenceData, onClose }) {
            const [leads, setLeads] = useState([]);
            const [selectedLeads, setSelectedLeads] = useState([]);
            const [intentFilter, setIntentFilter] = useState([]);
            const step1Subject = sequenceData.steps && sequenceData.steps[0] ? sequenceData.steps[0].subject || '' : '';
            const [sending, setSending] = useState(false);
            const [loading, setLoading] = useState(true);
            const [result, setResult] = useState(null);

            const INTENTS = [
                { key: 'INTERESTED', label: 'Interested üî•', color: 'text-green-600 dark:text-green-400' },
                { key: 'NOT_NOW', label: 'Not Now ‚è∞', color: 'text-yellow-600 dark:text-yellow-400' },
                { key: 'OBJECTION', label: 'Objection üí°', color: 'text-orange-600 dark:text-orange-400' },
                { key: 'GHOSTING', label: 'Ghosting üëª', color: 'text-purple-600 dark:text-purple-400' },
                { key: 'DEAD', label: 'Dead ‚ùå', color: 'text-red-600 dark:text-red-400' },
                { key: 'none', label: 'No intent yet', color: 'text-gray-500 dark:text-gray-400' },
            ];

            useEffect(() => {
                if (isDemoMode) {
                    setLeads([
                        { id: 1, first_name: 'John', last_name: 'Doe', email: 'john@example.com', company: 'Acme', ai_intent: null, intent_level: 'high' },
                        { id: 2, first_name: 'Jane', last_name: 'Smith', email: 'jane@example.com', company: 'Tech Inc', ai_intent: 'NOT_NOW', intent_level: 'medium' },
                        { id: 3, first_name: 'Bob', last_name: 'Wilson', email: 'bob@example.com', company: 'Corp', ai_intent: 'GHOSTING', intent_level: 'low' },
                    ]);
                    setLoading(false);
                    return;
                }
                fetch(`${API_URL}/leads`, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(r => r.json()).then(d => { setLeads(d.leads || []); setLoading(false); })
                    .catch(() => setLoading(false));
            }, []);

            const toggleIntent = (key) => {
                setIntentFilter(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
            };

            const filteredLeads = intentFilter.length === 0 ? leads : leads.filter(lead => {
                if (intentFilter.includes('none') && !lead.ai_intent) return true;
                return intentFilter.includes(lead.ai_intent);
            });

            const toggleLead = (id) => setSelectedLeads(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
            const toggleAll = () => setSelectedLeads(selectedLeads.length === filteredLeads.length ? [] : filteredLeads.map(l => l.id));

            const handleSend = async () => {
                if (selectedLeads.length === 0) return alert('Select at least one lead');
                setSending(true);
                if (isDemoMode) {
                    setTimeout(() => { setResult({ success: selectedLeads.length, failed: 0 }); setSending(false); }, 800);
                    return;
                }
                try {
                    const r = await fetch(`${API_URL}/sequences/${sequenceData.sequence.id}/enroll`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lead_ids: selectedLeads })
                    });
                    const d = await r.json();
                    if (r.ok) {
                        setResult({ success: (d.results?.success?.length || 0), failed: (d.results?.failed?.length || 0), message: d.message });
                    } else {
                        alert(d.error || 'Failed to enroll leads');
                    }
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setSending(false);
                }
            };

            if (result) return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                        <div className="text-4xl mb-4">üì§</div>
                        <h3 className="text-lg font-bold dark:text-white mb-2">{result.message || 'Sequence sent!'}</h3>
                        <p className="text-green-600 dark:text-green-400">‚úÖ {result.success} lead(s) enrolled</p>
                        {result.failed > 0 && <p className="text-red-600 dark:text-red-400">‚ùå {result.failed} failed</p>}
                        <button onClick={onClose} className="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Done</button>
                    </div>
                </div>
            );

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-5 flex justify-between items-center">
                            <div>
                                <h3 className="text-lg font-bold dark:text-white">Send Sequence to Leads</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400">{sequenceData.sequence.name} ¬∑ {sequenceData.steps.length} step(s)</p>
                            </div>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                        </div>
                        <div className="p-5 space-y-4">
                            {step1Subject && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject (from Step 1)</label>
                                    <p className="px-3 py-2 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm">{step1Subject}</p>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter by Lead Intent</label>
                                <div className="flex flex-wrap gap-2">
                                    {INTENTS.map(intent => (
                                        <button key={intent.key} type="button"
                                            onClick={() => toggleIntent(intent.key)}
                                            className={`px-3 py-1 rounded-full text-sm border transition-all ${intentFilter.includes(intent.key) ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-300 dark:border-gray-600 dark:text-gray-300 hover:border-blue-400'}`}>
                                            {intent.label}
                                        </button>
                                    ))}
                                </div>
                                {intentFilter.length > 0 && <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Showing {filteredLeads.length} lead(s) matching selected intent(s)</p>}
                            </div>
                            <div>
                                <div className="flex items-center justify-between mb-2">
                                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Select Leads ({selectedLeads.length} selected)</label>
                                    <button type="button" onClick={toggleAll}
                                        className="text-xs text-blue-600 dark:text-blue-400 hover:underline">
                                        {selectedLeads.length === filteredLeads.length && filteredLeads.length > 0 ? 'Deselect all' : 'Select all'}
                                    </button>
                                </div>
                                {loading ? <p className="text-sm text-gray-400">Loading leads...</p> : filteredLeads.length === 0 ? (
                                    <p className="text-sm text-gray-400 dark:text-gray-500 py-4 text-center">No leads match this filter</p>
                                ) : (
                                    <div className="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden max-h-64 overflow-y-auto">
                                        {filteredLeads.map(lead => (
                                            <label key={lead.id} className="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer border-b border-gray-100 dark:border-gray-800 last:border-0">
                                                <input type="checkbox" checked={selectedLeads.includes(lead.id)} onChange={() => toggleLead(lead.id)}
                                                    className="rounded text-blue-600" />
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium dark:text-white truncate">{lead.first_name} {lead.last_name}</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{lead.email} ¬∑ {lead.company}</p>
                                                </div>
                                                <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${
                                                    lead.ai_intent === 'INTERESTED' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' :
                                                    lead.ai_intent === 'NOT_NOW' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400' :
                                                    lead.ai_intent === 'OBJECTION' ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400' :
                                                    lead.ai_intent === 'GHOSTING' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' :
                                                    lead.ai_intent === 'DEAD' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' :
                                                    'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400'
                                                }`}>
                                                    {lead.ai_intent || 'No intent'}
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button onClick={handleSend} disabled={sending || selectedLeads.length === 0}
                                    className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    {sending ? '‚è≥ Sending...' : `üì§ Send to ${selectedLeads.length} lead(s)`}
                                </button>
                                <button onClick={onClose}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // SEND EMAIL VIEW - SELECT LEADS AND SEND
        // ============================================

        function SendEmailView({ token, isDemoMode, darkMode, template, onCancel, onSent }) {
            const [leads, setLeads] = useState([]);
            const [selectedLeads, setSelectedLeads] = useState([]);
            const [subject, setSubject] = useState(template?.subject || '');
            const [sending, setSending] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchLeads();
            }, []);

            const fetchLeads = async () => {
                if (isDemoMode) {
                    setLeads([
                        { id: 1, first_name: 'John', last_name: 'Doe', email: 'john@example.com', company: 'Acme Corp' },
                        { id: 2, first_name: 'Jane', last_name: 'Smith', email: 'jane@example.com', company: 'Tech Inc' }
                    ]);
                    setLoading(false);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/leads`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setLeads(data.leads || []);
                    }
                } catch (error) {
                    console.error('Error fetching leads:', error);
                } finally {
                    setLoading(false);
                }
            };

            const toggleLead = (leadId) => {
                if (selectedLeads.includes(leadId)) {
                    setSelectedLeads(selectedLeads.filter(id => id !== leadId));
                } else {
                    setSelectedLeads([...selectedLeads, leadId]);
                }
            };

            const toggleAll = () => {
                if (selectedLeads.length === leads.length) {
                    setSelectedLeads([]);
                } else {
                    setSelectedLeads(leads.map(lead => lead.id));
                }
            };

            const handleSend = async () => {
                if (selectedLeads.length === 0) {
                    alert('Please select at least one recipient');
                    return;
                }

                if (!subject.trim()) {
                    alert('Please enter a subject line');
                    return;
                }

                if (!template.html) {
                    alert('This template has no HTML content. Please edit and save it first.');
                    return;
                }

                setSending(true);

                try {
                    const response = await fetch(`${API_URL}/send-email`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            template_id: template.id,
                            lead_ids: selectedLeads,
                            subject: subject,
                            html: template.html
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Send response:', data);
                        alert(`‚úÖ ${data.message || 'Emails sent successfully!'}`);
                        onSent();
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå Send failed:', response.status, errorData);

                        // Show detailed error message
                        let errorMsg = errorData.error || 'Unknown error';
                        if (errorData.results && errorData.results.failed && errorData.results.failed.length > 0) {
                            errorMsg += '\n\nFailed emails:\n';
                            errorData.results.failed.forEach(fail => {
                                errorMsg += `- ${fail.email}: ${fail.error}\n`;
                            });
                        }

                        alert(`Failed to send emails: ${errorMsg}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error sending emails:', error);
                    alert('Failed to send emails: ' + error.message);
                } finally {
                    setSending(false);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Send Email</h2>
                            <p className="text-gray-600 dark:text-gray-400 mt-1">
                                Using template: <span className="font-semibold">{template?.name}</span>
                            </p>
                        </div>
                        <div className="flex space-x-2">
                            <button
                                onClick={onCancel}
                                className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                                disabled={sending}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSend}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center space-x-2"
                                disabled={sending || selectedLeads.length === 0}
                            >
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <span>{sending ? 'Sending...' : `Send to ${selectedLeads.length} ${selectedLeads.length === 1 ? 'Lead' : 'Leads'}`}</span>
                            </button>
                        </div>
                    </div>

                    {/* Subject Line */}
                    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Email Subject *
                        </label>
                        <input
                            type="text"
                            value={subject}
                            onChange={(e) => setSubject(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                            placeholder="Enter email subject line..."
                        />
                        <p className="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            You can use variables: {'{{'}}first_name{'}}'}, {'{{'}}last_name{'}}'}, {'{{'}}company{'}}'}, {'{{'}}email{'}}'}
                        </p>
                    </div>

                    {/* Lead Selection */}
                    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Select Recipients</h3>
                            <button
                                onClick={toggleAll}
                                className="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400"
                            >
                                {selectedLeads.length === leads.length ? 'Deselect All' : 'Select All'}
                            </button>
                        </div>

                        {loading ? (
                            <div className="text-center py-8">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                <p className="mt-2 text-gray-600 dark:text-gray-400">Loading leads...</p>
                            </div>
                        ) : leads.length === 0 ? (
                            <div className="text-center py-8">
                                <p className="text-gray-600 dark:text-gray-400">No leads found. Add leads first to send emails.</p>
                            </div>
                        ) : (
                            <div className="max-h-96 overflow-y-auto space-y-2">
                                {leads.map(lead => (
                                    <label
                                        key={lead.id}
                                        className="flex items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"
                                    >
                                        <input
                                            type="checkbox"
                                            checked={selectedLeads.includes(lead.id)}
                                            onChange={() => toggleLead(lead.id)}
                                            className="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                        />
                                        <div className="ml-3 flex-1">
                                            <div className="flex items-center justify-between">
                                                <span className="font-medium text-gray-900 dark:text-white">
                                                    {lead.first_name} {lead.last_name}
                                                </span>
                                                {lead.company && (
                                                    <span className="text-sm text-gray-500 dark:text-gray-400">
                                                        {lead.company}
                                                    </span>
                                                )}
                                            </div>
                                            <span className="text-sm text-gray-600 dark:text-gray-400">
                                                {lead.email}
                                            </span>
                                        </div>
                                    </label>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Email Preview */}
                    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">Email Preview</h3>
                        <div className="border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                            {template?.html ? (
                                <iframe
                                    srcDoc={template.html}
                                    className="w-full"
                                    style={{ height: '400px' }}
                                    title="Email Preview"
                                />
                            ) : (
                                <div className="p-8 text-center text-gray-500 dark:text-gray-400">
                                    No preview available. Template has no HTML content.
                                </div>
                            )}
                        </div>
                        <p className="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Note: Variables like {'{{'}}first_name{'}}'}  will be replaced with actual data for each recipient
                        </p>
                    </div>
                </div>
            );
        }

        // ============================================
        // TEMPLATES VIEW - UNLAYER EMAIL BUILDER
        // ============================================

        function TemplatesView({ token, isDemoMode, darkMode }) {
            const [templates, setTemplates] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showEditor, setShowEditor] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [showSendEmail, setShowSendEmail] = useState(false);
            const [editingTemplate, setEditingTemplate] = useState(null);
            const [sendingTemplate, setSendingTemplate] = useState(null);
            const [importJson, setImportJson] = useState('');

            useEffect(() => {
                fetchTemplates();
            }, []);

            const fetchTemplates = async () => {
                if (isDemoMode) {
                    setTemplates([
                        { id: 1, name: 'Welcome Email', subject: 'Welcome to our platform!', updated_at: new Date().toISOString() },
                        { id: 2, name: 'Follow-up Email', subject: 'Just checking in...', updated_at: new Date().toISOString() }
                    ]);
                    setLoading(false);
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/templates`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setTemplates(data.templates);
                    }
                } catch (error) {
                    console.error('Error fetching templates:', error);
                } finally {
                    setLoading(false);
                }
            };

            const createNewTemplate = () => {
                setEditingTemplate(null);
                setShowEditor(true);
            };

            const handleImportJson = () => {
                if (!importJson.trim()) {
                    alert('Please paste your Unlayer design JSON');
                    return;
                }

                try {
                    const designJson = JSON.parse(importJson);
                    setEditingTemplate({
                        name: 'Imported Template',
                        design_json: JSON.stringify(designJson)
                    });
                    setShowImportModal(false);
                    setShowEditor(true);
                    setImportJson('');
                } catch (error) {
                    alert('Invalid JSON format. Please paste valid Unlayer design JSON.');
                }
            };

            const editTemplate = (template) => {
                setEditingTemplate(template);
                setShowEditor(true);
            };

            const sendEmail = (template) => {
                setSendingTemplate(template);
                setShowSendEmail(true);
            };

            const deleteTemplate = async (templateId) => {
                if (!confirm('Are you sure you want to delete this template?')) return;

                if (isDemoMode) {
                    setTemplates(templates.filter(t => t.id !== templateId));
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/templates/${templateId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        fetchTemplates();
                    }
                } catch (error) {
                    console.error('Error deleting template:', error);
                    alert('Failed to delete template');
                }
            };

            const handleSaveTemplate = async () => {
                await fetchTemplates();
                setShowEditor(false);
                setEditingTemplate(null);
            };

            if (showEditor) {
                return (
                    <TemplateEditor
                        token={token}
                        isDemoMode={isDemoMode}
                        darkMode={darkMode}
                        template={editingTemplate}
                        onSave={handleSaveTemplate}
                        onCancel={() => {
                            setShowEditor(false);
                            setEditingTemplate(null);
                        }}
                    />
                );
            }

            if (showSendEmail) {
                return (
                    <SendEmailView
                        token={token}
                        isDemoMode={isDemoMode}
                        darkMode={darkMode}
                        template={sendingTemplate}
                        onCancel={() => {
                            setShowSendEmail(false);
                            setSendingTemplate(null);
                        }}
                        onSent={() => {
                            setShowSendEmail(false);
                            setSendingTemplate(null);
                        }}
                    />
                );
            }

            // Import JSON Modal
            if (showImportModal) {
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Import Unlayer Design</h2>
                                <p className="text-gray-600 dark:text-gray-400 mt-1">
                                    Paste your Unlayer design JSON below
                                </p>
                            </div>
                            <button
                                onClick={() => setShowImportModal(false)}
                                className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                            >
                                ‚Üê Back to Templates
                            </button>
                        </div>

                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Unlayer Design JSON
                            </label>
                            <textarea
                                value={importJson}
                                onChange={(e) => setImportJson(e.target.value)}
                                className="w-full h-96 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm"
                                placeholder='Paste your Unlayer design JSON here...'
                            />
                            <p className="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                Export your design from Unlayer editor and paste the JSON here to import it
                            </p>
                        </div>

                        <div className="flex space-x-3 justify-end">
                            <button
                                onClick={() => setShowImportModal(false)}
                                className="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleImportJson}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Import & Edit
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Email Templates</h2>
                            <p className="text-gray-600 dark:text-gray-400 mt-1">
                                Create beautiful email templates with the drag-and-drop editor
                            </p>
                        </div>
                        <div className="flex space-x-3">
                            <button
                                onClick={() => setShowImportModal(true)}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                </svg>
                                <span>Import JSON</span>
                            </button>
                            <button
                                onClick={createNewTemplate}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                + Create Template
                            </button>
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-12">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                            <p className="mt-4 text-gray-600 dark:text-gray-400">Loading templates...</p>
                        </div>
                    ) : templates.length === 0 ? (
                        <div className="text-center py-12 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                            <svg className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <h3 className="mt-4 text-lg font-medium text-gray-900 dark:text-white">No templates yet</h3>
                            <p className="mt-2 text-gray-600 dark:text-gray-400">Get started by creating your first email template</p>
                            <button
                                onClick={createNewTemplate}
                                className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Create Your First Template
                            </button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {templates.map(template => (
                                <div key={template.id} className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-shadow">
                                    {/* Template Preview Thumbnail */}
                                    <div
                                        className="w-full h-48 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 overflow-hidden cursor-pointer"
                                        onClick={() => editTemplate(template)}
                                    >
                                        {template.html ? (
                                            <iframe
                                                srcDoc={template.html}
                                                className="w-full h-full pointer-events-none"
                                                style={{ transform: 'scale(0.25)', transformOrigin: 'top left', width: '400%', height: '400%' }}
                                                title={`Preview of ${template.name}`}
                                            />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                <svg className="w-16 h-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                        )}
                                    </div>

                                    {/* Template Info */}
                                    <div className="p-4">
                                        <div className="mb-3">
                                            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                                                {template.name}
                                            </h3>
                                            {template.subject && (
                                                <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                                    Subject: {template.subject}
                                                </p>
                                            )}
                                        </div>
                                        <p className="text-xs text-gray-500 dark:text-gray-500 mb-4">
                                            Last updated: {new Date(template.updated_at).toLocaleDateString()}
                                        </p>
                                        <div className="flex flex-col space-y-2">
                                            <button
                                                onClick={() => sendEmail(template)}
                                                className="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center justify-center space-x-2"
                                            >
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                </svg>
                                                <span>Send Email</span>
                                            </button>
                                            <div className="flex space-x-2">
                                                <button
                                                    onClick={() => editTemplate(template)}
                                                    className="flex-1 px-3 py-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50"
                                                >
                                                    Edit
                                                </button>
                                                <button
                                                    onClick={() => deleteTemplate(template.id)}
                                                    className="px-3 py-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-red-900/50"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // TemplateEditor Component with Unlayer
        function TemplateEditor({ token, isDemoMode, darkMode, template, onSave, onCancel }) {
            const [templateName, setTemplateName] = useState(template?.name || '');
            const [templateSubject, setTemplateSubject] = useState(template?.subject || '');
            const [saving, setSaving] = useState(false);
            const emailEditorRef = React.useRef(null);

            useEffect(() => {
                // Wait for Unlayer to load and then initialize
                const initializeEditor = () => {
                    if (window.unlayer && !emailEditorRef.current) {
                        try {
                            // Initialize with your Unlayer Project ID: 284189
                            window.unlayer.init({
                                id: 'email-editor',
                                projectId: 284189,
                                displayMode: 'email'
                            });

                            emailEditorRef.current = true;

                            // Load existing design if editing (after a short delay)
                            if (template && template.design_json) {
                                setTimeout(() => {
                                    try {
                                        window.unlayer.loadDesign(JSON.parse(template.design_json));
                                    } catch (e) {
                                        console.error('Error loading design:', e);
                                    }
                                }, 500);
                            }

                            console.log('‚úÖ Unlayer initialized successfully');
                        } catch (error) {
                            console.error('‚ùå Error initializing Unlayer:', error);
                            alert('Failed to load email editor. Please check your Unlayer Project ID.');
                        }
                    }
                };

                // Check if Unlayer is already loaded
                if (window.unlayer) {
                    initializeEditor();
                } else {
                    // Wait for Unlayer script to load
                    const checkUnlayer = setInterval(() => {
                        if (window.unlayer) {
                            clearInterval(checkUnlayer);
                            initializeEditor();
                        }
                    }, 100);

                    // Cleanup interval after 10 seconds
                    setTimeout(() => clearInterval(checkUnlayer), 10000);
                }

                return () => {
                    // Cleanup on unmount
                    if (emailEditorRef.current) {
                        emailEditorRef.current = null;
                    }
                };
            }, [template]);

            const handleSave = async () => {
                if (!templateName.trim()) {
                    alert('Please enter a template name');
                    return;
                }

                if (!window.unlayer) {
                    alert('Email editor not loaded. Please wait a moment and try again.');
                    return;
                }

                setSaving(true);

                try {
                    // Export design from Unlayer
                    window.unlayer.exportHtml((data) => {
                        console.log('‚úÖ Exported from Unlayer:', data);
                        const { design, html } = data;

                        if (!design || !html) {
                            console.error('‚ùå Export failed - missing design or html:', { design, html });
                            alert('Failed to export: Design or HTML is empty');
                            setSaving(false);
                            return;
                        }

                        saveTemplate(design, html);
                    });
                } catch (error) {
                    console.error('‚ùå Error exporting template:', error);
                    alert('Failed to export template: ' + error.message);
                    setSaving(false);
                }
            };

            const saveTemplate = async (designJson, html) => {
                if (isDemoMode) {
                    alert('‚úÖ Template saved (Demo Mode)');
                    onSave();
                    return;
                }

                try {
                    const method = (template && template.id) ? 'PUT' : 'POST';
                    const url = (template && template.id)
                        ? `${API_URL}/templates/${template.id}`
                        : `${API_URL}/templates`;

                    console.log('üíæ Saving template:', {
                        method,
                        url,
                        name: templateName,
                        hasDesign: !!designJson,
                        hasHtml: !!html
                    });

                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: templateName,
                            subject: templateSubject,
                            design_json: JSON.stringify(designJson),
                            html: html
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Template saved successfully:', data);
                        alert(data.message || 'Template saved successfully!');
                        onSave();
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error || `Failed to save template (${response.status})`;
                        console.error('‚ùå Save failed:', response.status, errorData);
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error('‚ùå Error saving template:', error);
                    alert('Failed to save template: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
                            {template ? 'Edit Template' : 'Create Template'}
                        </h2>
                        <div className="flex space-x-2">
                            <button
                                onClick={onCancel}
                                className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500"
                                disabled={saving}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSave}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                disabled={saving}
                            >
                                {saving ? 'Saving...' : 'Save Template'}
                            </button>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Template Name *
                            </label>
                            <input
                                type="text"
                                value={templateName}
                                onChange={(e) => setTemplateName(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                placeholder="e.g., Welcome Email, Follow-up #2"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Email Subject
                            </label>
                            <input
                                type="text"
                                value={templateSubject}
                                onChange={(e) => setTemplateSubject(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                                placeholder="e.g., Welcome to {{company}}"
                            />
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div id="email-editor" style={{ height: '600px' }}></div>
                    </div>

                    <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-blue-900 dark:text-blue-300 mb-2">
                            üí° Pro Tips:
                        </h4>
                        <ul className="text-sm text-blue-800 dark:text-blue-400 space-y-1">
                            <li>‚Ä¢ Use merge tags like {'{{first_name}}'}, {'{{company}}'}, {'{{email}}'} to personalize emails</li>
                            <li>‚Ä¢ Keep your design mobile-friendly - most emails are opened on mobile devices</li>
                            <li>‚Ä¢ Include a clear call-to-action button</li>
                            <li>‚Ä¢ Test your template by sending a preview to yourself</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // ============================================
        // LEADS & INBOX ‚Äî unified command center
        // ============================================

        const INTENT_OPTIONS = ['INTERESTED', 'NOT_NOW', 'OBJECTION', 'GHOSTING', 'DEAD'];

        const INTENT_META = {
            INTERESTED: { emoji: 'üî•', color: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300', label: 'Interested' },
            NOT_NOW:    { emoji: '‚è∞', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300', label: 'Not Now' },
            OBJECTION:  { emoji: '‚ùì', color: 'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-300', label: 'Objection' },
            GHOSTING:   { emoji: 'üëª', color: 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300', label: 'Ghosting' },
            DEAD:       { emoji: '‚ùå', color: 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300', label: 'Dead' },
        };

        function IntentPill({ intent, size = 'sm' }) {
            // Extract just the classification word ‚Äî AI sometimes returns extra explanation text
            const cleanIntent = (intent || '').split(/[\s\n\r]/)[0];
            const m = INTENT_META[cleanIntent];
            if (!m) return <span className="px-2 py-0.5 text-xs rounded font-medium bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400">{cleanIntent || 'No intent'}</span>;
            const pad = size === 'lg' ? 'px-3 py-1 text-sm' : 'px-2 py-0.5 text-xs';
            return <span className={`${pad} rounded font-medium ${m.color}`}>{m.emoji} {m.label}</span>;
        }

        // Safe date formatter ‚Äî never shows "Invalid Date"
        function fmtDate(val) {
            if (!val) return null;
            const d = new Date(val);
            if (isNaN(d.getTime())) return null;
            return d.toLocaleString();
        }

        // Extract and clean email content - remove quoted text and headers for cleaner display
        function cleanEmailContent(body) {
            if (!body) return { main: '', hasQuoted: false };

            const lines = body.split('\n');
            const mainContent = [];
            let hasQuoted = false;

            for (let line of lines) {
                // Skip email headers like "On X, Y wrote:"
                if (/^on\s+\w+,\s+\w+/i.test(line.trim()) && /wrote:/.test(line)) continue;
                // Skip lines that start with ">" (quoted text)
                if (line.trim().startsWith('>')) {
                    hasQuoted = true;
                    continue;
                }
                // Skip empty lines at the end of main content
                if (hasQuoted && line.trim() === '') continue;

                mainContent.push(line);
            }

            // Trim trailing empty lines
            while (mainContent.length > 0 && mainContent[mainContent.length - 1].trim() === '') {
                mainContent.pop();
            }

            return {
                main: mainContent.join('\n').trim(),
                hasQuoted: hasQuoted
            };
        }

        function CommandCenterView({ token, isDemoMode, darkMode, toastNotifications, addToastNotification, unreadLeadIds, setUnreadLeadIds, onNotificationClick }) {
            const [leads, setLeads] = useState([]);
            const [selectedLead, setSelectedLead] = useState(null);
            const [threads, setThreads] = useState([]);      // received email replies for selected lead
            const [drafts, setDrafts] = useState([]);        // pending ai drafts for selected lead
            const [reviews, setReviews] = useState([]);      // pending reviews for selected lead
            const [sentReplies, setSentReplies] = useState([]); // AI replies that were sent (for timeline)
            const [emailHistory, setEmailHistory] = useState([]); // initial/follow-up emails sent (for timeline)
            const [sequenceEmails, setSequenceEmails] = useState([]); // emails sent via sequences (for timeline)
            const [intentFilter, setIntentFilter] = useState('ALL');
            const [searchQuery, setSearchQuery] = useState('');
            const [loading, setLoading] = useState(true);
            const [detailLoading, setDetailLoading] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [showBulkImport, setShowBulkImport] = useState(false);

            // Write email manually
            const [showWriteEmail, setShowWriteEmail] = useState(false);
            const [manualSubject, setManualSubject] = useState('');
            const [manualBody, setManualBody] = useState('');
            const [sendingManual, setSendingManual] = useState(false);
            const [polishingEmail, setPolishingEmail] = useState(false);
            const [regeneratingDraft, setRegeneratingDraft] = useState(null); // draft id being regenerated

            // Email expansion state for activity timeline
            const [expandedEmails, setExpandedEmails] = useState({});
            const toggleEmailExpand = (key) => {
                setExpandedEmails(prev => ({ ...prev, [key]: !prev[key] }));
            };

            // Name editing
            const [editingName, setEditingName] = useState(false);
            const [nameFirstEdit, setNameFirstEdit] = useState('');
            const [nameLastEdit, setNameLastEdit] = useState('');
            const [savingName, setSavingName] = useState(false);

            // Intent editing
            const [intentDropdownOpen, setIntentDropdownOpen] = useState(false);
            const [savingIntent, setSavingIntent] = useState(false);

            // Draft editing ‚Äî keyed by draft id
            const [draftEdits, setDraftEdits] = useState({});
            const [sendingDraft, setSendingDraft] = useState(null);
            const [knowledgeSavedMsg, setKnowledgeSavedMsg] = useState(null);
            const [approvingReview, setApprovingReview] = useState(null);

            // All leads always loaded for sidebar counts ‚Äî separate from filtered list
            const [allLeads, setAllLeads] = useState([]);
            const allLeadsRef = React.useRef([]);

            // Pending follow-ups ‚Äî leads where AI sent holding reply, user must answer
            const [pendingFollowUps, setPendingFollowUps] = useState([]);
            const [showPendingOnly, setShowPendingOnly] = useState(false);

            const loadPendingFollowUps = async () => {
                if (isDemoMode) return;
                try {
                    const res = await fetch(`${API_URL}/drafts`, { headers: headers() });
                    if (res.ok) {
                        const d = await res.json();
                        setPendingFollowUps(d.drafts || []);
                    }
                } catch(e) { console.error(e); }
            };

            useEffect(() => { loadAllLeads(); loadPendingFollowUps(); }, []);
            useEffect(() => { loadFilteredLeads(); }, [intentFilter]);

            // Keep ref in sync with state (for use in event listeners without stale closure)
            useEffect(() => { allLeadsRef.current = allLeads; }, [allLeads]);

            // Handle notification click to select a lead ‚Äî runs on mount, uses ref for current allLeads
            useEffect(() => {
                // Check if there's a pending lead from before this component mounted
                const pendingId = localStorage.getItem('selected-lead-from-notification');
                if (pendingId) {
                    localStorage.removeItem('selected-lead-from-notification');
                    // Wait for allLeads to load then select
                    const interval = setInterval(() => {
                        const lead = allLeadsRef.current.find(l => String(l.id) === String(pendingId));
                        if (lead) { setSelectedLead(lead); clearInterval(interval); }
                    }, 100);
                    setTimeout(() => clearInterval(interval), 5000); // give up after 5s
                }

                // Listen for notification click events (fired when user is already on this view)
                const handler = (e) => {
                    const leadId = e.detail.leadId;
                    const lead = allLeadsRef.current.find(l => String(l.id) === String(leadId));
                    if (lead) {
                        setSelectedLead(lead);
                    } else {
                        // Leads may not be loaded yet ‚Äî store and let the interval above pick it up
                        localStorage.setItem('selected-lead-from-notification', leadId);
                    }
                };
                window.addEventListener('selectLeadFromNotification', handler);
                return () => window.removeEventListener('selectLeadFromNotification', handler);
            }, []);

            useEffect(() => {
                if (!selectedLead) { setThreads([]); setDrafts([]); setReviews([]); setSentReplies([]); setEmailHistory([]); setSequenceEmails([]); setShowWriteEmail(false); return; }
                setShowWriteEmail(false);
                setManualSubject('');
                setManualBody('');
                loadLeadDetail(selectedLead.id);
            }, [selectedLead?.id]);

            // If a lead is opened from the Action Required feed but its draft was already
            // skipped, auto-open the compose box so the user can still reply manually
            useEffect(() => {
                if (detailLoading || !selectedLead) return;
                const isActionRequired = pendingFollowUps.some(d => d.lead_id === selectedLead.id);
                const hasActiveDraft = drafts.some(d => d.needs_follow_up || d.clarification_needed);
                if (isActionRequired && !hasActiveDraft) {
                    setShowWriteEmail(true);
                }
            }, [detailLoading]);

            // Listen for new emails and auto-refresh the current lead details
            useEffect(() => {
                const handleNewEmails = (e) => {
                    const { notifications } = e.detail;
                    // If any email is for the currently selected lead, reload their details
                    const hasEmailForSelectedLead = notifications.some(n => String(n.lead_id) === String(selectedLead?.id));
                    if (hasEmailForSelectedLead && selectedLead) {
                        loadLeadDetail(selectedLead.id);
                    }
                    // Also refresh all leads to show updated unread counts
                    loadAllLeads();
                    // Refresh Action Required feed ‚Äî backend may have resolved stale drafts
                    loadPendingFollowUps();
                };
                window.addEventListener('newEmailsReceived', handleNewEmails);
                return () => window.removeEventListener('newEmailsReceived', handleNewEmails);
            }, [selectedLead?.id]);

            const headers = () => ({ 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' });

            const loadAllLeads = async () => {
                if (isDemoMode) {
                    const demo = buildDemoLeads();
                    setAllLeads(demo);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/leads`, { headers: headers() });
                    if (res.ok) { const d = await res.json(); setAllLeads(d.leads || []); }
                } catch(e) {}
            };

            const loadFilteredLeads = async () => {
                setLoading(true);
                if (isDemoMode) {
                    const demo = buildDemoLeads();
                    setLeads(intentFilter === 'ALL' ? demo : demo.filter(l => l.ai_intent === intentFilter));
                    setAllLeads(demo);
                    setLoading(false);
                    return;
                }
                try {
                    const qs = intentFilter !== 'ALL' ? `?ai_intent=${intentFilter}` : '';
                    const res = await fetch(`${API_URL}/leads${qs}`, { headers: headers() });
                    if (res.ok) { const d = await res.json(); setLeads(d.leads || []); }
                } catch(e) { console.error(e); }
                finally { setLoading(false); }
            };

            const buildDemoLeads = () => [
                { id: '1', first_name: 'John', last_name: 'Doe', email: 'john@acme.com', company: 'Acme Inc', status: 'interested', ai_intent: 'INTERESTED', intent_level: 'HIGH', source: 'form', created_at: new Date(Date.now()-86400000*2).toISOString() },
                { id: '2', first_name: 'Jane', last_name: 'Smith', email: 'jane@tech.com', company: 'Tech Corp', status: 'not_now', ai_intent: 'NOT_NOW', intent_level: 'MEDIUM', source: 'csv', created_at: new Date(Date.now()-86400000*5).toISOString() },
                { id: '3', first_name: 'Mike', last_name: 'Brown', email: 'mike@startup.io', company: 'Startup IO', status: 'active', ai_intent: null, intent_level: 'LOW', source: 'manual', created_at: new Date(Date.now()-86400000*1).toISOString() },
                { id: '4', first_name: 'Sara', last_name: 'Lee', email: 'sara@bigco.com', company: 'BigCo', status: 'replied', ai_intent: 'OBJECTION', intent_level: 'MEDIUM', source: 'dm', created_at: new Date(Date.now()-86400000*3).toISOString() },
            ];

            const loadLeadDetail = async (leadId) => {
                setDetailLoading(true);
                setThreads([]);
                setDrafts([]);
                setReviews([]);
                setSentReplies([]);
                setEmailHistory([]);
                setSequenceEmails([]);

                if (isDemoMode) {
                    if (leadId === '1') {
                        setThreads([{
                            id: 'r1',
                            subject: 'Re: Product Inquiry',
                            body: 'Thanks for reaching out! I\'m definitely interested. Can we book a call this week?',
                            received_at: new Date(Date.now()-86400000).toISOString(),
                            ai_intent: 'INTERESTED',
                        }]);
                        setDrafts([{
                            id: 'dr1',
                            lead_id: '1',
                            subject: 'Re: Product Inquiry',
                            draft_body: 'Hi John,\n\nGreat to hear you\'re interested! I\'d love to set up a 20-minute call to walk you through how we can help Acme Inc.\n\nAre you free Tuesday at 2pm or Wednesday at 11am?\n\nBest,\nAlex',
                            status: 'pending',
                            reply_text: 'Thanks for reaching out! I\'m definitely interested. Can we book a call this week?',
                            created_at: new Date(Date.now()-3600000).toISOString(),
                        }]);
                    }
                    setDetailLoading(false);
                    return;
                }

                try {
                    // Use the lead-specific endpoint which returns threads + drafts together
                    const res = await fetch(`${API_URL}/emails/interactions/${leadId}`, { headers: headers() });
                    if (res.ok) {
                        const d = await res.json();
                        setThreads(d.threads || []);
                        setDrafts((d.drafts || []).filter(dr => dr.status === 'pending'));
                        setSentReplies(d.sent_replies || []);
                        setEmailHistory(d.email_history || []);
                        setSequenceEmails(d.sequence_emails || []);
                    }
                } catch(e) { console.error(e); }

                try {
                    const res = await fetch(`${API_URL}/pending-reviews`, { headers: headers() });
                    if (res.ok) {
                        const d = await res.json();
                        setReviews((d.pending_reviews || []).filter(r => String(r.lead_id) === String(leadId)));
                    }
                } catch(e) { console.error(e); }

                setDetailLoading(false);
            };

            const updateIntent = async (newIntent) => {
                const leadId = selectedLead.id;
                setSavingIntent(true);
                setIntentDropdownOpen(false);
                if (isDemoMode) {
                    const updated = { ...selectedLead, ai_intent: newIntent };
                    setLeads(prev => prev.map(l => l.id === leadId ? updated : l));
                    setAllLeads(prev => prev.map(l => l.id === leadId ? updated : l));
                    setSelectedLead(updated);
                    setSavingIntent(false);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/leads/${leadId}`, {
                        method: 'PATCH',
                        headers: headers(),
                        body: JSON.stringify({ ai_intent: newIntent })
                    });
                    if (res.ok) {
                        const d = await res.json();
                        const updated = d.lead;
                        // Update both lists immediately
                        setLeads(prev => prev.map(l => l.id === updated.id || l.id === leadId ? updated : l));
                        setAllLeads(prev => prev.map(l => l.id === updated.id || l.id === leadId ? updated : l));
                        setSelectedLead(updated);
                        // If a filter is active the saved lead may no longer belong ‚Äî refresh
                        if (intentFilter !== 'ALL') loadFilteredLeads();
                    } else {
                        const err = await res.json().catch(() => ({}));
                        console.error('Intent update failed:', err);
                        alert('Failed to save intent: ' + (err.error || 'unknown error'));
                    }
                } catch(e) { console.error(e); alert('Network error saving intent.'); }
                finally { setSavingIntent(false); }
            };

            const updateName = async () => {
                const leadId = selectedLead.id;
                setSavingName(true);
                if (isDemoMode) {
                    const updated = { ...selectedLead, first_name: nameFirstEdit, last_name: nameLastEdit };
                    setLeads(prev => prev.map(l => l.id === leadId ? updated : l));
                    setAllLeads(prev => prev.map(l => l.id === leadId ? updated : l));
                    setSelectedLead(updated);
                    setEditingName(false);
                    setSavingName(false);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/leads/${leadId}`, {
                        method: 'PATCH',
                        headers: headers(),
                        body: JSON.stringify({ first_name: nameFirstEdit, last_name: nameLastEdit })
                    });
                    if (res.ok) {
                        const d = await res.json();
                        const updated = d.lead;
                        setLeads(prev => prev.map(l => l.id === updated.id || l.id === leadId ? updated : l));
                        setAllLeads(prev => prev.map(l => l.id === updated.id || l.id === leadId ? updated : l));
                        setSelectedLead(updated);
                        setEditingName(false);
                    } else {
                        const err = await res.json().catch(() => ({}));
                        alert('Failed to save name: ' + (err.error || 'unknown error'));
                    }
                } catch(e) { console.error(e); alert('Network error saving name.'); }
                finally { setSavingName(false); }
            };

            const sendDraft = async (draft, knowledge_update = null) => {
                setSendingDraft(draft.id);
                const edit = draftEdits[draft.id] || {};
                const body = edit.body !== undefined ? edit.body : (draft.draft_body || '');
                if (isDemoMode) {
                    setDrafts(prev => prev.filter(d => d.id !== draft.id));
                    setSendingDraft(null);
                    return;
                }
                try {
                    const payload = { edited_body: body };
                    if (knowledge_update && knowledge_update.trim()) payload.knowledge_update = knowledge_update.trim();
                    const res = await fetch(`${API_URL}/drafts/${draft.id}/send`, {
                        method: 'POST',
                        headers: headers(),
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setDrafts(prev => prev.filter(d => d.id !== draft.id));
                        loadPendingFollowUps(); // refresh action required count
                        if (data.knowledge_saved) {
                            // Clear knowledge input for this draft
                            setDraftEdits(prev => {
                                const updated = { ...prev };
                                if (updated[draft.id]) delete updated[draft.id].knowBase;
                                return updated;
                            });
                            // Show success banner that AI learned the answer
                            setKnowledgeSavedMsg('Your reply has been saved to the AI\'s product knowledge base. Next time a customer asks something similar, the AI will reply automatically ‚Äî no action required from you.');
                            setTimeout(() => setKnowledgeSavedMsg(null), 7000);
                        }
                    }
                    else { alert('Failed to send email. Check your email settings.'); }
                } catch(e) { console.error(e); alert('Network error sending draft.'); }
                finally { setSendingDraft(null); }
            };

            const skipDraft = async (draft) => {
                if (isDemoMode) {
                    setDrafts(prev => prev.filter(d => d.id !== draft.id));
                    setShowWriteEmail(true);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/drafts/${draft.id}/reject`, {
                        method: 'POST',
                        headers: headers()
                    });
                    if (res.ok) {
                        setDrafts(prev => prev.filter(d => d.id !== draft.id));
                        setShowWriteEmail(true);
                        loadPendingFollowUps(); // clear action required badge after skipping
                    } else {
                        alert('Failed to skip draft');
                    }
                } catch(e) {
                    console.error(e);
                    alert('Network error skipping draft');
                }
            };

            const approveReview = async (reviewId) => {
                setApprovingReview(reviewId);
                if (isDemoMode) { setReviews(prev => prev.filter(r => r.id !== reviewId)); setApprovingReview(null); return; }
                try {
                    await fetch(`${API_URL}/pending-reviews/${reviewId}/approve`, { method: 'POST', headers: headers() });
                    setReviews(prev => prev.filter(r => r.id !== reviewId));
                } catch(e) { console.error(e); }
                finally { setApprovingReview(null); }
            };

            const rejectReview = async (reviewId) => {
                if (isDemoMode) { setReviews(prev => prev.filter(r => r.id !== reviewId)); return; }
                try {
                    await fetch(`${API_URL}/pending-reviews/${reviewId}/reject`, { method: 'POST', headers: headers() });
                    setReviews(prev => prev.filter(r => r.id !== reviewId));
                } catch(e) { console.error(e); }
            };

            const resumeAI = async () => {
                if (isDemoMode || !selectedLead) return;
                try {
                    const res = await fetch(`${API_URL}/leads/${selectedLead.id}/resume-ai`, { method: 'PATCH', headers: headers() });
                    if (res.ok) {
                        const data = await res.json();
                        setSelectedLead(data.lead);
                        setLeads(prev => prev.map(l => l.id === data.lead.id ? data.lead : l));
                        setAllLeads(prev => prev.map(l => l.id === data.lead.id ? data.lead : l));
                    }
                } catch(e) { console.error(e); }
            };

            const bulkImportLeads = async (leadsArray) => {
                if (isDemoMode) {
                    const newLeads = leadsArray.map((lead, index) => ({
                        id: leads.length + index + 1,
                        ...lead,
                        status: 'new',
                        ai_intent: null
                    }));
                    setLeads(prev => [...prev, ...newLeads]);
                    setAllLeads(prev => [...prev, ...newLeads]);
                    setShowBulkImport(false);
                    return { success: newLeads.length, failed: 0 };
                }
                try {
                    const res = await fetch(`${API_URL}/leads/bulk`, {
                        method: 'POST',
                        headers: headers(),
                        body: JSON.stringify({ leads: leadsArray })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        loadFilteredLeads();
                        loadAllLeads();
                        setShowBulkImport(false);
                        return data;
                    }
                    return { success: 0, failed: leadsArray.length };
                } catch(e) {
                    console.error(e);
                    return { success: 0, failed: leadsArray.length };
                }
            };

            const sendManualEmail = async () => {
                if (!manualBody.trim()) { alert('Please write an email message'); return; }
                setSendingManual(true);
                if (isDemoMode) {
                    setTimeout(() => {
                        setSendingManual(false);
                        setShowWriteEmail(false);
                        setManualSubject('');
                        setManualBody('');
                        alert('Email sent successfully!');
                    }, 800);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/leads/${selectedLead.id}/send-initial-email`, {
                        method: 'POST',
                        headers: headers(),
                        body: JSON.stringify({ subject: manualSubject, email_body: manualBody })
                    });
                    if (res.ok) {
                        setShowWriteEmail(false);
                        setManualSubject('');
                        setManualBody('');
                        loadFilteredLeads();
                        loadAllLeads();
                        loadLeadDetail(selectedLead.id);
                        loadPendingFollowUps(); // clear action required badge after manual reply
                    } else {
                        const errData = await res.json().catch(() => ({}));
                        alert(errData.error || 'Failed to send email. Check your email settings.');
                    }
                } catch(e) { console.error(e); alert('Network error sending email.'); }
                finally { setSendingManual(false); }
            };

            const regenerateDraft = async (draft) => {
                setRegeneratingDraft(draft.id);
                if (isDemoMode) {
                    setTimeout(() => {
                        setDraftEdits(prev => ({
                            ...prev,
                            [draft.id]: { ...prev[draft.id], body: `Hi ${draft.lead_name?.split(' ')[0] || 'there'},\n\nThank you for your reply! [Demo regenerated reply ‚Äî connect AI for real content.]\n\nBest regards` }
                        }));
                        setRegeneratingDraft(null);
                    }, 1200);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/api/drafts/${draft.id}/regenerate`, {
                        method: 'POST',
                        headers: headers()
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setDraftEdits(prev => ({ ...prev, [draft.id]: { ...prev[draft.id], body: data.draft_body } }));
                    } else {
                        const err = await res.json().catch(() => ({}));
                        alert(err.message || 'Failed to regenerate. Please try again.');
                    }
                } catch(e) {
                    console.error(e);
                    alert('Network error regenerating draft.');
                } finally {
                    setRegeneratingDraft(null);
                }
            };

            const polishEmail = async () => {
                if (!manualBody.trim() || !selectedLead) return;
                setPolishingEmail(true);
                if (isDemoMode) {
                    setTimeout(() => { setPolishingEmail(false); }, 1200);
                    return;
                }
                try {
                    // Polish body + subject (or generate subject from body if empty) in parallel
                    const subjectFieldType = manualSubject.trim() ? 'subject' : 'subject_generate';
                    const subjectContent = manualSubject.trim() || manualBody;
                    const [bodyRes, subjectRes] = await Promise.all([
                        fetch(`${API_URL}/api/leads/${selectedLead.id}/polish-email`, {
                            method: 'POST',
                            headers: headers(),
                            body: JSON.stringify({ content: manualBody, field_type: 'body' })
                        }),
                        fetch(`${API_URL}/api/leads/${selectedLead.id}/polish-email`, {
                            method: 'POST',
                            headers: headers(),
                            body: JSON.stringify({ content: subjectContent, field_type: subjectFieldType })
                        })
                    ]);
                    if (bodyRes.ok) {
                        const data = await bodyRes.json();
                        let polished = data.polished_content || '';
                        // Strip subject line if AI accidentally included it
                        const subjectMatch = polished.match(/^Subject:\s*(.+)\r?\n\r?\n?/i);
                        if (subjectMatch) {
                            polished = polished.slice(subjectMatch[0].length).trim();
                        }
                        setManualBody(polished);
                    } else {
                        const err = await bodyRes.json().catch(() => ({}));
                        alert(err.message || 'Failed to polish email. Please try again.');
                    }
                    if (subjectRes.ok) {
                        const data = await subjectRes.json();
                        setManualSubject(data.polished_content || manualSubject);
                    }
                } catch(e) {
                    console.error(e);
                    alert('Network error polishing email.');
                } finally {
                    setPolishingEmail(false);
                }
            };

            // Sidebar counts from allLeads (unfiltered)
            const intentCounts = INTENT_OPTIONS.reduce((acc, k) => {
                acc[k] = allLeads.filter(l => l.ai_intent === k).length;
                return acc;
            }, {});

            return (
                <div className="flex h-full border-t border-gray-200 dark:border-gray-800">

                    {/* ‚îÄ‚îÄ LEFT SIDEBAR ‚îÄ‚îÄ */}
                    <div className="w-52 flex-shrink-0 bg-white dark:bg-gray-950 border-r border-gray-200 dark:border-gray-800 flex flex-col overflow-y-auto">

                        {/* ‚ö†Ô∏è ACTION REQUIRED ‚Äî always visible at top */}
                        <div className="px-3 pt-3 pb-2">
                            <button
                                onClick={() => { setShowPendingOnly(!showPendingOnly); setIntentFilter('ALL'); }}
                                className={`w-full text-left px-3 py-2.5 rounded-lg text-sm font-bold flex justify-between items-center transition border-2 ${showPendingOnly ? 'bg-orange-500 text-white border-orange-500' : pendingFollowUps.length > 0 ? 'bg-orange-50 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 border-orange-400 dark:border-orange-600 hover:bg-orange-100 dark:hover:bg-orange-900/50 animate-pulse' : 'bg-gray-50 dark:bg-gray-900 text-gray-400 dark:text-gray-600 border-gray-200 dark:border-gray-800 cursor-default'}`}
                                disabled={pendingFollowUps.length === 0}
                                title={pendingFollowUps.length > 0 ? 'Click to see leads needing your reply' : 'No pending follow-ups'}
                            >
                                <span>‚ö†Ô∏è Action Required</span>
                                <span className={`text-xs font-bold px-1.5 py-0.5 rounded-full ${showPendingOnly ? 'bg-white text-orange-600' : pendingFollowUps.length > 0 ? 'bg-orange-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-500'}`}>
                                    {pendingFollowUps.length}
                                </span>
                            </button>
                            {pendingFollowUps.length > 0 && !showPendingOnly && (
                                <p className="text-xs text-orange-600 dark:text-orange-400 mt-1.5 px-1">
                                    {pendingFollowUps.length} customer{pendingFollowUps.length > 1 ? 's' : ''} waiting for your answer
                                </p>
                            )}
                        </div>

                        <div className="px-4 py-2 border-b border-t border-gray-200 dark:border-gray-800 mt-1">
                            <p className="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Filter by intent</p>
                        </div>
                        <div className="p-3 space-y-0.5">
                            <button
                                onClick={() => { setIntentFilter('ALL'); setShowPendingOnly(false); }}
                                className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium flex justify-between items-center transition ${intentFilter === 'ALL' && !showPendingOnly ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                            >
                                <span>All Leads</span>
                                <span className="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-1.5 py-0.5 rounded">{allLeads.length}</span>
                            </button>
                            <div className="pt-3 pb-1 px-3 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">By Reply Intent</div>
                            {INTENT_OPTIONS.map(intent => {
                                const m = INTENT_META[intent];
                                const active = intentFilter === intent;
                                const count = intentCounts[intent] || 0;
                                return (
                                    <button
                                        key={intent}
                                        onClick={() => setIntentFilter(intent)}
                                        className={`w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center transition ${active ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 font-medium' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                                    >
                                        <span>{m.emoji} {m.label}</span>
                                        <span className={`text-xs px-1.5 py-0.5 rounded ${count > 0 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300' : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'}`}>{count}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* ‚îÄ‚îÄ MIDDLE FEED ‚îÄ‚îÄ */}
                    <div className="w-80 flex-shrink-0 bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col overflow-hidden">
                        <div className={`px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center ${showPendingOnly ? 'bg-orange-50 dark:bg-orange-900/20' : 'bg-white dark:bg-gray-950'}`}>
                            <span className="text-sm font-medium text-gray-700 dark:text-gray-200">
                                {showPendingOnly
                                    ? <span className="font-bold text-orange-700 dark:text-orange-400">‚ö†Ô∏è Needs reply ({pendingFollowUps.length})</span>
                                    : <>{leads.length} lead{leads.length !== 1 ? 's' : ''}{intentFilter !== 'ALL' && <span className="ml-1 text-gray-400 dark:text-gray-500 font-normal">¬∑ {INTENT_META[intentFilter]?.label}</span>}</>
                                }
                            </span>
                            <div className="flex items-center gap-2">
                                <button onClick={() => { loadFilteredLeads(); loadPendingFollowUps(); }} className="text-xs text-blue-600 dark:text-blue-400 hover:underline">‚Ü∫ Refresh</button>
                                <button
                                    onClick={() => setShowBulkImport(true)}
                                    className="text-xs px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                                >
                                    ‚Üë Import
                                </button>
                            </div>
                        </div>
                        {/* Search Bar */}
                        <div className="px-3 py-2 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
                            <div className="relative">
                                <span className="absolute inset-y-0 left-2 flex items-center text-gray-400 text-xs pointer-events-none">üîç</span>
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search name, email, message..."
                                    className="w-full pl-6 pr-3 py-1.5 text-xs border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                />
                                {searchQuery && (
                                    <button
                                        onClick={() => setSearchQuery('')}
                                        className="absolute inset-y-0 right-2 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-xs"
                                    >‚úï</button>
                                )}
                            </div>
                        </div>
                        {showAddForm && (
                            <div className="absolute inset-0 z-50 bg-black/40 flex items-center justify-center" onClick={(e) => { if (e.target === e.currentTarget) setShowAddForm(false); }}>
                                <div className="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-md mx-4">
                                    <AddLeadForm onSubmit={addLead} onCancel={() => setShowAddForm(false)} />
                                </div>
                            </div>
                        )}
                        {showBulkImport && (
                            <div className="absolute inset-0 z-50 bg-black/40 flex items-center justify-center overflow-y-auto" onClick={(e) => { if (e.target === e.currentTarget) setShowBulkImport(false); }}>
                                <div className="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-2xl mx-4 my-8">
                                    <BulkImportForm onImport={bulkImportLeads} onCancel={() => setShowBulkImport(false)} />
                                </div>
                            </div>
                        )}
                        <div className="flex-1 overflow-y-auto">
                            {showPendingOnly ? (
                                /* ‚îÄ‚îÄ ACTION REQUIRED FEED ‚îÄ‚îÄ */
                                pendingFollowUps.length === 0 ? (
                                    <div className="p-8 text-center">
                                        <div className="text-4xl mb-3">‚úÖ</div>
                                        <p className="text-sm font-semibold text-gray-600 dark:text-gray-400">All caught up!</p>
                                        <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">No customers waiting for your answer.</p>
                                    </div>
                                ) : pendingFollowUps.map(draft => {
                                    const isSelected = selectedLead?.id === draft.lead_id;
                                    const leadForDraft = allLeads.find(l => l.id === draft.lead_id);
                                    const initials = `${(draft.lead_name||'?')[0]}${(draft.lead_name||'').split(' ')[1]?.[0]||''}`.toUpperCase();
                                    return (
                                        <div
                                            key={draft.id}
                                            onClick={() => {
                                                if (leadForDraft) {
                                                    setSelectedLead(isSelected ? null : leadForDraft);
                                                }
                                            }}
                                            className={`px-4 py-3 border-b border-orange-200 dark:border-orange-900 cursor-pointer transition-colors border-l-2 ${isSelected ? 'bg-orange-100 dark:bg-orange-900/40 border-l-orange-600' : 'bg-orange-50 dark:bg-orange-900/20 border-l-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30'}`}
                                        >
                                            <div className="flex items-start gap-3">
                                                <div className="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white text-xs font-bold flex-shrink-0 mt-0.5">
                                                    {initials}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2">
                                                        <p className="text-sm font-bold text-orange-900 dark:text-orange-200 truncate">{draft.lead_name}</p>
                                                        <span className="text-[10px] font-bold bg-orange-500 text-white px-1.5 py-0.5 rounded-full flex-shrink-0">!</span>
                                                    </div>
                                                    <p className="text-xs text-orange-700 dark:text-orange-400 truncate">{draft.lead_email}</p>
                                                    {(() => {
                                                        const bodyTrimmed = (draft.reply_text || '').replace(/[\r\n\s]+/g, '');
                                                        const snippet = bodyTrimmed
                                                            ? draft.reply_text.trim().substring(0, 120) + (draft.reply_text.trim().length > 120 ? '‚Ä¶' : '')
                                                            : (draft.reply_subject || null);
                                                        return snippet ? (
                                                            <div className="mt-1.5 bg-white dark:bg-gray-900 border border-orange-200 dark:border-orange-800 rounded p-2">
                                                                <p className="text-[10px] font-bold text-orange-600 dark:text-orange-400 uppercase mb-0.5">Customer asked:</p>
                                                                <p className="text-xs text-gray-700 dark:text-gray-300 italic line-clamp-2">"{snippet}"</p>
                                                            </div>
                                                        ) : null;
                                                    })()}
                                                    <p className="text-[10px] text-orange-600 dark:text-orange-500 mt-1.5 font-medium">üëÜ Click to open ‚Üí write your answer</p>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : loading ? (
                                <div className="flex items-center justify-center h-40">
                                    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 dark:border-blue-400"></div>
                                </div>
                            ) : (() => {
                                const q = searchQuery.trim().toLowerCase();
                                const visibleLeads = q ? leads.filter(lead =>
                                    (lead.email || '').toLowerCase().includes(q) ||
                                    (lead.first_name || '').toLowerCase().includes(q) ||
                                    (lead.last_name || '').toLowerCase().includes(q) ||
                                    (lead.company || '').toLowerCase().includes(q) ||
                                    (lead.last_reply || '').toLowerCase().includes(q) ||
                                    (lead.last_subject || '').toLowerCase().includes(q)
                                ) : leads;
                                if (visibleLeads.length === 0) return (
                                <div className="p-8 text-center">
                                    <div className="text-4xl mb-3">{q ? 'üîç' : 'üîç'}</div>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">{q ? 'No leads match your search' : `No leads${intentFilter !== 'ALL' ? ` with ${INTENT_META[intentFilter]?.label} intent` : ''}`}</p>
                                    {q && <button onClick={() => setSearchQuery('')} className="mt-2 text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear search</button>}
                                </div>
                                );
                                return visibleLeads.map(lead => {
                                const isSelected = selectedLead?.id === lead.id;
                                const isUnread = unreadLeadIds.includes(lead.id);
                                const initials = `${(lead.first_name||'?')[0]}${(lead.last_name||'')[0]||''}`.toUpperCase();
                                const created = fmtDate(lead.created_at);
                                return (
                                    <div
                                        key={lead.id}
                                        onClick={() => { setSelectedLead(isSelected ? null : lead); if (isUnread) setUnreadLeadIds(prev => prev.filter(id => id !== lead.id)); }}
                                        className={`px-4 py-3 border-b border-gray-200 dark:border-gray-800 cursor-pointer transition-colors ${isSelected ? 'bg-blue-50 dark:bg-blue-900/20 border-l-2 border-l-blue-500' : isUnread ? 'bg-blue-50 dark:bg-blue-900/20 border-l-2 border-l-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/30' : 'hover:bg-white dark:hover:bg-gray-800 border-l-2 border-l-transparent'}`}
                                    >
                                        <div className="flex items-start gap-3">
                                            <div className="w-8 h-8 rounded-full bg-blue-600 dark:bg-blue-700 flex items-center justify-center text-white text-xs font-bold flex-shrink-0 mt-0.5">
                                                {initials}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className={`text-sm text-gray-900 dark:text-white truncate ${isUnread ? 'font-bold' : 'font-medium'}`}>{lead.first_name} {lead.last_name}</p>
                                                <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{lead.company || lead.email}</p>
                                                <div className="flex items-center gap-1.5 mt-1.5 flex-wrap">
                                                    {lead.ai_intent
                                                        ? <IntentPill intent={lead.ai_intent} />
                                                        : lead.intent_level
                                                            ? <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400">Level: {lead.intent_level}</span>
                                                            : <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-400 dark:bg-gray-800 dark:text-gray-500">Not categorized</span>
                                                    }
                                                </div>
                                                {lead.last_reply && (
                                                    <div className="text-xs text-gray-500 dark:text-gray-400 mt-1 space-y-0.5">
                                                        <p className="font-medium truncate">{lead.last_subject || '(No Subject)'}</p>
                                                        <p className="truncate italic">"{lead.last_reply.trim().substring(0, 65)}{lead.last_reply.trim().length > 65 ? '‚Ä¶' : ''}"</p>
                                                    </div>
                                                )}
                                                {created && <p className="text-xs text-gray-400 dark:text-gray-600 mt-1">{created}</p>}
                                            </div>
                                            {isUnread && <span className="inline-block w-3 h-3 bg-red-500 rounded-full flex-shrink-0 mt-1"></span>}
                                            {!isUnread && (lead.clarification_count || 0) >= 1 && (
                                                <span className="inline-flex items-center px-1.5 py-0.5 text-[10px] font-bold bg-orange-500 text-white rounded-full flex-shrink-0 mt-1" title="Needs your follow-up">
                                                    !
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                );
                                });
                            })()}
                        </div>
                    </div>


                    {/* ‚îÄ‚îÄ RIGHT DETAIL PANEL ‚îÄ‚îÄ */}
                    <div className="flex-1 bg-white dark:bg-gray-950 overflow-y-auto">
                        {!selectedLead ? (
                            <div className="flex flex-col items-center justify-center h-full text-center px-8 space-y-2">
                                <div className="text-5xl">üëà</div>
                                <p className="text-base font-semibold text-gray-700 dark:text-gray-300">Select a lead</p>
                                <p className="text-sm text-gray-400 dark:text-gray-500">Click any lead to see their activity, edit their intent, and review or edit AI-drafted emails</p>
                            </div>
                        ) : (
                            <div className="p-6 space-y-5 max-w-2xl">

                                {/* Lead header */}
                                <div>
                                    {editingName ? (
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <input
                                                className="text-xl font-bold text-gray-900 dark:text-white bg-transparent border-b-2 border-blue-400 focus:outline-none w-28"
                                                value={nameFirstEdit}
                                                onChange={e => setNameFirstEdit(e.target.value)}
                                                placeholder="First name"
                                                autoFocus
                                                onKeyDown={e => { if (e.key === 'Enter') updateName(); if (e.key === 'Escape') setEditingName(false); }}
                                            />
                                            <input
                                                className="text-xl font-bold text-gray-900 dark:text-white bg-transparent border-b-2 border-blue-400 focus:outline-none w-32"
                                                value={nameLastEdit}
                                                onChange={e => setNameLastEdit(e.target.value)}
                                                placeholder="Last name"
                                                onKeyDown={e => { if (e.key === 'Enter') updateName(); if (e.key === 'Escape') setEditingName(false); }}
                                            />
                                            <button onClick={updateName} disabled={savingName} className="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">{savingName ? '‚Ä¶' : 'Save'}</button>
                                            <button onClick={() => setEditingName(false)} className="text-xs px-2 py-1 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Cancel</button>
                                        </div>
                                    ) : (
                                        <h2
                                            className="text-xl font-bold text-gray-900 dark:text-white cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1 group"
                                            onClick={() => { setNameFirstEdit(selectedLead.first_name || ''); setNameLastEdit(selectedLead.last_name || ''); setEditingName(true); }}
                                            title="Click to edit name"
                                        >
                                            {selectedLead.first_name} {selectedLead.last_name}
                                            <span className="text-sm">‚úèÔ∏è</span>
                                        </h2>
                                    )}
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                                        {selectedLead.email}{selectedLead.company && ` ¬∑ ${selectedLead.company}`}
                                    </p>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-0.5">
                                        Source: {selectedLead.source || 'manual'}
                                        {fmtDate(selectedLead.created_at) && <span> ¬∑ Added {fmtDate(selectedLead.created_at)}</span>}
                                    </p>

                                    {/* Intent selector */}
                                    <div className="mt-2 flex items-center gap-2">
                                        <span className="text-xs text-gray-500 dark:text-gray-400">Intent:</span>
                                        <div className="relative inline-block">
                                            <button
                                                onClick={() => setIntentDropdownOpen(v => !v)}
                                                disabled={savingIntent}
                                                className="flex items-center gap-1 hover:opacity-80 disabled:opacity-50"
                                                title="Click to change intent"
                                            >
                                                {selectedLead.ai_intent
                                                    ? <IntentPill intent={selectedLead.ai_intent} />
                                                    : <span className="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-400 dark:bg-gray-800 dark:text-gray-500 border border-gray-200 dark:border-gray-700">Not set</span>
                                                }
                                                <span className="text-gray-400 text-xs ml-0.5">{savingIntent ? '‚Ä¶' : '‚ñæ'}</span>
                                            </button>
                                            {intentDropdownOpen && (
                                                <>
                                                    <div className="fixed inset-0 z-10" onClick={() => setIntentDropdownOpen(false)} />
                                                    <div className="absolute left-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-20 py-1 min-w-[150px]">
                                                        {INTENT_OPTIONS.map(intent => (
                                                            <button
                                                                key={intent}
                                                                onClick={() => updateIntent(intent)}
                                                                className={`w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 ${selectedLead.ai_intent === intent ? 'bg-gray-50 dark:bg-gray-700' : ''}`}
                                                            >
                                                                <IntentPill intent={intent} />
                                                            </button>
                                                        ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    </div>

                                    {selectedLead.initial_email_sent && (
                                        <div className="mt-2">
                                            <button
                                                onClick={async () => {
                                                    const pausing = !selectedLead.follow_up_paused;
                                                    if (pausing && !confirm(`Stop Follow-Up Rule emails to ${selectedLead.first_name || selectedLead.email}? No more automatic follow-ups will be sent until you resume.`)) return;
                                                    try {
                                                        const res = await fetch(`${API_URL}/api/leads/${selectedLead.id}/pause-follow-ups`, {
                                                            method: 'POST',
                                                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ paused: pausing })
                                                        });
                                                        if (!res.ok) throw new Error('Failed');
                                                        const data = await res.json();
                                                        setSelectedLead(data.lead);
                                                        setLeads(prev => prev.map(l => l.id === data.lead.id ? data.lead : l));
                                                        setAllLeads(prev => prev.map(l => l.id === data.lead.id ? data.lead : l));
                                                    } catch (e) {
                                                        alert('Could not update follow-up setting. Please try again.');
                                                    }
                                                }}
                                                className={`px-2.5 py-1 text-xs font-medium rounded-full transition-colors ${selectedLead.follow_up_paused ? 'bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900/40 dark:text-green-300 dark:hover:bg-green-900/60' : 'bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-red-900/40 dark:hover:text-red-300'}`}
                                                title={selectedLead.follow_up_paused ? 'Resume automatic follow-up emails' : 'Stop automatic follow-up emails for this contact'}
                                            >
                                                {selectedLead.follow_up_paused ? '‚ñ∂ Resume Follow-Ups' : '‚è∏ Pause Follow-Ups'}
                                            </button>
                                        </div>
                                    )}

                                    {selectedLead.enrolled_sequence_id && selectedLead.sequence_name && !selectedLead.sequence_completed && (
                                        <div className="mt-2 flex items-center gap-2 flex-wrap">
                                            <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300">
                                                üîÑ In sequence: {selectedLead.sequence_name}
                                                {selectedLead.total_sequence_steps > 0 && (
                                                    <span className="opacity-75"> ‚Äî Step {(selectedLead.sequence_current_step || 0)} of {selectedLead.total_sequence_steps}</span>
                                                )}
                                            </span>
                                            <button
                                                onClick={async () => {
                                                    if (!confirm(`Stop the remaining sequence emails to ${selectedLead.first_name || selectedLead.email}? They will not receive any more emails from this sequence.`)) return;
                                                    try {
                                                        const res = await fetch(`${API_URL}/api/leads/${selectedLead.id}/stop-sequence`, {
                                                            method: 'POST',
                                                            headers: { 'Authorization': `Bearer ${token}` }
                                                        });
                                                        if (!res.ok) throw new Error('Failed');
                                                        const data = await res.json();
                                                        setSelectedLead(data.lead);
                                                        setLeads(prev => prev.map(l => l.id === data.lead.id ? data.lead : l));
                                                        setAllLeads(prev => prev.map(l => l.id === data.lead.id ? data.lead : l));
                                                    } catch (e) {
                                                        alert('Could not stop sequence. Please try again.');
                                                    }
                                                }}
                                                className="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/40 dark:text-red-300 dark:hover:bg-red-900/60 transition-colors"
                                                title="Stop remaining sequence emails for this contact"
                                            >
                                                ‚úï Stop
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Pending follow-up banner ‚Äî AI sent holding reply, user needs to provide real answer */}
                                {drafts.filter(d => d.needs_follow_up).length > 0 && (
                                    <div className="bg-orange-50 dark:bg-orange-900/20 border-2 border-orange-400 dark:border-orange-600 rounded-xl p-4 animate-pulse-slow">
                                        <div className="flex items-start gap-3">
                                            <div className="text-2xl flex-shrink-0">‚ö†Ô∏è</div>
                                            <div className="flex-1">
                                                <p className="text-sm font-bold text-orange-900 dark:text-orange-200">
                                                    Pending Follow-up ‚Äî AI couldn't answer {drafts.filter(d => d.needs_follow_up).length === 1 ? 'a question' : `${drafts.filter(d => d.needs_follow_up).length} questions`}
                                                </p>
                                                <p className="text-xs text-orange-700 dark:text-orange-400 mt-1">
                                                    The AI sent a holding reply but the customer's question isn't covered in your knowledge base. Edit the draft below with your real answer and send it.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* AI Knowledge Saved success banner */}
                                {knowledgeSavedMsg && (
                                    <div className="bg-green-50 dark:bg-green-900/20 border border-green-300 dark:border-green-700 rounded-xl p-3 flex items-start gap-2.5">
                                        <span className="text-lg flex-shrink-0">‚úÖ</span>
                                        <div>
                                            <p className="text-sm font-semibold text-green-800 dark:text-green-200">AI Knowledge Updated</p>
                                            <p className="text-xs text-green-700 dark:text-green-300 mt-0.5 leading-relaxed">{knowledgeSavedMsg}</p>
                                        </div>
                                    </div>
                                )}

                                {/* Pending reviews */}
                                {reviews.map(review => (
                                    <div key={review.id} className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4">
                                        <p className="text-sm font-semibold text-amber-800 dark:text-amber-300 mb-2">AI suggests intent change</p>
                                        <div className="flex items-center gap-2 mb-3 flex-wrap">
                                            <IntentPill intent={review.current_intent} />
                                            <span className="text-gray-400 text-sm">‚Üí</span>
                                            <IntentPill intent={review.suggested_intent} />
                                        </div>
                                        {review.last_reply && (
                                            <p className="text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900 rounded p-2 mb-3 italic border border-gray-200 dark:border-gray-700">"{review.last_reply}"</p>
                                        )}
                                        <div className="flex gap-2">
                                            <button onClick={() => approveReview(review.id)} disabled={approvingReview === review.id} className="px-3 py-1.5 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 disabled:opacity-50">‚úì Approve</button>
                                            <button onClick={() => rejectReview(review.id)} className="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600">‚úó Keep Current</button>
                                        </div>
                                    </div>
                                ))}

                                {/* Pending AI drafts */}
                                {drafts.map(draft => {
                                    const edit = draftEdits[draft.id] || {};
                                    const isHolding = draft.needs_follow_up || draft.clarification_needed;
                                    const subject = edit.subject !== undefined ? edit.subject : (draft.subject || '');
                                    const body = edit.body !== undefined ? edit.body : (isHolding ? '' : (draft.draft_body || ''));
                                    const replyBodyTrimmed = (draft.reply_text || '').replace(/[\r\n\s]+/g, '');
                                    const replySnippet = replyBodyTrimmed
                                        ? draft.reply_text.trim().substring(0, 200) + (draft.reply_text.trim().length > 200 ? '‚Ä¶' : '')
                                        : (draft.reply_subject ? draft.reply_subject : null);
                                    const replyIsSubjectOnly = !replyBodyTrimmed && !!draft.reply_subject;
                                    return (
                                        <div key={draft.id} className={`rounded-xl p-4 border ${isHolding ? 'bg-orange-50 dark:bg-orange-900/10 border-orange-300 dark:border-orange-700' : 'bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700'}`}>
                                            <div className="flex items-center justify-between mb-2">
                                                <p className={`text-sm font-bold ${isHolding ? 'text-orange-800 dark:text-orange-300' : 'text-gray-800 dark:text-gray-200'}`}>
                                                    {isHolding ? '‚ö†Ô∏è Action Required ‚Äî Needs Your Answer' : 'AI Draft'}
                                                </p>
                                                {!isHolding && <span className="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-0.5 rounded">edit before sending</span>}
                                            </div>

                                            {/* Why action is required ‚Äî explanation for holding drafts */}
                                            {isHolding && (
                                                <div className="mb-3 bg-orange-100 dark:bg-orange-900/30 border border-orange-300 dark:border-orange-700 rounded-lg p-3">
                                                    <p className="text-xs font-semibold text-orange-900 dark:text-orange-200 mb-1">Why is action required?</p>
                                                    <p className="text-xs text-orange-800 dark:text-orange-300 leading-relaxed">
                                                        The customer asked a question that <strong>isn't in your product knowledge base</strong>, so the AI sent a polite holding reply and is waiting for you.
                                                    </p>
                                                    <p className="text-xs text-orange-700 dark:text-orange-400 mt-2 font-medium">
                                                        Write your answer below and send it. <strong>Your reply will be automatically saved to the AI's product knowledge base</strong> ‚Äî next time a customer asks something similar, the AI will reply on its own without asking you.
                                                    </p>
                                                </div>
                                            )}

                                            {/* Customer's original question */}
                                            {isHolding && replySnippet && (
                                                <div className="mb-3 px-3 py-2.5 bg-white dark:bg-gray-900 border-l-4 border-orange-400 dark:border-orange-600 rounded-r text-xs text-gray-700 dark:text-gray-300">
                                                    <span className="font-bold text-orange-700 dark:text-orange-400 block mb-1">üìã Customer asked:</span>
                                                    {replyIsSubjectOnly
                                                        ? <span className="italic">"{replySnippet}" <span className="not-italic text-orange-500 dark:text-orange-400">(subject only)</span></span>
                                                        : <span className="italic">"{replySnippet}"</span>
                                                    }
                                                </div>
                                            )}
                                            {!isHolding && replySnippet && (
                                                <div className="mb-3 px-3 py-2 bg-white dark:bg-gray-800 border-l-2 border-gray-300 dark:border-gray-600 rounded-r text-xs text-gray-500 dark:text-gray-400">
                                                    <span className="font-medium text-gray-600 dark:text-gray-300 block mb-0.5">Replying to:</span>
                                                    {replyIsSubjectOnly
                                                        ? <span className="italic">"{replySnippet}" <span className="not-italic text-gray-400 dark:text-gray-500">(subject only)</span></span>
                                                        : <span className="italic">"{replySnippet}"</span>
                                                    }
                                                </div>
                                            )}

                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                                        Your reply to customer
                                                        {isHolding && <span className="ml-2 text-blue-600 dark:text-blue-400 font-normal">‚Äî will be saved to AI knowledge base automatically</span>}
                                                    </label>
                                                    <textarea
                                                        value={body}
                                                        rows={7}
                                                        onChange={e => setDraftEdits(prev => ({ ...prev, [draft.id]: { ...prev[draft.id], body: e.target.value } }))}
                                                        className={`w-full px-3 py-2 text-sm border rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none resize-y ${isHolding ? 'border-orange-300 dark:border-orange-600 focus:border-orange-500' : 'border-gray-300 dark:border-gray-600 focus:border-gray-400 dark:focus:border-gray-500'}`}
                                                    />
                                                </div>
                                            </div>

                                            {/* Buttons */}
                                            <div className="flex gap-2 mt-3 flex-wrap">
                                                <button
                                                    onClick={() => sendDraft(draft, null)}
                                                    disabled={sendingDraft === draft.id || regeneratingDraft === draft.id}
                                                    className={`px-4 py-2 text-white rounded-lg text-sm font-medium disabled:opacity-50 flex items-center gap-1.5 ${isHolding ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700'}`}
                                                >
                                                    {sendingDraft === draft.id ? <><div className="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></div> Sending‚Ä¶</> : '‚úà Send Reply'}
                                                </button>
                                                {!isHolding && (
                                                    <button
                                                        onClick={() => regenerateDraft(draft)}
                                                        disabled={regeneratingDraft === draft.id || sendingDraft === draft.id}
                                                        className="px-3 py-2 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 border border-purple-300 dark:border-purple-600 rounded-lg text-sm hover:bg-purple-100 dark:hover:bg-purple-900/40 disabled:opacity-50 flex items-center gap-1.5"
                                                    >
                                                        {regeneratingDraft === draft.id
                                                            ? <><div className="animate-spin h-3 w-3 border-2 border-purple-600 border-t-transparent rounded-full"></div> Regenerating‚Ä¶</>
                                                            : <><span>üîÑ</span> Regenerate</>
                                                        }
                                                    </button>
                                                )}
                                                <button
                                                    onClick={() => skipDraft(draft)}
                                                    disabled={regeneratingDraft === draft.id || sendingDraft === draft.id}
                                                    className="px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50"
                                                >
                                                    Skip
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}

                                {/* Write Email manually */}
                                <div className="bg-gray-50 dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700">
                                    <button
                                        onClick={() => setShowWriteEmail(v => !v)}
                                        className="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition"
                                    >
                                        <span>‚úçÔ∏è Write Email</span>
                                        <span className="text-gray-400 text-xs">{showWriteEmail ? '‚ñ≤ hide' : '‚ñº open'}</span>
                                    </button>
                                    {showWriteEmail && (
                                        <div className="px-4 pb-4 space-y-3 border-t border-gray-200 dark:border-gray-700 pt-3">
                                            {/* Polish with AI ‚Äî only shown when body has content */}
                                            {manualBody.trim() && (
                                                <button
                                                    onClick={polishEmail}
                                                    disabled={polishingEmail}
                                                    className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border border-amber-300 dark:border-amber-600 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 disabled:opacity-50"
                                                >
                                                    {polishingEmail ? (
                                                        <><div className="animate-spin h-3 w-3 border-2 border-amber-600 border-t-transparent rounded-full"></div> Polishing‚Ä¶</>
                                                    ) : (
                                                        <><span>‚ú®</span> Polish with AI</>
                                                    )}
                                                </button>
                                            )}
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Subject</label>
                                                <input
                                                    type="text"
                                                    value={manualSubject}
                                                    onChange={e => setManualSubject(e.target.value)}
                                                    placeholder="Email subject‚Ä¶"
                                                    className="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:border-blue-400 dark:focus:border-blue-500"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Body</label>
                                                <textarea
                                                    value={manualBody}
                                                    onChange={e => setManualBody(e.target.value)}
                                                    rows={8}
                                                    placeholder={`Hi ${selectedLead.first_name || ''},\n\n`}
                                                    className="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:border-blue-400 dark:focus:border-blue-500 resize-y"
                                                />
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={sendManualEmail}
                                                    disabled={!manualBody.trim() || sendingManual}
                                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 flex items-center gap-1.5"
                                                >
                                                    {sendingManual ? <><div className="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></div> Sending‚Ä¶</> : '‚úà Send'}
                                                </button>
                                                <button
                                                    onClick={() => { setShowWriteEmail(false); setManualSubject(''); setManualBody(''); }}
                                                    className="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Activity timeline */}
                                <div>
                                    <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Activity Timeline</h3>
                                    {detailLoading ? (
                                        <div className="flex items-center gap-2 text-gray-400 text-sm">
                                            <div className="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                                            Loading‚Ä¶
                                        </div>
                                    ) : (() => {
                                        // Merge all timeline events: received, AI sent replies, initial emails sent, sequence emails
                                        const events = [
                                            ...threads.map(t => ({ ...t, _type: 'received', _time: t.received_at })),
                                            ...sentReplies.map(r => ({ ...r, _type: 'ai_sent', _time: r.sent_at || r.created_at })),
                                            ...emailHistory.map(h => ({ ...h, _type: 'initial_sent', _time: h.sent_at })),
                                            ...sequenceEmails.map(s => ({ ...s, _type: 'sequence_sent', _time: s.sent_at })),
                                        ].sort((a, b) => new Date(b._time || 0) - new Date(a._time || 0));

                                        return (
                                        <ol className="relative border-l-2 border-gray-200 dark:border-gray-700 ml-2 space-y-5">
                                            {events.map((ev, i) => {
                                                if (ev._type === 'received') {
                                                    const emailKey = `recv-${ev.id || i}`;
                                                    const isExpanded = expandedEmails[emailKey];
                                                    const cleaned = cleanEmailContent(ev.body);
                                                    const preview = cleaned.main.substring(0, 150);
                                                    const hasMore = cleaned.main.length > 150;

                                                    return (
                                                    <li key={emailKey} className="ml-5">
                                                        <div className="absolute -left-[9px] w-4 h-4 rounded-full bg-purple-500 border-2 border-white dark:border-gray-950"></div>
                                                        {fmtDate(ev.received_at) && <time className="text-xs text-gray-400 dark:text-gray-500">{fmtDate(ev.received_at)}</time>}
                                                        {ev.ai_intent && <div className="mt-0.5"><IntentPill intent={ev.ai_intent} /></div>}
                                                        <p className="text-sm text-gray-700 dark:text-gray-300 font-medium mt-0.5">
                                                            üì• Customer replied{ev.subject && <span className="font-normal text-gray-500 dark:text-gray-400"> ¬∑ {ev.subject}</span>}
                                                        </p>
                                                        {cleaned.main && (
                                                            <div className="mt-1.5 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 overflow-hidden">
                                                                <div className="p-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words leading-relaxed">
                                                                    {isExpanded ? cleaned.main : (preview + (hasMore ? '‚Ä¶' : ''))}
                                                                </div>
                                                                {(hasMore || cleaned.hasQuoted) && (
                                                                    <button
                                                                        onClick={() => toggleEmailExpand(emailKey)}
                                                                        className="w-full px-3 py-2 text-xs text-blue-600 dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-800 border-t border-gray-200 dark:border-gray-700 font-medium"
                                                                    >
                                                                        {isExpanded ? '‚ñ≤ Show less' : '‚ñº Show full email'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </li>
                                                    );
                                                }
                                                if (ev._type === 'ai_sent') {
                                                    const emailKey = `aisent-${ev.id || i}`;
                                                    const isExpanded = expandedEmails[emailKey];
                                                    const content = ev.final_body || ev.draft_body || '';
                                                    const preview = content.substring(0, 150);
                                                    const hasMore = content.length > 150;
                                                    const isHoldingReply = ev.needs_follow_up || ev.clarification_needed;

                                                    return (
                                                    <li key={emailKey} className="ml-5">
                                                        <div className={`absolute -left-[9px] w-4 h-4 rounded-full ${isHoldingReply ? 'bg-orange-500 animate-pulse' : 'bg-green-500'} border-2 border-white dark:border-gray-950`}></div>
                                                        {fmtDate(ev.sent_at || ev.created_at) && <time className="text-xs text-gray-400 dark:text-gray-500">{fmtDate(ev.sent_at || ev.created_at)}</time>}
                                                        <p className="text-sm text-gray-700 dark:text-gray-300 font-medium mt-0.5">
                                                            {isHoldingReply ? 'ü§ñ AI sent holding reply' : 'ü§ñ AI replied'}
                                                            {isHoldingReply && (
                                                                <span className="ml-2 px-2 py-0.5 text-xs font-bold bg-orange-200 text-orange-900 dark:bg-orange-600 dark:text-white rounded-full border border-orange-400 dark:border-orange-500">
                                                                    Needs Your Reply
                                                                </span>
                                                            )}
                                                        </p>
                                                        {isHoldingReply && (
                                                            <div className="mt-1.5 bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-500 dark:border-orange-600 rounded-r p-2.5">
                                                                <p className="text-xs text-orange-800 dark:text-orange-300 font-medium">
                                                                    AI couldn't answer this question from the knowledge base. Go to Emails tab to write the real answer and send it.
                                                                </p>
                                                            </div>
                                                        )}
                                                        {content && (
                                                            <div className={`mt-1.5 ${isHoldingReply ? 'bg-orange-50 dark:bg-orange-950/30 rounded border border-orange-200 dark:border-orange-800' : 'bg-green-50 dark:bg-green-950 rounded border border-green-200 dark:border-green-800'} overflow-hidden`}>
                                                                <div className="p-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words leading-relaxed">
                                                                    {isExpanded ? content : (preview + (hasMore ? '‚Ä¶' : ''))}
                                                                </div>
                                                                {hasMore && (
                                                                    <button
                                                                        onClick={() => toggleEmailExpand(emailKey)}
                                                                        className={`w-full px-3 py-2 text-xs ${isHoldingReply ? 'text-orange-700 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900 border-t border-orange-200 dark:border-orange-800' : 'text-green-700 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900 border-t border-green-200 dark:border-green-800'} font-medium`}
                                                                    >
                                                                        {isExpanded ? '‚ñ≤ Show less' : '‚ñº Show full email'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </li>
                                                    );
                                                }
                                                if (ev._type === 'initial_sent') {
                                                    const emailKey = `hist-${ev.id || i}`;
                                                    const isExpanded = expandedEmails[emailKey];
                                                    const preview = ev.body?.substring(0, 150) || '';
                                                    const hasMore = (ev.body?.length || 0) > 150;

                                                    return (
                                                    <li key={emailKey} className="ml-5">
                                                        <div className="absolute -left-[9px] w-4 h-4 rounded-full bg-blue-500 border-2 border-white dark:border-gray-950"></div>
                                                        {fmtDate(ev.sent_at) && <time className="text-xs text-gray-400 dark:text-gray-500">{fmtDate(ev.sent_at)}</time>}
                                                        <p className="text-sm text-gray-700 dark:text-gray-300 font-medium mt-0.5">
                                                            üì§ Email sent{ev.subject && <span className="font-normal text-gray-500 dark:text-gray-400"> ¬∑ {ev.subject}</span>}
                                                        </p>
                                                        {ev.body && (
                                                            <div className="mt-1.5 bg-blue-50 dark:bg-blue-950 rounded border border-blue-200 dark:border-blue-800 overflow-hidden">
                                                                <div className="p-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words leading-relaxed">
                                                                    {isExpanded ? ev.body : (preview + (hasMore ? '‚Ä¶' : ''))}
                                                                </div>
                                                                {hasMore && (
                                                                    <button
                                                                        onClick={() => toggleEmailExpand(emailKey)}
                                                                        className="w-full px-3 py-2 text-xs text-blue-700 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 border-t border-blue-200 dark:border-blue-800 font-medium"
                                                                    >
                                                                        {isExpanded ? '‚ñ≤ Show less' : '‚ñº Show full email'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </li>
                                                    );
                                                }
                                                if (ev._type === 'sequence_sent') {
                                                    const emailKey = `seq-${ev.id || i}`;
                                                    const isExpanded = expandedEmails[emailKey];
                                                    const bodyText = ev.body ? ev.body.replace(/<[^>]*>/g, '') : '';
                                                    const preview = bodyText.substring(0, 150);
                                                    const hasMore = bodyText.length > 150;

                                                    return (
                                                    <li key={emailKey} className="ml-5">
                                                        <div className="absolute -left-[9px] w-4 h-4 rounded-full bg-orange-500 border-2 border-white dark:border-gray-950"></div>
                                                        {fmtDate(ev.sent_at) && <time className="text-xs text-gray-400 dark:text-gray-500">{fmtDate(ev.sent_at)}</time>}
                                                        <p className="text-sm text-gray-700 dark:text-gray-300 font-medium mt-0.5">
                                                            üì§ Email sent
                                                            <span className="ml-1.5 inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300">
                                                                üîÑ {ev.sequence_name} ‚Äî Step {ev.step_number}{ev.total_steps > 0 && ` of ${ev.total_steps}`}
                                                            </span>
                                                            {ev.subject && <span className="font-normal text-gray-500 dark:text-gray-400"> ¬∑ {ev.subject}</span>}
                                                        </p>
                                                        {bodyText && (
                                                            <div className="mt-1.5 bg-orange-50 dark:bg-orange-950/30 rounded border border-orange-200 dark:border-orange-800 overflow-hidden">
                                                                <div className="p-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words leading-relaxed">
                                                                    {isExpanded ? bodyText : (preview + (hasMore ? '‚Ä¶' : ''))}
                                                                </div>
                                                                {hasMore && (
                                                                    <button
                                                                        onClick={() => toggleEmailExpand(emailKey)}
                                                                        className="w-full px-3 py-2 text-xs text-orange-700 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30 border-t border-orange-200 dark:border-orange-800 font-medium"
                                                                    >
                                                                        {isExpanded ? '‚ñ≤ Show less' : '‚ñº Show full email'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </li>
                                                    );
                                                }
                                                return null;
                                            })}
                                            {events.length === 0 && !detailLoading && (
                                                <li className="ml-5 text-sm text-gray-400 dark:text-gray-500 italic">No activity yet</li>
                                            )}
                                            {/* Lead added ‚Äî always at bottom */}
                                            <li className="ml-5">
                                                <div className="absolute -left-[9px] w-4 h-4 rounded-full bg-gray-400 border-2 border-white dark:border-gray-950"></div>
                                                {fmtDate(selectedLead.created_at) && (
                                                    <time className="text-xs text-gray-400 dark:text-gray-500">{fmtDate(selectedLead.created_at)}</time>
                                                )}
                                                <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Lead added ¬∑ {selectedLead.source || 'manual'}</p>
                                            </li>
                                        </ol>
                                        );
                                    })()}
                                </div>

                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ‚îÄ‚îÄ‚îÄ Appointments View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function AppointmentsView({ token, isDemoMode, darkMode }) {
            const [appointments, setAppointments] = React.useState([]);
            const [leads, setLeads] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [filter, setFilter] = React.useState('active'); // default: hide cancelled
            const [showCancelled, setShowCancelled] = React.useState(false);
            const [saving, setSaving] = React.useState(false);

            // Modals
            const [createModal, setCreateModal] = React.useState(false);
            const [editModal, setEditModal] = React.useState({ open: false, apt: null });
            const [outcomeModal, setOutcomeModal] = React.useState({ open: false, apt: null });

            // Forms
            const defaultForm = {
                lead_id: '', date: '', time: '',
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                duration_minutes: 30, appointment_type: 'call', meeting_link: '', notes: ''
            };
            const [createForm, setCreateForm] = React.useState(defaultForm);
            const [editForm, setEditForm] = React.useState({});

            const TYPE_OPTIONS = [
                ['call','üìû Call'],['meeting','ü§ù Meeting'],['video_call','üìπ Video Call'],
                ['property_showing','üè† Property Showing'],['demo','üíª Demo'],['other','üìÖ Other']
            ];
            const typeLabel = Object.fromEntries(TYPE_OPTIONS.map(([v,l]) => [v, l]));
            const statusColors = {
                scheduled: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
                completed: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
                cancelled: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'
            };

            const fetchAppointments = async () => {
                if (isDemoMode) { setLoading(false); return; }
                try {
                    const res = await fetch(`${API_URL}/api/appointments`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.ok) { const d = await res.json(); setAppointments(d.appointments || []); }
                } catch (e) { console.error('Appointments fetch error:', e); }
                finally { setLoading(false); }
            };

            const fetchLeads = async () => {
                if (isDemoMode || !token) return;
                try {
                    const res = await fetch(`${API_URL}/api/leads`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.ok) { const d = await res.json(); setLeads(d.leads || []); }
                } catch (e) { console.error('Leads fetch error:', e); }
            };

            React.useEffect(() => {
                fetchAppointments();
                fetchLeads();
            }, [token]);

            // ‚îÄ‚îÄ Upcoming notification: appointments within 24h ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const upcomingIn24h = React.useMemo(() => {
                const now = Date.now();
                const h24 = 24 * 60 * 60 * 1000;
                return appointments.filter(a => {
                    if (a.status !== 'scheduled' || !a.date || !a.time) return false;
                    const t = parseLocalDateTime(a.date, a.time).getTime();
                    return !isNaN(t) && t > now && t - now <= h24;
                }).sort((a, b) => parseLocalDateTime(a.date, a.time) - parseLocalDateTime(b.date, b.time));
            }, [appointments]);

            const upcomingIn1h = React.useMemo(() => {
                const now = Date.now();
                const h1 = 60 * 60 * 1000;
                return appointments.filter(a => {
                    if (a.status !== 'scheduled' || !a.date || !a.time) return false;
                    const t = parseLocalDateTime(a.date, a.time).getTime();
                    return !isNaN(t) && t > now && t - now <= h1;
                });
            }, [appointments]);

            // ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const createAppointment = async () => {
                if (!createForm.lead_id || !createForm.date || !createForm.time) return alert('Please select a lead, date, and time.');
                setSaving(true);
                try {
                    const res = await fetch(`${API_URL}/api/appointments`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(createForm)
                    });
                    if (!res.ok) { const e = await res.json(); throw new Error(e.error); }
                    setCreateModal(false);
                    setCreateForm(defaultForm);
                    fetchAppointments();
                } catch (e) { alert('Failed: ' + e.message); }
                finally { setSaving(false); }
            };

            const saveEdit = async () => {
                if (!editForm.date || !editForm.time) return alert('Please fill in date and time.');
                setSaving(true);
                try {
                    const res = await fetch(`${API_URL}/api/appointments/${editModal.apt.id}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(editForm)
                    });
                    if (!res.ok) { const e = await res.json(); throw new Error(e.error); }
                    setEditModal({ open: false, apt: null });
                    fetchAppointments();
                } catch (e) { alert('Failed: ' + e.message); }
                finally { setSaving(false); }
            };

            const cancelAppointment = async (id) => {
                if (!confirm('Cancel this appointment? You can restore it later if needed.')) return;
                await fetch(`${API_URL}/api/appointments/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                fetchAppointments();
            };

            const restoreAppointment = async (id) => {
                try {
                    const res = await fetch(`${API_URL}/api/appointments/${id}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'scheduled' })
                    });
                    if (!res.ok) { const e = await res.json(); throw new Error(e.error); }
                    fetchAppointments();
                } catch (e) { alert('Failed to restore: ' + e.message); }
            };

            const markOutcome = async (id, outcome) => {
                await fetch(`${API_URL}/api/appointments/${id}/outcome`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ outcome })
                });
                setOutcomeModal({ open: false, apt: null });
                fetchAppointments();
            };

            const openEdit = (apt) => {
                setEditForm({
                    date: apt.date || '', time: apt.time || '',
                    timezone: apt.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
                    duration_minutes: apt.duration_minutes || 30,
                    appointment_type: apt.appointment_type || 'call',
                    meeting_link: apt.meeting_link || '',
                    notes: apt.notes || ''
                });
                setEditModal({ open: true, apt });
            };

            const cancelledCount = appointments.filter(a => a.status === 'cancelled').length;
            const filtered = appointments.filter(a => {
                // Always hide cancelled unless showCancelled is on
                if (!showCancelled && a.status === 'cancelled') return false;
                if (filter === 'ai_detected') return a.source === 'ai_detected';
                if (filter === 'manual') return a.source !== 'ai_detected';
                // 'active': scheduled + completed only (no cancelled)
                if (filter === 'active') return a.status !== 'cancelled';
                return true;
            });
            const aiCount = appointments.filter(a => a.source === 'ai_detected').length;

            // ‚îÄ‚îÄ Form field helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const formInput = (label, type, value, onChange, opts = {}) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
                    <input type={type} value={value} onChange={e => onChange(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-sm"
                        {...opts} />
                </div>
            );

            return (
                <div className="space-y-4">
                    {/* ‚îÄ‚îÄ Upcoming reminders banner ‚îÄ‚îÄ */}
                    {upcomingIn1h.length > 0 && (
                        <div className="bg-red-50 dark:bg-red-900/20 border border-red-300 dark:border-red-700 rounded-lg px-4 py-3 flex items-start gap-3">
                            <span className="text-red-500 text-xl">üîî</span>
                            <div>
                                <p className="text-sm font-bold text-red-700 dark:text-red-300">Appointment starting within 1 hour!</p>
                                {upcomingIn1h.map(a => {
                                    const n = a.lead ? `${a.lead.first_name || ''} ${a.lead.last_name || ''}`.trim() || a.lead.email : 'Unknown lead';
                                    return <p key={a.id} className="text-xs text-red-600 dark:text-red-400 mt-0.5">{n} ¬∑ {a.date} at {a.time} ({typeLabel[a.appointment_type] || a.appointment_type})</p>;
                                })}
                            </div>
                        </div>
                    )}
                    {upcomingIn24h.length > 0 && upcomingIn1h.length === 0 && (
                        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-300 dark:border-yellow-700 rounded-lg px-4 py-3 flex items-start gap-3">
                            <span className="text-yellow-500 text-xl">‚è∞</span>
                            <div>
                                <p className="text-sm font-semibold text-yellow-800 dark:text-yellow-300">You have {upcomingIn24h.length} appointment{upcomingIn24h.length > 1 ? 's' : ''} in the next 24 hours</p>
                                {upcomingIn24h.map(a => {
                                    const n = a.lead ? `${a.lead.first_name || ''} ${a.lead.last_name || ''}`.trim() || a.lead.email : 'Unknown lead';
                                    return <p key={a.id} className="text-xs text-yellow-700 dark:text-yellow-400 mt-0.5">{n} ¬∑ {a.date} at {a.time} ({typeLabel[a.appointment_type] || a.appointment_type})</p>;
                                })}
                            </div>
                        </div>
                    )}

                    {/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */}
                    <div className="flex items-center justify-between flex-wrap gap-3">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800 dark:text-white">üìÖ Appointments</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                {appointments.length} total ¬∑ {aiCount} auto-detected by AI
                            </p>
                        </div>
                        <div className="flex items-center gap-3 flex-wrap">
                            {/* Filter */}
                            <div className="flex gap-1 flex-wrap items-center">
                                {[['active','Active'],['all','All'],['ai_detected','ü§ñ AI'],['manual','Manual']].map(([val,label]) => (
                                    <button key={val} onClick={() => setFilter(val)}
                                        className={`px-3 py-1.5 text-xs rounded-full font-medium transition-colors ${filter === val ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
                                    >{label}</button>
                                ))}
                                {cancelledCount > 0 && (
                                    <button onClick={() => setShowCancelled(v => !v)}
                                        className={`px-3 py-1.5 text-xs rounded-full font-medium transition-colors ${showCancelled ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500 hover:bg-gray-200'}`}
                                    >{showCancelled ? `Hide cancelled (${cancelledCount})` : `Show cancelled (${cancelledCount})`}</button>
                                )}
                            </div>
                            {/* New appointment button */}
                            <button onClick={() => { setCreateForm(defaultForm); setCreateModal(true); }}
                                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg flex items-center gap-1"
                            >+ New Appointment</button>
                        </div>
                    </div>

                    {/* ‚îÄ‚îÄ AI banner ‚îÄ‚îÄ */}
                    {aiCount > 0 && (
                        <div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg px-4 py-3 flex items-center gap-3">
                            <span className="text-purple-500 text-lg">ü§ñ</span>
                            <p className="text-sm text-purple-800 dark:text-purple-300">
                                <strong>{aiCount}</strong> appointment{aiCount !== 1 ? 's' : ''} auto-detected from email conversations
                            </p>
                        </div>
                    )}

                    {/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */}
                    {loading ? (
                        <div className="text-center py-16 text-gray-400 dark:text-gray-500">Loading...</div>
                    ) : filtered.length === 0 ? (
                        <div className="text-center py-16 text-gray-400 dark:text-gray-500">
                            <div className="text-5xl mb-3">üìÖ</div>
                            <p className="font-medium">No appointments yet</p>
                            <p className="text-sm mt-1">Click "+ New Appointment" to add one, or appointments detected from emails will appear here automatically.</p>
                        </div>
                    ) : (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead className="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        {['Lead','Date & Time','Type','Status','Source','Notes','Actions'].map(h => (
                                            <th key={h} className="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                    {filtered.map(apt => {
                                        const leadName = apt.lead
                                            ? (`${apt.lead.first_name || ''} ${apt.lead.last_name || ''}`.trim() || apt.lead.email)
                                            : '‚Äî';
                                        const aptMs = apt.date && apt.time ? parseLocalDateTime(apt.date, apt.time).getTime() : null;
                                        const minsUntil = aptMs ? Math.round((aptMs - Date.now()) / 60000) : null;
                                        const isSoon = minsUntil !== null && minsUntil > 0 && minsUntil <= 60;
                                        const isToday = minsUntil !== null && minsUntil > 0 && minsUntil <= 1440;
                                        return (
                                            <tr key={apt.id} className={`hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors ${isSoon ? 'bg-red-50 dark:bg-red-900/10' : isToday ? 'bg-yellow-50 dark:bg-yellow-900/10' : ''}`}>
                                                {/* Lead */}
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-gray-900 dark:text-white text-sm">{leadName}</div>
                                                    {apt.lead && <div className="text-xs text-gray-400">{apt.lead.email}</div>}
                                                    {apt.lead?.company && <div className="text-xs text-gray-400">{apt.lead.company}</div>}
                                                </td>
                                                {/* Date & Time */}
                                                <td className="px-4 py-3 whitespace-nowrap">
                                                    <div className="text-sm text-gray-700 dark:text-gray-300">{apt.date || '‚Äî'}</div>
                                                    <div className="text-xs text-gray-400">{apt.time || ''}{apt.timezone && apt.timezone !== 'UTC' ? ` ¬∑ ${apt.timezone}` : ''}</div>
                                                    {isSoon && <span className="text-xs font-bold text-red-500">üî¥ In {minsUntil}min</span>}
                                                    {isToday && !isSoon && <span className="text-xs font-medium text-yellow-600 dark:text-yellow-400">Today</span>}
                                                </td>
                                                {/* Type */}
                                                <td className="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
                                                    {typeLabel[apt.appointment_type] || apt.appointment_type || '‚Äî'}
                                                </td>
                                                {/* Status */}
                                                <td className="px-4 py-3">
                                                    <span className={`inline-flex px-2 py-0.5 rounded-full text-xs font-medium capitalize ${statusColors[apt.status] || 'bg-gray-100 text-gray-600'}`}>
                                                        {apt.status}
                                                    </span>
                                                    {apt.outcome && <div className="text-xs mt-1 text-gray-400">{apt.outcome.replace(/_/g,' ')}</div>}
                                                </td>
                                                {/* Source */}
                                                <td className="px-4 py-3">
                                                    {apt.source === 'ai_detected'
                                                        ? <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300">ü§ñ AI</span>
                                                        : <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">Manual</span>
                                                    }
                                                </td>
                                                {/* Notes */}
                                                <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 max-w-xs">
                                                    <div className="line-clamp-2">{apt.notes || '‚Äî'}</div>
                                                </td>
                                                {/* Actions */}
                                                <td className="px-4 py-3">
                                                    <div className="flex gap-1 flex-wrap">
                                                        <button onClick={() => openEdit(apt)}
                                                            className="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400 hover:bg-blue-200"
                                                        >Edit</button>
                                                        {apt.status === 'scheduled' && (
                                                            <button onClick={() => setOutcomeModal({ open: true, apt })}
                                                                className="text-xs px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400 hover:bg-green-200"
                                                            >Outcome</button>
                                                        )}
                                                        {apt.status === 'scheduled' && (
                                                            <button onClick={() => cancelAppointment(apt.id)}
                                                                className="text-xs px-2 py-1 rounded bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-400 hover:bg-red-200"
                                                            >Cancel</button>
                                                        )}
                                                        {apt.status === 'cancelled' && (
                                                            <button onClick={() => restoreAppointment(apt.id)}
                                                                className="text-xs px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400 hover:bg-green-200"
                                                            >Restore</button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {/* ‚îÄ‚îÄ Create Modal ‚îÄ‚îÄ */}
                    {createModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center p-5 border-b dark:border-gray-700">
                                    <h3 className="text-lg font-bold text-gray-900 dark:text-white">New Appointment</h3>
                                    <button onClick={() => setCreateModal(false)} className="text-2xl text-gray-400 hover:text-gray-700 dark:hover:text-white">√ó</button>
                                </div>
                                <div className="p-5 space-y-4">
                                    {/* Lead selector */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lead *</label>
                                        <select value={createForm.lead_id} onChange={e => setCreateForm(f => ({ ...f, lead_id: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                            <option value="">Select a lead...</option>
                                            {leads.map(l => (
                                                <option key={l.id} value={l.id}>
                                                    {[l.first_name, l.last_name].filter(Boolean).join(' ') || l.email} {l.company ? `¬∑ ${l.company}` : ''}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {formInput('Date *', 'date', createForm.date, v => setCreateForm(f => ({ ...f, date: v })))}
                                        {formInput('Time *', 'time', createForm.time, v => setCreateForm(f => ({ ...f, time: v })))}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                                        <select value={createForm.appointment_type} onChange={e => setCreateForm(f => ({ ...f, appointment_type: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                            {TYPE_OPTIONS.map(([v,l]) => <option key={v} value={v}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration</label>
                                            <select value={createForm.duration_minutes} onChange={e => setCreateForm(f => ({ ...f, duration_minutes: +e.target.value }))}
                                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                                {[[15,'15 min'],[30,'30 min'],[45,'45 min'],[60,'1 hour']].map(([v,l]) => <option key={v} value={v}>{l}</option>)}
                                            </select>
                                        </div>
                                        {formInput('Timezone', 'text', createForm.timezone, v => setCreateForm(f => ({ ...f, timezone: v })))}
                                    </div>
                                    {formInput('Meeting Link (optional)', 'url', createForm.meeting_link, v => setCreateForm(f => ({ ...f, meeting_link: v })), { placeholder: 'https://meet.google.com/...' })}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (optional)</label>
                                        <textarea value={createForm.notes} onChange={e => setCreateForm(f => ({ ...f, notes: e.target.value }))} rows="2"
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" />
                                    </div>
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button onClick={() => setCreateModal(false)} className="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200">Cancel</button>
                                        <button onClick={createAppointment} disabled={saving}
                                            className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                                            {saving ? 'Saving...' : 'üìÖ Create Appointment'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ */}
                    {editModal.open && editModal.apt && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center p-5 border-b dark:border-gray-700">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-900 dark:text-white">Edit Appointment</h3>
                                        <p className="text-sm text-gray-500 dark:text-gray-400">
                                            {editModal.apt.lead ? (`${editModal.apt.lead.first_name || ''} ${editModal.apt.lead.last_name || ''}`.trim() || editModal.apt.lead.email) : ''}
                                            {editModal.apt.source === 'ai_detected' && <span className="ml-2 text-xs text-purple-500">ü§ñ AI Detected</span>}
                                        </p>
                                    </div>
                                    <button onClick={() => setEditModal({ open: false, apt: null })} className="text-2xl text-gray-400 hover:text-gray-700 dark:hover:text-white">√ó</button>
                                </div>
                                <div className="p-5 space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        {formInput('Date *', 'date', editForm.date, v => setEditForm(f => ({ ...f, date: v })))}
                                        {formInput('Time *', 'time', editForm.time, v => setEditForm(f => ({ ...f, time: v })))}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                                        <select value={editForm.appointment_type || 'call'} onChange={e => setEditForm(f => ({ ...f, appointment_type: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                            {TYPE_OPTIONS.map(([v,l]) => <option key={v} value={v}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration</label>
                                            <select value={editForm.duration_minutes || 30} onChange={e => setEditForm(f => ({ ...f, duration_minutes: +e.target.value }))}
                                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                                {[[15,'15 min'],[30,'30 min'],[45,'45 min'],[60,'1 hour']].map(([v,l]) => <option key={v} value={v}>{l}</option>)}
                                            </select>
                                        </div>
                                        {formInput('Timezone', 'text', editForm.timezone || '', v => setEditForm(f => ({ ...f, timezone: v })))}
                                    </div>
                                    {formInput('Meeting Link (optional)', 'url', editForm.meeting_link || '', v => setEditForm(f => ({ ...f, meeting_link: v })), { placeholder: 'https://meet.google.com/...' })}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                                        <textarea value={editForm.notes || ''} onChange={e => setEditForm(f => ({ ...f, notes: e.target.value }))} rows="2"
                                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" />
                                    </div>
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button onClick={() => setEditModal({ open: false, apt: null })} className="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200">Cancel</button>
                                        <button onClick={saveEdit} disabled={saving}
                                            className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                                            {saving ? 'Saving...' : 'Save Changes'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ‚îÄ‚îÄ Outcome Modal ‚îÄ‚îÄ */}
                    {outcomeModal.open && outcomeModal.apt && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl">
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="font-bold text-gray-900 dark:text-white">How did it go?</h3>
                                    <button onClick={() => setOutcomeModal({ open: false, apt: null })} className="text-2xl text-gray-400 hover:text-gray-700 dark:hover:text-white">√ó</button>
                                </div>
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    {outcomeModal.apt.lead ? `${outcomeModal.apt.lead.first_name || ''} ${outcomeModal.apt.lead.last_name || ''}`.trim() : ''} ¬∑ {outcomeModal.apt.date} {outcomeModal.apt.time}
                                </p>
                                <div className="grid grid-cols-2 gap-3">
                                    {[['won','üéâ Won Deal'],['needs_more_time','‚è≥ Needs More Time'],['no_show','üëª No Show'],['not_a_fit','‚ùå Not a Fit']].map(([val, label]) => (
                                        <button key={val} onClick={() => markOutcome(outcomeModal.apt.id, val)}
                                            className="py-2 px-3 rounded-lg border border-gray-200 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-left">
                                            {label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script>
        // ‚îÄ‚îÄ Service Worker registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Must run in a plain <script> (not Babel-transpiled JSX) so the SW
        // file scope is at the root of the origin.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js').then(function (reg) {
                    console.log('[SW] Registered, scope:', reg.scope);
                }).catch(function (err) {
                    console.warn('[SW] Registration failed:', err);
                });
            });
        }
    </script>
</body>
</html>
